<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-circle.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="copy,复制," />










<meta name="description" content="最近同事问我一个问题：原数组A，进行复制得到数组B，改变数组B的Person元素对象，不影响数组A的Person元素对象，如何操作？第一感觉是进行深复制，同样数组里面的元素对象也要进行深复制，于是就找到相关的API：
1- (instancetype)initWithArray:(NSArray&amp;lt;ObjectType&amp;gt; *)array copyItems:(BOOL)flag;
然后同">
<meta property="og:type" content="article">
<meta property="og:title" content="浅析iOS的浅复制与深复制">
<meta property="og:url" content="http://yoursite.com/2018/06/11/浅析iOS的浅复制与深复制/index.html">
<meta property="og:site_name" content="DaiSuke">
<meta property="og:description" content="最近同事问我一个问题：原数组A，进行复制得到数组B，改变数组B的Person元素对象，不影响数组A的Person元素对象，如何操作？第一感觉是进行深复制，同样数组里面的元素对象也要进行深复制，于是就找到相关的API：
1- (instancetype)initWithArray:(NSArray&amp;lt;ObjectType&amp;gt; *)array copyItems:(BOOL)flag;
然后同">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy1.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy2.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy3.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy4.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy5.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy6.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy7.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy8.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy9.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy10.png">
<meta property="og:updated_time" content="2018-06-11T15:21:14.443Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅析iOS的浅复制与深复制">
<meta name="twitter:description" content="最近同事问我一个问题：原数组A，进行复制得到数组B，改变数组B的Person元素对象，不影响数组A的Person元素对象，如何操作？第一感觉是进行深复制，同样数组里面的元素对象也要进行深复制，于是就找到相关的API：
1- (instancetype)initWithArray:(NSArray&amp;lt;ObjectType&amp;gt; *)array copyItems:(BOOL)flag;
然后同">
<meta name="twitter:image" content="http://7xv233.com1.z0.glb.clouddn.com/copy1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/06/11/浅析iOS的浅复制与深复制/"/>



<script>
(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
daovoice('init', {
app_id: "cbefc69b"
});
daovoice('update');
</script>






  <title>浅析iOS的浅复制与深复制 | DaiSuke</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c9ee80663574cfe4141f5d6a33812bb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/DaisukeZJY" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">DaiSuke</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Who am I</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            Commonweal 404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/11/浅析iOS的浅复制与深复制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DaiSuke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DaiSuke">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">浅析iOS的浅复制与深复制</h1>
        

        <div class="post-meta">

<i class="fa fa-thumb-tack"></i>
<font color=7CCD7C>置顶</font>
<span class="post-meta-divider">|</span>

          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-11T23:09:02+08:00">
                2018-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/11/浅析iOS的浅复制与深复制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/11/浅析iOS的浅复制与深复制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/06/11/浅析iOS的浅复制与深复制/" class="leancloud_visitors" data-flag-title="浅析iOS的浅复制与深复制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近同事问我一个问题：原数组A，进行复制得到数组B，改变数组B的Person元素对象，不影响数组A的Person元素对象，如何操作？<br>第一感觉是进行深复制，同样数组里面的元素对象也要进行深复制，于是就找到相关的API：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithArray:(<span class="built_in">NSArray</span>&lt;ObjectType&gt; *)array copyItems:(<span class="built_in">BOOL</span>)flag;</span><br></pre></td></tr></table></figure>
<p>然后同事跟我说还有其他方法吗？要不分享一下iOS的复制吧？然后就有了这篇文章。文章如有错误欢迎指出更正，小弟虚心受教，也怕误人子弟。</p>
<a id="more"></a>
<h3 id="为什么要复制？"><a href="#为什么要复制？" class="headerlink" title="为什么要复制？"></a>为什么要复制？</h3><p>定义：在面向对象编程中，对象复制是创建一个现有对象的副本，即面向对象编程中的一个数据单元。生成的对象称为对象副本或者仅仅是原始对象的副本。</p>
<p>意义：为了操作对象副本数据时不影响原对象数据</p>
<h3 id="在iOS中哪些类支持复制功能？"><a href="#在iOS中哪些类支持复制功能？" class="headerlink" title="在iOS中哪些类支持复制功能？"></a>在iOS中哪些类支持复制功能？</h3><p>NSString、NSMutableString、NSArray、NSMutableArray、NSDictionary、NSMutableDictionary…<br>不难发现在API中这些类需要遵循<code>&lt;NSCopying, NSMutableCopying&gt;</code>。至于为什么要遵循这两个协议，协议中需要实现哪些方法后面涉及，这里不做阐释。但是至少可以总结出想要类支持复制功能，就要遵循<code>&lt;NSCopying, NSMutableCopying&gt;</code>以及实现对应方法。</p>
<h3 id="浅复制-or-深复制？"><a href="#浅复制-or-深复制？" class="headerlink" title="浅复制 or 深复制？"></a>浅复制 or 深复制？</h3><p>复制主要分为浅复制和深复制。</p>
<ul>
<li>浅复制：拷贝指向对象的指针，而不是对象本身。</li>
<li>深复制：拷贝对象内容指向另外一块内存。</li>
</ul>
<p>下图是浅复制与深复制的关系（下图来自官方文档）<br><img src="http://7xv233.com1.z0.glb.clouddn.com/copy1.png" alt="image"></p>
<p>举个例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *immutableStr = <span class="string">@"不可变字符串"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *immutableStrCopy = [immutableStr <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSString</span> *immutableStrMutableCopy = [immutableStr mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableStr, immutableStr);                       <span class="comment">// name--0x100001040</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableStrCopy, immutableStrCopy);               <span class="comment">// name--0x100001040</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableStrMutableCopy, immutableStrMutableCopy); <span class="comment">// name--0x10075b320</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableString</span> *mutableStr = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"可变字符串"</span>];</span><br><span class="line"><span class="built_in">NSMutableString</span> *mutableStrCopy = [mutableStr <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSMutableString</span> *mutableStrMutableCopy = [mutableStr mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableStr, mutableStr);                       <span class="comment">// string--0x604000249a50</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableStrCopy, mutableStrCopy);               <span class="comment">// string--0xa00676e697274736</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableStrMutableCopy, mutableStrMutableCopy); <span class="comment">// string--0x604000249720</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *immutableArray = @[<span class="string">@"1"</span>, <span class="string">@"2"</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayCopy = [immutableArray <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayMutableCopy = [immutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArray, immutableArray);                       <span class="comment">// 1,2--0x60000003a200</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayCopy, immutableArrayCopy);               <span class="comment">// 1,2--0x60000003a200</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2--0x600000449de0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayCopy = [mutableArray <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayMutableCopy = [mutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArray, mutableArray);                       <span class="comment">// 1,2--0x60000005c9e0</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayCopy, mutableArrayCopy);               <span class="comment">// 1,2--0x60000003a340</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayMutableCopy, mutableArrayMutableCopy); <span class="comment">// 1,2--0x60000005ca40</span></span><br></pre></td></tr></table></figure>
<p><strong>总结：</strong></p>
<ul>
<li>不可变对象：进行copy得到的是浅复制，进行mutableCopy得到的是深复制。</li>
<li>可变对象：无论进行copy还是mutableCopy都是深复制。</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>copy</th>
<th>mutableCopy</th>
</tr>
</thead>
<tbody>
<tr>
<td>NSString</td>
<td>浅复制</td>
<td>深复制</td>
</tr>
<tr>
<td>NSMutableString</td>
<td>深复制</td>
<td>深复制</td>
</tr>
<tr>
<td>NSArray</td>
<td>浅复制</td>
<td>深复制</td>
</tr>
<tr>
<td>NSMutableArray</td>
<td>深复制</td>
<td>深复制</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<h3 id="声明类型一定是进行复制后的类型吗？"><a href="#声明类型一定是进行复制后的类型吗？" class="headerlink" title="声明类型一定是进行复制后的类型吗？"></a>声明类型一定是进行复制后的类型吗？</h3><p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy2.png" alt="image"></p>
<p>断点调试发现不是，比如：immutableStrMutableCopy声明的是不可变类型NSString，NSString类型是不可以对字符串进行增删操作的，然而NSMutableString类型却可以。因为iOS是动态语言，运行时才断定是什么类型，显然immutableStrMutableCopy实际是NSMutableString，可以对它进行追加字符串，例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="built_in">NSMutableString</span> *)immutableStrMutableCopy appendString:<span class="string">@"追加字符"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableStrMutableCopy, immutableStrMutableCopy); <span class="comment">// string追加字符--0x10075b320</span></span><br></pre></td></tr></table></figure>
<p>相反mutableStrCopy声明的是NSMutableString类型，实际是NSString类型，如果对mutableStrCopy进行增删操作，必然crash。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mutableStrCopy appendString:<span class="string">@"will crash"</span>];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason: ‘-[NSTaggedPointerString appendString:]: unrecognized selector sent to instance 0xa00676e697274736’<br>mutableStrCopy对象没有appendString:这个方法。</p>
</blockquote>
<p>以此类推，同样对于数组来说：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy3.png" alt="image"></p>
<p>显然根据断点信息：<br>immutableArrayMutableCopy是NSMutableArray，可以添加新对象<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="built_in">NSMutableArray</span> *)immutableArrayMutableCopy addObject:<span class="string">@"3"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2,3--0x600000449de0</span></span><br></pre></td></tr></table></figure></p>
<p>mutableArrayCopy是NSArray，添加新的对象会crash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// crash</span></span><br><span class="line">[mutableArrayCopy addObject:<span class="string">@"3"</span>];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason: ‘-[__NSArrayI addObject:]: unrecognized selector sent to instance 0x600000430600’</p>
</blockquote>
<p><strong>总结：</strong></p>
<ul>
<li>不可变对象进行mutableCopy得到的是可变对象.</li>
<li>可变对象进行copy得到的是不可变对象。</li>
</ul>
<h3 id="深复制真的是深复制吗？"><a href="#深复制真的是深复制吗？" class="headerlink" title="深复制真的是深复制吗？"></a>深复制真的是深复制吗？</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *immutableArray = @[<span class="string">@"1"</span>, <span class="string">@"2"</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayCopy = [immutableArray <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayMutableCopy = [immutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArray, immutableArray);                       <span class="comment">// 1,2--0x60000003a200</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayCopy, immutableArrayCopy);               <span class="comment">// 1,2--0x60000003a200</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2--0x600000449de0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArray firstObject], [immutableArray firstObject]);      <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArrayCopy firstObject], [immutableArrayCopy firstObject]);  <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArrayMutableCopy firstObject], [immutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayCopy = [mutableArray <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayMutableCopy = [mutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArray, mutableArray);                       <span class="comment">// 1,2--0x60000005c9e0</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayCopy, mutableArrayCopy);               <span class="comment">// 1,2--0x60000003a340</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayMutableCopy, mutableArrayMutableCopy); <span class="comment">// 1,2--0x60000005ca40</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArray firstObject], [mutableArray firstObject]);                       <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArrayCopy firstObject], [mutableArrayCopy firstObject]);               <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArrayMutableCopy firstObject], [mutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10f1f3078</span></span><br></pre></td></tr></table></figure>
<p>从上面的代码筛选出<code>深复制</code>的例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *immutableArray = @[<span class="string">@"1"</span>, <span class="string">@"2"</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayMutableCopy = [immutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArray, immutableArray);                       <span class="comment">// 1,2--0x60000003a200</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2--0x600000449de0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArray firstObject], [immutableArray firstObject]);      <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArrayMutableCopy firstObject], [immutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayMutableCopy = [mutableArray mutableCopy];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArray, mutableArray);                       <span class="comment">// 1,2--0x60000005c9e0</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayMutableCopy, mutableArrayMutableCopy); <span class="comment">// 1,2--0x60000005ca40</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArray firstObject], [mutableArray firstObject]);                       <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArrayMutableCopy firstObject], [mutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10f1f3078</span></span><br></pre></td></tr></table></figure>
<p>发现深复制只作用于数组对象这层，而数组对象里面存放的元素并没有复制。引用<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html#//apple_ref/doc/uid/TP40010162-SW3" target="_blank" rel="external">官方文档</a>里面的一句话：</p>
<blockquote>
<p>“This kind of copy is only capable of producing a one-level-deep copy. If you only need a one-level-deep copy…<br>If you need a true deep copy, such as when you have an array of arrays…”<br>理解为这只是单层深复制(one-level-deep copy)</p>
</blockquote>
<p>那么现在区分一下概念：</p>
<ul>
<li>浅复制(shallow copy)：在浅复制操作时，对于被复制对象指针复制。</li>
<li>深复制(one-level-deep copy)：在深复制操作时，对于被复制对象，至少有一层是深复制。</li>
<li>完全复制(real-deep copy)：在完全复制操作时，对于被复制对象的每一层都是对象复制。</li>
</ul>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy4.png" alt="image"></p>
<p>根据上图（来自官网）举例例子场景说明：</p>
<ul>
<li>单层深复制：数组A，进行深复制得到数组B，当修改数组B里面的对象时，数组A里面的对象也会跟着变。</li>
<li>完全复制：数组A，进行深复制得到数组B，当修改数组B里面的对象时，数组A里面的对象不会跟着变。</li>
</ul>
<p>那么对于集合怎样才算是完全复制呢？</p>
<h4 id="归档方式"><a href="#归档方式" class="headerlink" title="归档方式"></a>归档方式</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *immutableArray = @[<span class="string">@"1"</span>, <span class="string">@"2"</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayMutableCopy = [immutableArray mutableCopy];</span><br><span class="line"><span class="comment">// 归档深复制</span></span><br><span class="line"><span class="built_in">NSArray</span> *archiverDeepCopyArray = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:[<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:immutableArray]];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArray, immutableArray);                       <span class="comment">// 1,2--0x604000430900</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2--0x604000255300</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, archiverDeepCopyArray, archiverDeepCopyArray); <span class="comment">// 1,2--0x604000430840</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArray firstObject], [immutableArray firstObject]);      <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArrayMutableCopy firstObject], [immutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [archiverDeepCopyArray firstObject], [archiverDeepCopyArray firstObject]); <span class="comment">// 1--0xa000000000000311</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayMutableCopy = [mutableArray mutableCopy];</span><br><span class="line"><span class="comment">// 归档深复制</span></span><br><span class="line"><span class="built_in">NSArray</span> *archiverDeepCopyArray1 = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:[<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:mutableArray]];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArray, mutableArray);                       <span class="comment">// 1,2--0x60000005c9e0</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayMutableCopy, mutableArrayMutableCopy); <span class="comment">// 1,2--0x60000005ca40</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, archiverDeepCopyArray1, archiverDeepCopyArray1); <span class="comment">// 1,2--0x600000253a10</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArray firstObject], [mutableArray firstObject]);                       <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArrayMutableCopy firstObject], [mutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [archiverDeepCopyArray1 firstObject], [archiverDeepCopyArray1 firstObject]); <span class="comment">// 1--0xa000000000000311</span></span><br></pre></td></tr></table></figure>
<p>通过上述例子使用归档方式可以达到完全复制。</p>
<h4 id="自带API初始化方式"><a href="#自带API初始化方式" class="headerlink" title="自带API初始化方式"></a>自带API初始化方式</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *immutableArray = @[<span class="string">@"1"</span>, <span class="string">@"2"</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *immutableArrayMutableCopy = [immutableArray mutableCopy];</span><br><span class="line"><span class="comment">// 深复制</span></span><br><span class="line"><span class="comment">// copyItems参数表示：是否里面的元素也进行复制， NO表示浅复制， YES表示深复制</span></span><br><span class="line"><span class="built_in">NSArray</span> *copyItemsDeepCopyArray = [[<span class="built_in">NSArray</span> alloc] initWithArray:immutableArray copyItems:<span class="literal">YES</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *copyItemsDeepCopyArray2 = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:immutableArray copyItems:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArray, immutableArray);                       <span class="comment">// 1,2--0x604000430900</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, immutableArrayMutableCopy, immutableArrayMutableCopy); <span class="comment">// 1,2--0x604000255300</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, copyItemsDeepCopyArray, copyItemsDeepCopyArray); <span class="comment">// 1,2--0x604000430840</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArray firstObject], [immutableArray firstObject]);      <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [immutableArrayMutableCopy firstObject], [immutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10d448078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [copyItemsDeepCopyArray firstObject], [copyItemsDeepCopyArray firstObject]); <span class="comment">// 1--0xa000000000000311</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mutableArrayMutableCopy = [mutableArray mutableCopy];</span><br><span class="line"><span class="comment">// 深复制</span></span><br><span class="line"><span class="built_in">NSArray</span> *copyItemsDeepCopyArray1 = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:mutableArray copyItems:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArray, mutableArray);                       <span class="comment">// 1,2--0x60000005c9e0</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, mutableArrayMutableCopy, mutableArrayMutableCopy); <span class="comment">// 1,2--0x60000005ca40</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, copyItemsDeepCopyArray1, copyItemsDeepCopyArray1); <span class="comment">// 1,2--0x60000025c890</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArray firstObject], [mutableArray firstObject]);                       <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [mutableArrayMutableCopy firstObject], [mutableArrayMutableCopy firstObject]); <span class="comment">// 1--0x10f1f3078</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, [copyItemsDeepCopyArray1 firstObject], [copyItemsDeepCopyArray1 firstObject]); <span class="comment">// 1--0xa000000000000311</span></span><br></pre></td></tr></table></figure>
<p>使用上述两种方式均可达到完全复制的效果。</p>
<p><strong>有四个注意点：</strong></p>
<ol>
<li>使用归档方式：归档的对象必须遵循NSCoding协议并实现协议方法。</li>
<li>使用归档方式：使用NSKeyedArchiver归档的对象是什么类型，那么NSKeyedUnarchiver解档出来的对象就是什么类型<br>比如归档的是NSArray类型，解档得到的类型也是NSArray：<br>NSArray *archiverDeepCopyArray = [NSKeyedUnarchiver unarchiveObjectWithData:[NSKeyedArchiver archivedDataWithRootObject:immutableArray]];</li>
<li>使用实例化方法：如果copyItems为YES，那么数组的元素对象必须遵循NSCopying协议并实现协议方法，否则crash</li>
<li>使用实例化方法：使用什么类型进行初始化的，得到的就是什么类型的对象。<br>比如使用NSMutableArray进行初始化，那么copyItemsDeepCopyArray1就是NSMutableArray类型，而不是NSArray类型：<br>NSArray *copyItemsDeepCopyArray1 = [[NSMutableArray alloc] initWithArray:mutableArray copyItems:YES];</li>
</ol>
<h3 id="如何让对象支持复制操作？"><a href="#如何让对象支持复制操作？" class="headerlink" title="如何让对象支持复制操作？"></a>如何让对象支持复制操作？</h3><p>上面提及到只要遵循<code>&lt;NSCopying, NSMutableCopying&gt;</code>以及实现协议方法就可以实现复制操作，那先看看这两个协议有什么协议方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSCopying</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(nullable <span class="built_in">NSZone</span> *)zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSMutableCopying</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)mutableCopyWithZone:(nullable <span class="built_in">NSZone</span> *)zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>自定义Person类实现浅复制&amp;深复制</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Person.m</span></span><br><span class="line"><span class="comment">// 深复制</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Person *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    p.name = <span class="keyword">self</span>.name;</span><br><span class="line">    p.age = <span class="keyword">self</span>.age;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浅复制（伪复制）</span></span><br><span class="line"><span class="comment">//- (id)copyWithZone:(NSZone *)zone&#123;</span></span><br><span class="line"><span class="comment">//    // 返回对象本身</span></span><br><span class="line"><span class="comment">//    return self;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 深复制</span></span><br><span class="line">- (<span class="keyword">id</span>)mutableCopyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Person *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为每个属性创建新的空间，并将内容复制</span></span><br><span class="line">    p.name = <span class="keyword">self</span>.name;</span><br><span class="line">    p.age = <span class="keyword">self</span>.age;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">person.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">person.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">Person *personCopy = [person <span class="keyword">copy</span>];</span><br><span class="line">Person *personMutableCopy = [person mutableCopy];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, person, person.name);                       <span class="comment">// &lt;Person: 0x6040000275e0&gt;--0x100349088</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, personCopy, personCopy.name);               <span class="comment">// &lt;Person: 0x604000222340&gt;--0x100349088</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, personMutableCopy, personMutableCopy.name); <span class="comment">// &lt;Person: 0x604000222b80&gt;--0x100349088</span></span><br></pre></td></tr></table></figure>
<p>从打印结果的出都实现了深复制操作。但是一般来说自定义对象不需要实现NSMutableCopying协议，因为对象不像容器，本身没有相关存储扩展等功能。</p>
<p>看到这里可能细心的人发现都是深复制，为什么person对象里面的name属性地址没有深复制？</p>
<p>由于NSString特殊性，系统会判断字符串属性在同一内容前提下，使用@“”或者initWith..方法创建的对象作为常量，放在常量区则不会开辟新的内存空间。</p>
<p>验证：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *text = <span class="string">@"123"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%p---"</span>, text); <span class="comment">// 0x10f36b0c8</span></span><br><span class="line"><span class="built_in">NSString</span> *text1 = <span class="string">@"123"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%p---"</span>, text1); <span class="comment">// 0x10f36b0c8</span></span><br><span class="line"><span class="built_in">NSString</span> *text2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"123"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%p---"</span>, text2); <span class="comment">// 0x10f36b0c8</span></span><br></pre></td></tr></table></figure>
<p>发现不同变量，因为内容一致，指向的地址是一样的。所以除了改变值，难道就没有开辟新内存空间的方法了吗？有</p>
<p>NSString <em>text3 = [NSString stringWithFormat:@”123”];<br>NSLog(@”%p—“, text3); // 0xa000000003332313<br>NSString </em>text4 = [[NSString alloc] initWithFormat:@”123”];<br>NSLog(@”%p—“, text4); // 0xa000000003332313</p>
<p>会发现同样的内容，但是地址是不一样的，而且长度也不一样。</p>
<p><strong>总结：</strong></p>
<ul>
<li>@“”或者initWith..方法的变量存放在常量区，由系统管理内存</li>
<li>Format:方式创建的变量存放在堆区</li>
</ul>
<p>所以想要实现完全的复制可以这样做：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.m</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Person *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    p.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>, <span class="keyword">self</span>.name];</span><br><span class="line">    p.age = <span class="keyword">self</span>.age;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现完全复制无非就是怕修改副本对象的属性，从而影响到原对象的属性。对于字符串来说，其实你可以不需要这样做。因为副本对象修改字符串属性不会影响原对象的字符串属性。</p>
<p>验证：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">person.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">person.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">Person *personCopy = [person <span class="keyword">copy</span>];</span><br><span class="line">Person *personMutableCopy = [person mutableCopy];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, person, person.name);                       <span class="comment">// &lt;Person: 0x6040000275e0&gt;--0x100349088</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, personCopy, personCopy.name);               <span class="comment">// &lt;Person: 0x604000222340&gt;--0x100349088</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, personMutableCopy, personMutableCopy.name); <span class="comment">// &lt;Person: 0x604000222b80&gt;--0x100349088</span></span><br><span class="line"></span><br><span class="line">personCopy.name = <span class="string">@"修改name的值"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@-%@-%p"</span>, person, person.name, person.name);               <span class="comment">// &lt;Person: 0x60000003f140&gt;-daisuke-0x103f1e088</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@-%@-%p"</span>, personCopy, personCopy.name, personCopy.name);   <span class="comment">// &lt;Person: 0x6000002302a0&gt;-修改name的值-0x103f1e0c8</span></span><br></pre></td></tr></table></figure>
<p>上面的代码中看到尽管两个对象name的地址是一样的，但是修改对象personCopy的属性name的值，并没有影响到对象person的name值。</p>
<h3 id="对象中有对象属性时如何支持复制操作？"><a href="#对象中有对象属性时如何支持复制操作？" class="headerlink" title="对象中有对象属性时如何支持复制操作？"></a>对象中有对象属性时如何支持复制操作？</h3><p>新建一个Contact类作为person的一个属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="comment">/// 联系方式</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Contact *contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在copyWithZone:方法中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.m</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Person *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    p.name = <span class="keyword">self</span>.name;</span><br><span class="line">    p.age = <span class="keyword">self</span>.age;</span><br><span class="line">    p.contact = <span class="keyword">self</span>.contact;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">person.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">person.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">Contact *contact = [[Contact alloc] init];</span><br><span class="line">contact.phone = <span class="string">@"12345678900"</span>;</span><br><span class="line">contact.email = <span class="string">@"feng@gmail.com"</span>;</span><br><span class="line">person.contact = contact;</span><br><span class="line"></span><br><span class="line">Person *personCopy = [person <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, person, person.name, person.contact.phone, person.contact);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, personCopy, personCopy.name,personCopy.contact.phone, personCopy.contact);</span><br><span class="line"><span class="comment">// &lt;Person: 0x600000024a00&gt;--0x10</span></span><br><span class="line">b2a8088-<span class="number">-12345678900</span>-<span class="number">-0x60000022fdc0</span></span><br><span class="line"><span class="comment">// &lt;Person: 0x600000230300&gt;--0x10b2a8088--12345678900--0x60000022fdc0</span></span><br><span class="line"></span><br><span class="line">personCopy.contact.phone = <span class="string">@"999999999"</span>;</span><br><span class="line">personCopy.name = <span class="string">@"这是新的名称"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, person, person.name, person.contact.phone, person.contact);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, personCopy, personCopy.name,personCopy.contact.phone, personCopy.contact);</span><br><span class="line"><span class="comment">// &lt;Person: 0x600000024a00&gt;--0x10b2a8088--999999999--0x60000022fdc0</span></span><br><span class="line"><span class="comment">// &lt;Person: 0x600000230300&gt;--0x10b2a8128--999999999--0x60000022fdc0</span></span><br></pre></td></tr></table></figure></p>
<p>从打印信息看到person是进行了深复制，但是对象contact指向的是同一个指针，显然并没有进行深复制(单层深复制)，也可以从copyWithZone:方法中看到p.contact = self.contact;只是简单的指针赋值。如果改变副本personCopy的contact对象属性，原对象的contact也会跟着改变，这不是我们想要的结果。那应该怎么办呢？方法是让属性对象也实现深复制功能</p>
<p>例如Contact也实现深复制：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Contact.m</span></span><br><span class="line">-(<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    Contact *contact = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    contact.phone = <span class="keyword">self</span>.phone;</span><br><span class="line">    contact.email = <span class="keyword">self</span>.email;</span><br><span class="line">    <span class="keyword">return</span> contact;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Contact类继承NSCopying协议实现了深复制功能，然后在Person类的深复制方法中修改为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.m</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Person *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    p.name = <span class="keyword">self</span>.name;</span><br><span class="line">    p.age = <span class="keyword">self</span>.age;</span><br><span class="line">    <span class="comment">//    p.contact = self.contact;</span></span><br><span class="line">    <span class="comment">// 深复制</span></span><br><span class="line">    p.contact = [<span class="keyword">self</span>.contact <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就能让对象属性实现深复制效果,验证：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">person.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">person.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">Contact *contact = [[Contact alloc] init];</span><br><span class="line">contact.phone = <span class="string">@"12345678900"</span>;</span><br><span class="line">contact.email = <span class="string">@"feng@gmail.com"</span>;</span><br><span class="line">person.contact = contact;</span><br><span class="line"></span><br><span class="line">Person *personCopy = [person <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, person, person.name, person.contact.phone, person.contact);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, personCopy, personCopy.name,personCopy.contact.phone, personCopy.contact);</span><br><span class="line"><span class="comment">// &lt;Person: 0x60400042f820&gt;--0x102d04088--12345678900--0x60400042f7c0</span></span><br><span class="line"><span class="comment">// &lt;Person: 0x60400042f860&gt;--0x102d04088--12345678900--0x60400042f8a0</span></span><br><span class="line"></span><br><span class="line">personCopy.contact.phone = <span class="string">@"999999999"</span>;</span><br><span class="line">personCopy.name = <span class="string">@"这是新的名称"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, person, person.name, person.contact.phone, person.contact);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, personCopy, personCopy.name,personCopy.contact.phone, personCopy.contact);</span><br><span class="line"><span class="comment">// &lt;Person: 0x60400042f820&gt;--0x102d04088--12345678900--0x60400042f7c0</span></span><br><span class="line"><span class="comment">// &lt;Person: 0x60400042f860&gt;--0x102d04128--999999999--0x60400042f8a0</span></span><br></pre></td></tr></table></figure>
<p>从打印信息可以看到，person与personCopy指针不一样，person的contact对象属性与personCopy的contact对象属性指针不一样。<br>而且当修改personCopy的contact对象属性中的phone值时，原对象person的contact对象属性中的phone值没有跟着改变，所以是实现了完全复制。</p>
<h3 id="如何让子类对象支持复制操作？"><a href="#如何让子类对象支持复制操作？" class="headerlink" title="如何让子类对象支持复制操作？"></a>如何让子类对象支持复制操作？</h3><p>为了不影响Person类，新建一个Father类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Father.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Father</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="comment">/// 联系方式</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Contact *contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Father.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Father</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">//创建新的对象空间</span></span><br><span class="line">    Father *f = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    f.name = <span class="keyword">self</span>.name;</span><br><span class="line">    f.age = <span class="keyword">self</span>.age;</span><br><span class="line">    <span class="comment">// 深复制</span></span><br><span class="line">    f.contact = [<span class="keyword">self</span>.contact <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>Father类稍微做了调整，把继承NSCopying协议放在.h文件中,再新建一个Son类继承Father类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Son.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Son</span> : <span class="title">Father</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">double</span> height;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">double</span> weight;</span><br><span class="line"><span class="comment">/// 成绩</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Score *score;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>因为是继承关系，子类也遵循了NSCopying协议，但是并没有重写copyWithZone:方法，如果进行复制操作会是怎样的结果呢？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Son *son = [[Son alloc] init];</span><br><span class="line">    son.height = <span class="number">173.0</span>;</span><br><span class="line">    son.weight = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    Score *score = [[Score alloc] init];</span><br><span class="line">    score.math = <span class="number">100.0</span>;</span><br><span class="line">    score.chinese = <span class="number">99.0</span>;</span><br><span class="line">    score.english = <span class="number">88</span>;</span><br><span class="line">    son.score = score;</span><br><span class="line"></span><br><span class="line">    Son *sonCopy = [son <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@"</span>, son, son.score);                       <span class="comment">// &lt;Son: 0x604000266c00&gt;--&lt;Score: 0x60400003e5a0&gt;</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@"</span>, sonCopy, sonCopy.score);               <span class="comment">// &lt;Son: 0x604000266d80&gt;--(null)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印信息显示，son对象进行了深复制，但是sonCopy的score对象是空的。为什么呢？因为进行[son copy]操作时，子类没有重写copyWithZone:方法，会去父类那里找，也可以从断点中看到：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy5.png" alt="image"></p>
<p>父类中self指向的是Son类，那么[[self class] allocWithZone:zone]表示给son创建一个新的空间，也就是之前打印信息显示结果一样完成了深复制操作，但是f对象中没有给score对象属性赋值，所以是null的。</p>
<p>想要score有值，必然要重写copyWithZone:方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Son.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Son</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    Son *s = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    s.height = <span class="keyword">self</span>.height;</span><br><span class="line">    s.weight = <span class="keyword">self</span>.height;</span><br><span class="line">    s.score = [<span class="keyword">self</span>.score <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>而且Score也要实现深复制操作：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Score.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Score</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    Score *s = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    s.math = <span class="keyword">self</span>.math;</span><br><span class="line">    s.chinese = <span class="keyword">self</span>.chinese;</span><br><span class="line">    s.english = <span class="keyword">self</span>.english;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>接下来验证一下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Son *son = [[Son alloc] init];</span><br><span class="line">    son.height = <span class="number">173.0</span>;</span><br><span class="line">    son.weight = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    Score *score = [[Score alloc] init];</span><br><span class="line">    score.math = <span class="number">100.0</span>;</span><br><span class="line">    score.chinese = <span class="number">99.0</span>;</span><br><span class="line">    score.english = <span class="number">88</span>;</span><br><span class="line">    son.score = score;</span><br><span class="line"></span><br><span class="line">    Son *sonCopy = [son <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@"</span>, son, son.score);                       <span class="comment">// &lt;Son: 0x6040002760c0&gt;--&lt;Score: 0x604000429e20&gt;</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@"</span>, sonCopy, sonCopy.score);      <span class="comment">// &lt;Son: 0x604000276180&gt;--&lt;Score: 0x604000429e00&gt;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过打印信息看到实现深复制功能。</p>
<p>但是可能有一个疑问？Son是继承Father类的，要是Father类的属性也有值呢？<br>首先不修改复制方法的代码，简单的给Father类的属性赋值测试一下先：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Son *son = [[Son alloc] init];</span><br><span class="line">    son.height = <span class="number">173.0</span>;</span><br><span class="line">    son.weight = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    Score *score = [[Score alloc] init];</span><br><span class="line">    score.math = <span class="number">100.0</span>;</span><br><span class="line">    score.chinese = <span class="number">99.0</span>;</span><br><span class="line">    score.english = <span class="number">88</span>;</span><br><span class="line">    son.score = score;</span><br><span class="line"></span><br><span class="line">    Contact *contact = [[Contact alloc] init];</span><br><span class="line">    contact.phone = <span class="string">@"123456789"</span>;</span><br><span class="line">    contact.email = <span class="string">@"feng@gmail"</span>;</span><br><span class="line">    son.contact = contact;</span><br><span class="line">    son.name = <span class="string">@"daisuke"</span>;</span><br><span class="line"></span><br><span class="line">    Son *sonCopy = [son <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, son, son.score, son.name, son.contact);                       </span><br><span class="line">    <span class="comment">// &lt;Son: 0x604000273240&gt;--&lt;Score: 0x6040000335e0&gt;--daisuke--&lt;Contact: 0x604000033600&gt;</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, sonCopy, sonCopy.score, sonCopy.name, sonCopy.contact);               </span><br><span class="line">    <span class="comment">// &lt;Son: 0x604000273580&gt;--&lt;Score: 0x604000236c00&gt;--(null)--(null)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从打印信息看到sonCopy.name和sonCopy.contact两个值都是null的，为什么呢？<br>因为Son类重写了copyWithZone:方法，自己完成了深复制操作，并没有考虑到父类也需要深复制。自然而然没有运行父类的copyWithZone:方法，所以就出现了sonCopy对象的父类属性值时null的。<br>修改如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Son.m</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="comment">// 使用super</span></span><br><span class="line">    Son *s = [<span class="keyword">super</span> copyWithZone:zone];</span><br><span class="line">    s.height = <span class="keyword">self</span>.height;</span><br><span class="line">    s.weight = <span class="keyword">self</span>.height;</span><br><span class="line">    s.score = [<span class="keyword">self</span>.score <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Son *son = [[Son alloc] init];</span><br><span class="line">    son.height = <span class="number">173.0</span>;</span><br><span class="line">    son.weight = <span class="number">120</span>;</span><br><span class="line"></span><br><span class="line">    Score *score = [[Score alloc] init];</span><br><span class="line">    score.math = <span class="number">100.0</span>;</span><br><span class="line">    score.chinese = <span class="number">99.0</span>;</span><br><span class="line">    score.english = <span class="number">88</span>;</span><br><span class="line">    son.score = score;</span><br><span class="line"></span><br><span class="line">    Contact *contact = [[Contact alloc] init];</span><br><span class="line">    contact.phone = <span class="string">@"123456789"</span>;</span><br><span class="line">    contact.email = <span class="string">@"feng@gmail"</span>;</span><br><span class="line">    son.contact = contact;</span><br><span class="line">    son.name = <span class="string">@"daisuke"</span>;</span><br><span class="line"></span><br><span class="line">    Son *sonCopy = [son <span class="keyword">copy</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, son, son.score, son.name, son.contact);                      </span><br><span class="line">    <span class="comment">// &lt;Son: 0x604000273240&gt;--&lt;Score: 0x6040000335e0&gt;--daisuke--&lt;Contact: 0x604000033600&gt;</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, sonCopy, sonCopy.score, sonCopy.name, sonCopy.contact);               </span><br><span class="line">    <span class="comment">// &lt;Son: 0x600000460700&gt;--&lt;Score: 0x6000000301c0&gt;--daisuke--&lt;Contact: 0x6000000301a0&gt;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样sonCopy.name和 sonCopy.contact两个属性都有值了，也完成了深复制，从断点也可以看到运行了父类的copyWithZone:方法，并且把父类的相关属性进行了深复制，如下图显示：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy6.png" alt="image"></p>
<h3 id="互相引用进行深拷贝结果如何？"><a href="#互相引用进行深拷贝结果如何？" class="headerlink" title="互相引用进行深拷贝结果如何？"></a>互相引用进行深拷贝结果如何？</h3><p>在很多多情况下，对象都是互相引用的，当然一个是strong一个是weak，否则造成循环引用，引起内存泄漏。比如：信用卡必须有一个人的属性，而人未必有信用卡的属性。那么对信用卡进行深复制，结果是如何呢？<br>第一反应想到的是首先创建一个People类并拥有一个（weak引用）card属性，一个Card类并拥有一个（strong引用）people属性。然后遵循NSCopying协议，实现copyWithZone:方法。<br>结果发现在People类中的copyWithZone:方法中不能对card进行copy操作，因为进行copy的时候新对象的引用计数器会+1，这样跟weak引用造成冲突：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// People.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">People</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">People *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    <span class="comment">// 警告：Assigning retained object to weak property; object will be released after assignment</span></span><br><span class="line">    p.card = [<span class="keyword">self</span>.card <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>警告信息：Assigning retained object to weak property; object will be released after assignment</p>
</blockquote>
<p>因为card属性是weak类型，不能对它进行copy操作。否则造成死循环而崩溃，如下图显示：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy7.png" alt="image"></p>
<p>那么不能进行copy操作，直接赋值会怎样呢？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Card.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">People</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Card</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *number;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) People *people;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Card.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Card</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    Card *card = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    card.people = [<span class="keyword">self</span>.people <span class="keyword">copy</span>];</span><br><span class="line">    card.number = <span class="keyword">self</span>.number;</span><br><span class="line">    <span class="keyword">return</span> card;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// People.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Card</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">People</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) Card *card;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// People.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">People</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    People *p = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    p.card = <span class="keyword">self</span>.card;</span><br><span class="line">    p.name = <span class="keyword">self</span>.name;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Card *card = [[Card alloc] init];</span><br><span class="line">    card.number = <span class="string">@"9999999"</span>;</span><br><span class="line"></span><br><span class="line">    People *people = [[People alloc] init];</span><br><span class="line">    people.name = <span class="string">@"daisuke"</span>;</span><br><span class="line"></span><br><span class="line">    card.people = people;</span><br><span class="line">    people.card = card;</span><br><span class="line"></span><br><span class="line">    Card *cardCopy = [card <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@"</span>, card, card.people, card.people.card);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@"</span>, cardCopy, cardCopy.people, cardCopy.people.card);</span><br><span class="line">    <span class="comment">// &lt;Card: 0x60000042b700&gt;--&lt;People: 0x6000004297e0&gt;--&lt;Card: 0x60000042b700&gt;</span></span><br><span class="line">    <span class="comment">// &lt;Card: 0x60000042b640&gt;--&lt;People: 0x60000042bac0&gt;--&lt;Card: 0x60000042b700&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从打印信息看出card.people.card、cardCopy.people.card两个的地址是一样的：0x60000042b700，而0x60000042b700指向的是card的地址，通过一张图展示他们的关系：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy8.png" alt="image"></p>
<p>显然这个不是我们想要的结果，想要的结果如下图显示：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy9.png" alt="image"></p>
<p>因为对对象进行深复制，里面的对象属性也要深复制，但是因为对象属性是weak引用，不允许copy操作，否则造死成循环而崩溃，怎么办呢？<br>由于能力有限，只能做一下简单处理，如果哪位有好的建议请联系我，谢谢。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Card.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Card</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    Card *card = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line">    card.people = [<span class="keyword">self</span>.people <span class="keyword">copy</span>];</span><br><span class="line">    <span class="comment">// 重新指向新创建的card</span></span><br><span class="line">    card.people.card = card;</span><br><span class="line">    card.number = <span class="keyword">self</span>.number;</span><br><span class="line">    <span class="keyword">return</span> card;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>把people的card属性重新指向新创建的card，进行测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Card *card = [[Card alloc] init];</span><br><span class="line">    card.number = <span class="string">@"9999999"</span>;</span><br><span class="line"></span><br><span class="line">    People *people = [[People alloc] init];</span><br><span class="line">    people.name = <span class="string">@"daisuke"</span>;</span><br><span class="line"></span><br><span class="line">    card.people = people;</span><br><span class="line">    people.card = card;</span><br><span class="line"></span><br><span class="line">    Card *cardCopy = [card <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@"</span>, card, card.people, card.people.card);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@"</span>, cardCopy, cardCopy.people, cardCopy.people.card);</span><br><span class="line">    <span class="comment">// &lt;Card: 0x60400003a9e0&gt;--&lt;People: 0x60400042d120&gt;--&lt;Card: 0x60400003a9e0&gt;</span></span><br><span class="line">    <span class="comment">// &lt;Card: 0x60400042c220&gt;--&lt;People: 0x60400042b560&gt;--&lt;Card: 0x60400042c220&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然这样就能简单实现想要的结果。</p>
<h3 id="基类runtime方式让所有子类自动实现深复制操作（有不足之处）"><a href="#基类runtime方式让所有子类自动实现深复制操作（有不足之处）" class="headerlink" title="基类runtime方式让所有子类自动实现深复制操作（有不足之处）"></a>基类runtime方式让所有子类自动实现深复制操作（有不足之处）</h3><p>创建基类BaseModel，有两种方式实现深复制：</p>
<h4 id="基类BaseModel遵循NSCopying协议"><a href="#基类BaseModel遵循NSCopying协议" class="headerlink" title="基类BaseModel遵循NSCopying协议"></a>基类BaseModel遵循NSCopying协议</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseModel.m</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line">    <span class="keyword">id</span> object = [[<span class="keyword">self</span> class] allocWithZone:zone];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> class], &amp;propertyCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(properties[i]);</span><br><span class="line">        <span class="built_in">NSString</span> *propertyName = [<span class="built_in">NSString</span> stringWithCString:name encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSObject</span>&lt;<span class="built_in">NSCopying</span>&gt; *tempValue = [<span class="keyword">self</span> valueForKey:propertyName];</span><br><span class="line">        <span class="keyword">if</span> (tempValue) &#123;</span><br><span class="line">            <span class="comment">// 此处如果是对象属性，且形成闭环关系，会造成死循环导致崩溃。</span></span><br><span class="line">            <span class="keyword">id</span> value = [tempValue <span class="keyword">copy</span>];</span><br><span class="line">            [object setValue:value forKey:propertyName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用runtime方式遍历递归对象的属性而进行深复制，这里有一个弊端，该方式不适合有闭环方式的对象使用，否则造成死循环。上面讲的互相引用的例子就是这个的证明，关系如下图显示：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/copy10.png" alt="image"></p>
<p>所以使用BaseModel类方式的话，必须确保对象与对象之间没有形成闭环关闭。那么就测试一下没有闭环关系例子：</p>
<p>新建FatherModel类、ContactModel类分别继承于BaseModel类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FatherModel.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FatherModel</span> : <span class="title">BaseModel</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="comment">/// 联系方式</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) ContactModel *contact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FatherModel.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FatherModel</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ContactModel.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ContactModel</span> : <span class="title">BaseModel</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *phone;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *email;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ContactModel.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ContactModel</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    FatherModel *father = [[FatherModel alloc] init];</span><br><span class="line">    father.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">    father.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">    ContactModel *contact = [[ContactModel alloc] init];</span><br><span class="line">    contact.phone = <span class="string">@"123456789"</span>;</span><br><span class="line">    contact.email = <span class="string">@"feng@gmail"</span>;</span><br><span class="line">    father.contact = contact;</span><br><span class="line"></span><br><span class="line">    FatherModel *fatherCopy = [father <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, father, father.name, father.contact.phone, father.contact);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, fatherCopy, fatherCopy.name,fatherCopy.contact.phone, fatherCopy.contact);</span><br><span class="line">    <span class="comment">// &lt;FatherModel: 0x604000035b80&gt;--daisuke--123456789--&lt;ContactModel: 0x604000035ba0&gt;</span></span><br><span class="line">    <span class="comment">// &lt;FatherModel: 0x604000231960&gt;--daisuke--123456789--&lt;ContactModel: 0x6040002312e0&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从打印信息中看到实现了深复制功能。</p>
<blockquote>
<p>注意点：对象属性如果没有遵循NSCopying协议，只是简单赋值，不会进行深复制操作。</p>
</blockquote>
<h4 id="基类BaseModel遵循NSCoding协议"><a href="#基类BaseModel遵循NSCoding协议" class="headerlink" title="基类BaseModel遵循NSCoding协议"></a>基类BaseModel遵循NSCoding协议</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseModel.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">BaseModel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> class], &amp;propertyCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(properties[i]);</span><br><span class="line">        <span class="built_in">NSString</span> *propertyName = [<span class="built_in">NSString</span> stringWithCString:name encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSObject</span> *tempValue = [<span class="keyword">self</span> valueForKey:propertyName];</span><br><span class="line">        <span class="keyword">if</span> (tempValue &amp;&amp; [tempValue conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">NSCopying</span>)]) </span>&#123;</span><br><span class="line">            [aCoder encodeObject:tempValue forKey:propertyName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> class], &amp;propertyCount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(properties[i]);</span><br><span class="line">            <span class="built_in">NSString</span> *propertyName = [<span class="built_in">NSString</span> stringWithCString:name encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSObject</span> *tempValue = [aDecoder decodeObjectForKey:propertyName];</span><br><span class="line">            <span class="keyword">if</span> (tempValue) &#123;</span><br><span class="line">                [<span class="keyword">self</span> setValue:tempValue forKey:propertyName];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>测试新建CompanyModel类没有继承BaseModel，也没有遵循NSCoding协议。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FatherModel *father = [[FatherModel alloc] init];</span><br><span class="line">father.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">father.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">CompanyModel *company = [[CompanyModel alloc] init];</span><br><span class="line">company.companyName = <span class="string">@"小公司"</span>;</span><br><span class="line">father.company = company;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:father];</span><br><span class="line">FatherModel *fatherCopy = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:data];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, father, father.name, father.company, father.company.companyName);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, fatherCopy, fatherCopy.name,fatherCopy.company, fatherCopy.company.companyName);</span><br><span class="line"><span class="comment">// &lt;FatherModel: 0x60400024fbd0&gt;--daisuke--&lt;CompanyModel: 0x6040000086b0&gt;--小公司</span></span><br><span class="line"><span class="comment">// &lt;FatherModel: 0x60400024fba0&gt;--daisuke--(null)--(null)</span></span><br></pre></td></tr></table></figure>
<p>从打印信息看到fatherCopy的company是空的。那么让CompanyModel类继承BaseModel，然后直接运行：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FatherModel *father = [[FatherModel alloc] init];</span><br><span class="line">father.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">father.age = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line">CompanyModel *company = [[CompanyModel alloc] init];</span><br><span class="line">company.companyName = <span class="string">@"小公司"</span>;</span><br><span class="line">father.company = company;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:father];</span><br><span class="line">FatherModel *fatherCopy = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:data];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, father, father.name, father.company, father.company.companyName);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>, fatherCopy, fatherCopy.name,fatherCopy.company, fatherCopy.company.companyName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;FatherModel: 0x60400025a550&gt;--daisuke--&lt;CompanyModel: 0x604000012240&gt;--小公司</span></span><br><span class="line"><span class="comment">// &lt;FatherModel: 0x600000257d30&gt;--daisuke--&lt;CompanyModel: 0x6000000076f0&gt;--小公司</span></span><br></pre></td></tr></table></figure>
<p>发现属性有值了且完成了深复制操作。</p>
<h3 id="声明属性是使用copy、strong的区别？"><a href="#声明属性是使用copy、strong的区别？" class="headerlink" title="声明属性是使用copy、strong的区别？"></a>声明属性是使用copy、strong的区别？</h3><p>新建一个CopyOrStrongModel类。</p>
<h4 id="copy声明"><a href="#copy声明" class="headerlink" title="copy声明"></a>copy声明</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用copy声明name属性：</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CopyOrStrongModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line">    model.name = @&quot;daisuke&quot;;</span><br><span class="line">    NSLog(@&quot;model.name是否是NSMutableString类型：%@&quot;, @([model.name isKindOfClass:[NSMutableString class]]));</span><br><span class="line">    // model.name是否是NSMutableString类型：0</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把值改为是可变类型的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *stringM = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"daisuke"</span>];</span><br><span class="line">    model.name = stringM;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke--0x6040002556c0</span></span><br><span class="line">    [stringM appendString:<span class="string">@"追加"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke追加--0x6040002556</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"model.name是否是NSMutableString类型：%@"</span>, @([model.name isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// model.name是否是NSMutableString类型：0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现虽然stringM是可变字符串，但是进行model.name = stringM;实际是对可变字符串进行了[可变字符串 copy]操作，从而得到的是NSString类型。</p>
<h4 id="strong声明"><a href="#strong声明" class="headerlink" title="strong声明"></a>strong声明</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *name;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line">    model.name = <span class="string">@"daisuke"</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p"</span>, model.name, model.name);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用这种方式跟copy一样，但是使用可变字符串赋值又会如何呢？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *stringM = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"daisuke"</span>];</span><br><span class="line">    model.name = stringM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// strong</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke--0x6040002556c0</span></span><br><span class="line">    [stringM appendString:<span class="string">@"追加"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke追加--0x60000025d460--daisuke追加--0x60000025d46</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"model.name是否是NSMutableString类型：%@"</span>, @([model.name isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// model.name是否是NSMutableString类型：1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从打印信息的到如果是strong类型声明的话，可变字符串赋值的后 model.name实际类型变成了NSMutableString类型。这不是我们想要的结果，显然对于model来说name属性的类型不想因为外界的赋值而改变，也不想因为外界的值改变了，model.name的值也跟着改变。</p>
<p><strong>总结：</strong></p>
<ul>
<li>使用NSString赋值，使用copy或strong声明都可以</li>
<li>使用NSMutableString赋值，copy声明不会改变原类型（[可变字符串 copy]得到的是NSString类型），也不会跟随外界赋的值而改变。使用strong声明就会。</li>
</ul>
<h4 id="重写Setter方法"><a href="#重写Setter方法" class="headerlink" title="重写Setter方法"></a>重写Setter方法</h4><p>当然有一种周全的方法，即便你是copy还是strong声明，赋值的是NSString还是NSMutableString类型，都不想外界修改的话。你可以重写setName:方法，例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, name);</span><br><span class="line">    _name = [name <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, _name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<ul>
<li>使用copy方式：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *stringM = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"daisuke"</span>];</span><br><span class="line">    model.name = stringM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke--0x6040000564d0</span></span><br><span class="line">    [stringM appendString:<span class="string">@"追加"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke追加--0x6040000564d0</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"model.name是否是NSMutableString类型：%@"</span>, @([model.name isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// model.name是否是NSMutableString类型：0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>strong方式：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *stringM = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"daisuke"</span>];</span><br><span class="line">    model.name = stringM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// strong</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke--0x604000445880</span></span><br><span class="line">    [stringM appendString:<span class="string">@"追加"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%p--%@--%p"</span>, model.name, model.name, stringM, stringM);</span><br><span class="line">    <span class="comment">// daisuke--0xa656b75736961647--daisuke追加--0x604000445880</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"model.name是否是NSMutableString类型：%@"</span>, @([model.name isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// model.name是否是NSMutableString类型：0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然，重写了setName:方法并对name进行了copy操作，无论是copy还是strong声明，赋值的是NSString还是NSMutableString类型，都不会受到外界影响，所以应该养成这个习惯，这样就万无一失了。</p>
<h4 id="可变类型"><a href="#可变类型" class="headerlink" title="可变类型"></a>可变类型</h4><p>CopyOrStrongModel声明两个属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableString</span> *mutableString1;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableString</span> *mutableString2;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CopyOrStrongModel *model = [[CopyOrStrongModel alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *string = <span class="string">@"daisuke"</span>.mutableCopy;</span><br><span class="line">    model.mutableString1 = string;</span><br><span class="line">    model.mutableString2 = string;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"strong声明的model.mutableString1的类型是否是NSMutableString： %@"</span>, @([model.mutableString1 isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// strong声明的model.mutableString1的类型是否是NSMutableString： 1</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"copy声明的model.mutableString1的类型是否是NSMutableString： %@"</span>, @([model.mutableString2 isKindOfClass:[<span class="built_in">NSMutableString</span> class]]));</span><br><span class="line">    <span class="comment">// copy声明的model.mutableString1的类型是否是NSMutableString： 0</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：使用copy声明NSMutableString类型的属性，实际得到的是NSString类型</p>
</blockquote>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><p>文章中例子<a href="https://github.com/DaisukeZJY/CopyTest" target="_blank" rel="external">demo</a></p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html#//apple_ref/doc/uid/TP40010162-SW3" target="_blank" rel="external">Copying Collections</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/LegacyTechnologies/WebObjects/WebObjects_3.5/Reference/Frameworks/ObjC/Foundation/Protocols/NSCopying/Description.html#//apple_ref/occ/intfm/NSCopying/copyWithZone:" target="_blank" rel="external">NSCopying</a></li>
<li><a href="https://www.cnblogs.com/loying/p/4862275" target="_blank" rel="external">ios 深度复制 copy &amp; mutablecopy</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/copy/" rel="tag"><i class="fa fa-tag"></i> copy</a>
          
            <a href="/tags/复制/" rel="tag"><i class="fa fa-tag"></i> 复制</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/30/基于CocoaPods实现组件化/" rel="next" title="基于CocoaPods实现私有库的组件化">
                <i class="fa fa-chevron-left"></i> 基于CocoaPods实现私有库的组件化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/17/InstantMessaging-iOS/" rel="prev" title="一个不太完善的即时通讯流程架构图">
                一个不太完善的即时通讯流程架构图 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2018/06/11/浅析iOS的浅复制与深复制/"
           data-title="浅析iOS的浅复制与深复制" data-url="http://yoursite.com/2018/06/11/浅析iOS的浅复制与深复制/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="DaiSuke" />
            
              <p class="site-author-name" itemprop="name">DaiSuke</p>
              <p class="site-description motion-element" itemprop="description">just's like IT</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/DaisukeZJY" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="feng.daisuke@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要复制？"><span class="nav-number">1.</span> <span class="nav-text">为什么要复制？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在iOS中哪些类支持复制功能？"><span class="nav-number">2.</span> <span class="nav-text">在iOS中哪些类支持复制功能？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浅复制-or-深复制？"><span class="nav-number">3.</span> <span class="nav-text">浅复制 or 深复制？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明类型一定是进行复制后的类型吗？"><span class="nav-number">4.</span> <span class="nav-text">声明类型一定是进行复制后的类型吗？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#深复制真的是深复制吗？"><span class="nav-number">5.</span> <span class="nav-text">深复制真的是深复制吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#归档方式"><span class="nav-number">5.1.</span> <span class="nav-text">归档方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自带API初始化方式"><span class="nav-number">5.2.</span> <span class="nav-text">自带API初始化方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何让对象支持复制操作？"><span class="nav-number">6.</span> <span class="nav-text">如何让对象支持复制操作？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对象中有对象属性时如何支持复制操作？"><span class="nav-number">7.</span> <span class="nav-text">对象中有对象属性时如何支持复制操作？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何让子类对象支持复制操作？"><span class="nav-number">8.</span> <span class="nav-text">如何让子类对象支持复制操作？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#互相引用进行深拷贝结果如何？"><span class="nav-number">9.</span> <span class="nav-text">互相引用进行深拷贝结果如何？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基类runtime方式让所有子类自动实现深复制操作（有不足之处）"><span class="nav-number">10.</span> <span class="nav-text">基类runtime方式让所有子类自动实现深复制操作（有不足之处）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基类BaseModel遵循NSCopying协议"><span class="nav-number">10.1.</span> <span class="nav-text">基类BaseModel遵循NSCopying协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基类BaseModel遵循NSCoding协议"><span class="nav-number">10.2.</span> <span class="nav-text">基类BaseModel遵循NSCoding协议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明属性是使用copy、strong的区别？"><span class="nav-number">11.</span> <span class="nav-text">声明属性是使用copy、strong的区别？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#copy声明"><span class="nav-number">11.1.</span> <span class="nav-text">copy声明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#strong声明"><span class="nav-number">11.2.</span> <span class="nav-text">strong声明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写Setter方法"><span class="nav-number">11.3.</span> <span class="nav-text">重写Setter方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可变类型"><span class="nav-number">11.4.</span> <span class="nav-text">可变类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo"><span class="nav-number">12.</span> <span class="nav-text">demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文档"><span class="nav-number">13.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DaiSuke</span>

  
</div>


  <div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"daisukecn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("EHtYvSIfNxQXWTd66LKTOamk-gzGzoHsz", "QmOk07bceNRvEUFI2Wxs2R0n");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>
