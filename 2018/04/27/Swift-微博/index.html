<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="微博, Swift" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Swift的基础知识基本学完，这次写的不是别的，是培训常模仿的微博项目，现在我也是边模仿边学习的心态。我会记录小码哥中模仿微博的从0到1的过程，希望以后看到自己写的烂文章会笑起来，哈哈。
另外文章篇幅可能很长很长，所以想看的同学可以好好收藏一下。如果觉得可以帮助到你的话，请Star我，也可以Fort一下工程关注项目的进展情况。当然过程中有什么问题的话，随时欢迎Issues,或者你有更好的方案也欢">
<meta property="og:type" content="article">
<meta property="og:title" content="Swift-微博">
<meta property="og:url" content="http://yoursite.com/2018/04/27/Swift-微博/index.html">
<meta property="og:site_name" content="DaiSuke">
<meta property="og:description" content="Swift的基础知识基本学完，这次写的不是别的，是培训常模仿的微博项目，现在我也是边模仿边学习的心态。我会记录小码哥中模仿微博的从0到1的过程，希望以后看到自己写的烂文章会笑起来，哈哈。
另外文章篇幅可能很长很长，所以想看的同学可以好好收藏一下。如果觉得可以帮助到你的话，请Star我，也可以Fort一下工程关注项目的进展情况。当然过程中有什么问题的话，随时欢迎Issues,或者你有更好的方案也欢">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE3.gif">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/weibo0766F05D-FFED-46B2-8C3F-EAE3102D3281.png">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/5D4BE60E-A00C-4BFE-AC5A-836CE464DE20.png">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/weibo4AC4757E-82B3-4134-B3C7-3D71F7B4B6E7.png">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/weibo4AC4757E-82B3-4134-B3C7-3D71F7B4B6E7.png">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/weibo7FCEAB0C-D5D4-4B15-87DB-E5859F4F4C70.png">
<meta property="og:image" content="http://obyghtd4m.bkt.clouddn.com/weibo26198C0D-96FF-4761-A63F-A6EF26D00B73.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weiboweibo%E6%96%B0%E7%89%B9%E6%80%A7.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%25E7%2595%258C%25E9%259D%25A2%25E5%2588%2587%25E6%258D%25A2%25E6%25B5%2581%25E7%25A8%258B%25E5%259B%25BE.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE1.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE2.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE3.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE4.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%B5%8F%E8%A7%88%E5%A4%A7%E5%9B%BE1.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%981.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%982.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%983.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%984.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%985.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%986.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E5%8F%91%E5%B8%832.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E7%85%A7%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A82.gif">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E6%AD%A3%E5%88%991.png">
<meta property="og:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibotextkit1.png">
<meta property="og:updated_time" content="2018-05-23T10:10:51.176Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Swift-微博">
<meta name="twitter:description" content="Swift的基础知识基本学完，这次写的不是别的，是培训常模仿的微博项目，现在我也是边模仿边学习的心态。我会记录小码哥中模仿微博的从0到1的过程，希望以后看到自己写的烂文章会笑起来，哈哈。
另外文章篇幅可能很长很长，所以想看的同学可以好好收藏一下。如果觉得可以帮助到你的话，请Star我，也可以Fort一下工程关注项目的进展情况。当然过程中有什么问题的话，随时欢迎Issues,或者你有更好的方案也欢">
<meta name="twitter:image" content="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE3.gif">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Swift-微博 | DaiSuke </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c9ee80663574cfe4141f5d6a33812bb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>
    <a href="https://github.com/DaisukeZJY"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">DaiSuke</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Who am I</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Swift-微博
              
            
          </h1>
        

        <div class="post-meta">

	
            <i class="fa fa-thumb-tack"></i>
            <font color=7CCD7C>置顶</font>
            <span class="post-meta-divider">|</span>
          

          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-04-27T14:24:34+08:00" content="2018-04-27">
              2018-04-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Swift/" itemprop="url" rel="index">
                    <span itemprop="name">Swift</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/04/27/Swift-微博/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/04/27/Swift-微博/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/04/27/Swift-微博/" class="leancloud_visitors" data-flag-title="Swift-微博">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p><code>Swift</code>的基础知识基本学完，这次写的不是别的，是培训常模仿的微博项目，现在我也是边模仿边学习的心态。我会记录小码哥中模仿<code>微博</code>的从<code>0</code>到<code>1</code>的过程，希望以后看到自己写的烂文章会笑起来，哈哈。</p>
<p>另外文章篇幅可能很长很长，所以想看的同学可以好好收藏一下。如果觉得可以帮助到你的话，请<code>Star</code>我，也可以<code>Fort</code>一下工程关注项目的进展情况。当然过程中有什么问题的话，随时欢迎<code>Issues</code>,或者你有更好的方案也欢迎<code>Pull</code>。</p>
<p>欢迎转载，但是请注明出处，劳动成果来之不易。</p>
</blockquote>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE3.gif" alt="image"></p>
<a id="more"></a>
<h3 id="工程地址"><a href="#工程地址" class="headerlink" title="工程地址"></a>工程地址</h3><p><a href="https://github.com/DaisukeZJY/DWeiBo/tree/master" target="_blank" rel="external">MyWeiBoProjectForSwift</a><br>另外资源可以在工程里面找</p>
<h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>相信大家都会了，这里就不在述说了</p>
<h3 id="删除StoryBoard"><a href="#删除StoryBoard" class="headerlink" title="删除StoryBoard"></a>删除StoryBoard</h3><p>使用纯代码完成这个项目，所以先把故事版删除，还有把<code>info.plist</code>文件的<code>main</code>删除。如下图<br><img src="http://obyghtd4m.bkt.clouddn.com/weibo0766F05D-FFED-46B2-8C3F-EAE3102D3281.png" alt=""></p>
<h3 id="框架搭建"><a href="#框架搭建" class="headerlink" title="框架搭建"></a>框架搭建</h3><ul>
<li>首先建立工程目录</li>
</ul>
<p>按照微博的模块，可以分为<code>首页(Home)</code>、<code>消息(Message)</code>、<code>广场(Discover)</code>、<code>我(Profile)</code>四大模块，然后工程在同级别添加<code>Main</code>、<code>Common</code>、<code>Tool</code>三个模块<br>如下图：<br><img src="http://obyghtd4m.bkt.clouddn.com/5D4BE60E-A00C-4BFE-AC5A-836CE464DE20.png" alt=""></p>
<ul>
<li>搭建框架</li>
</ul>
<p>在<code>Main</code>模块中新建一个继承<code>UITabBarController</code>的自定<code>义MainViewController</code>类<br>那么好了，我们只要在<code>AppDelegate.swift</code>文件中创建Window，并把<code>rootController</code>赋值<code>MainViewController</code>就行了。</p>
<ul>
<li>在AppDelegate.swift创建视图</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">// Override point for customization after application launch.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建window</span></span><br><span class="line">    window = <span class="type">UIWindow</span>(frame:<span class="type">UIScreen</span>.main.bounds)</span><br><span class="line">    window?.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">    <span class="comment">// 创建根控制器</span></span><br><span class="line">    window?.rootViewController = <span class="type">MainViewController</span>()</span><br><span class="line">    window?.makeKeyAndVisible()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在首页(Home)、消息(Message)、广场(Discover)、我(Profile)模块建立主要控制器</li>
</ul>
<p>分别对应<code>HomeTableViewController</code>、<code>MessageTableViewController</code>、<code>DiscoverTableViewController</code>、<code>ProfileTableViewController</code></p>
<ul>
<li>MainViewController创建子控制器</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前控制器对应tabbar的颜色</span></span><br><span class="line">    <span class="comment">// 注意：在iOS7以前如果设置来了titColor只有文字会变，图片不会变</span></span><br><span class="line">    tabBar.tintColor = <span class="type">UIColor</span>.orange</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  创建首页子控制器</span></span><br><span class="line">    <span class="keyword">let</span> homeVC = <span class="type">HomeTableViewController</span>()</span><br><span class="line">    homeVC.title = <span class="string">"首页"</span></span><br><span class="line">    homeVC.tabBarItem.image = <span class="type">UIImage</span>(named: <span class="string">"tabbar_home"</span>)</span><br><span class="line">    homeVC.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建导航控制器包装一下</span></span><br><span class="line">    <span class="keyword">let</span> homeNavC = <span class="type">UINavigationController</span>()</span><br><span class="line">    homeNavC.addChildViewController(homeVC)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航控制器添加到当前控制器</span></span><br><span class="line">    addChildViewController(homeNavC)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  创建消息子控制器</span></span><br><span class="line">    <span class="keyword">let</span> messageVC = <span class="type">MessageTableViewController</span>()</span><br><span class="line">    messageVC.title = <span class="string">"消息"</span></span><br><span class="line">    messageVC.tabBarItem.image = <span class="type">UIImage</span>(named: <span class="string">"tabbar_message_center"</span>)</span><br><span class="line">    messageVC.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建导航控制器包装一下</span></span><br><span class="line">    <span class="keyword">let</span> messageNavC = <span class="type">UINavigationController</span>()</span><br><span class="line">    messageNavC.addChildViewController(messageVC)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航控制器添加到当前控制器</span></span><br><span class="line">    addChildViewController(messageNavC)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  创建广场子控制器</span></span><br><span class="line">    <span class="keyword">let</span> discoverVC = <span class="type">DiscoverTableViewController</span>()</span><br><span class="line">    discoverVC.title = <span class="string">"广场"</span></span><br><span class="line">    discoverVC.tabBarItem.image = <span class="type">UIImage</span>(named: <span class="string">"tabbar_discover"</span>)</span><br><span class="line">    discoverVC.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建导航控制器包装一下</span></span><br><span class="line">    <span class="keyword">let</span> discoverNavC = <span class="type">UINavigationController</span>()</span><br><span class="line">    discoverNavC.addChildViewController(discoverVC)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航控制器添加到当前控制器</span></span><br><span class="line">    addChildViewController(discoverNavC)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  创建我子控制器</span></span><br><span class="line">    <span class="keyword">let</span> profileVC = <span class="type">ProfileTableViewController</span>()</span><br><span class="line">    profileVC.title = <span class="string">"我"</span></span><br><span class="line">    profileVC.tabBarItem.image = <span class="type">UIImage</span>(named: <span class="string">"tabbar_profile"</span>)</span><br><span class="line">    profileVC.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建导航控制器包装一下</span></span><br><span class="line">    <span class="keyword">let</span> profileNavC = <span class="type">UINavigationController</span>()</span><br><span class="line">    profileNavC.addChildViewController(profileVC)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航控制器添加到当前控制器</span></span><br><span class="line">    addChildViewController(profileNavC)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，我们运行一下效果图</p>
<p><img src="http://obyghtd4m.bkt.clouddn.com/weibo4AC4757E-82B3-4134-B3C7-3D71F7B4B6E7.png" alt=""></p>
<ul>
<li>MainViewController重构</li>
</ul>
<p>你们有没有发现上面的代码除了类名、标题和图片的名称不一样，其他的都一样，其实很多重复的代码，我们可以使用一个方法把它搞定，而不同的可以通过参数来传递。这个就是简单的<code>重构</code>。废话不多说，上代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 初始化子控制器</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - parameter childController: 需要初始化的子控制器</span></span><br><span class="line"><span class="comment">/// - parameter title:           标题</span></span><br><span class="line"><span class="comment">/// - parameter imageName:       图片</span></span><br><span class="line">fileprivate <span class="function"><span class="keyword">func</span> <span class="title">addChildViewController</span><span class="params">(<span class="number">_</span> childController: UIViewController, title:String, imageName:String)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 这里提示一下，fileprivate是swift3.0才有的，以前的是使用private</span></span><br><span class="line"></span><br><span class="line">    childController = title</span><br><span class="line">    childController.tabBarItem.image = <span class="type">UIImage</span>(named:imageName)</span><br><span class="line">    childController.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装一个导航器</span></span><br><span class="line">    <span class="keyword">let</span> navController = <span class="type">UINavigationController</span>()</span><br><span class="line">    navController.addChildViewController(childController)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航器添加到当前控制器</span></span><br><span class="line">    addChildViewController(navController)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法构建成功，那么在<code>viewDidLoad</code>中使用就非常简单了<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前控制器对应tabbar的颜色</span></span><br><span class="line">    <span class="comment">// 注意：在iOS7以前如果设置来了titColor只有文字会变，图片不会变</span></span><br><span class="line">    tabBar.tintColor = <span class="type">UIColor</span>.orange</span><br><span class="line"></span><br><span class="line">    addChildViewController(<span class="type">HomeTableViewController</span>(), title: <span class="string">"首页"</span>, imageName: <span class="string">"tabbar_home"</span>)</span><br><span class="line">    addChildViewController(<span class="type">MessageTableViewController</span>(), title: <span class="string">"消息"</span>, imageName: <span class="string">"tabbar_message_center"</span>)</span><br><span class="line">    addChildViewController(<span class="type">DiscoverTableViewController</span>(), title: <span class="string">"广场"</span>, imageName: <span class="string">"tabbar_discover"</span>)</span><br><span class="line">    addChildViewController(<span class="type">ProfileTableViewController</span>(), title: <span class="string">"我"</span>, imageName: <span class="string">"tabbar_profile"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行一下，是不是效果一样，然后代码立即少了许多是不是？<br><img src="http://obyghtd4m.bkt.clouddn.com/weibo4AC4757E-82B3-4134-B3C7-3D71F7B4B6E7.png" alt=""></p>
<h3 id="添加中间按钮"><a href="#添加中间按钮" class="headerlink" title="添加中间按钮"></a>添加中间按钮</h3><p>这个按钮比较特殊，所以要特殊处理一下。</p>
<p>首先，我创建一个新的控制器，作为中间按钮的占位控制器<br><img src="http://obyghtd4m.bkt.clouddn.com/weibo7FCEAB0C-D5D4-4B15-87DB-E5859F4F4C70.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">addChildViewController(<span class="string">"HomeTableViewController"</span>, title: <span class="string">"首页"</span>, imageName: <span class="string">"tabbar_home"</span>)</span><br><span class="line">addChildViewController(<span class="string">"MessageTableViewController"</span>, title: <span class="string">"消息"</span>, imageName: <span class="string">"tabbar_message_center"</span>)</span><br><span class="line"><span class="comment">// 再添加一个占位控制器</span></span><br><span class="line">addChildViewController(<span class="string">"NullViewController"</span>, title: <span class="string">""</span>, imageName: <span class="string">""</span>)</span><br><span class="line">addChildViewController(<span class="string">"DiscoverTableViewController"</span>, title: <span class="string">"广场"</span>, imageName: <span class="string">"tabbar_discover"</span>)</span><br><span class="line">addChildViewController(<span class="string">"ProfileTableViewController"</span>, title: <span class="string">"我"</span>, imageName: <span class="string">"tabbar_profile"</span>)</span><br></pre></td></tr></table></figure>
<p>然后再创建一个按钮表示中间的加号，使用懒加载的方式创建加号按钮<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">fileprivate <span class="built_in">lazy</span> <span class="keyword">var</span> composeBtn:<span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> button = <span class="type">UIButton</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置前置图片</span></span><br><span class="line">    button.setImage(<span class="type">UIImage</span>(named:<span class="string">"tabbar_compose_icon_add"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    button.setImage(<span class="type">UIImage</span>(named:<span class="string">"tabbar_compose_icon_add_highlighted"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置背景图片</span></span><br><span class="line">    button.setBackgroundImage(<span class="type">UIImage</span>(named:<span class="string">"tabbar_compose_button"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    button.setBackgroundImage(<span class="type">UIImage</span>(named:<span class="string">"tabbar_compose_button_highlighted"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加监听事件</span></span><br><span class="line">    button.addTarget(<span class="keyword">self</span>, action: #selector(<span class="type">MainViewController</span>.composeBtnClick), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> button</span><br><span class="line"></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></p>
<p>注意按钮的函数绑定是<code>#selector</code>不是<code>@selector</code>,所以这里绑定一个函数，这里有个注意的地方：监听加号按钮点击，监听按钮点击方法不能私有， 按钮点击事件的调用是由  运行循环 监听并且以消息机制传递的，因此，按钮监听函数不能设置为fileprivate<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 监听加好按钮点击，注意：监听按钮点击方法不能私有</span></span><br><span class="line"><span class="comment">/// 按钮点击事件的调用是由  运行循环 监听并且以消息机制传递的，因此，按钮监听函数不能设置为`fileprivate`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">composeBtnClick</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(#function)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"点击按钮"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再把加号按钮添加到tababr上，这里我抽成一个函数，顺便调整加号按钮的frame<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fileprivate <span class="function"><span class="keyword">func</span> <span class="title">addComposeButton</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加按钮</span></span><br><span class="line">    tabBar.addSubview(composeBtn)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调整加好按钮的位置</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\((viewControllers?.count)! + 1)"</span>)</span><br><span class="line">    <span class="keyword">let</span> width = <span class="type">UIScreen</span>.main.bounds.size.width / <span class="type">CGFloat</span>(viewControllers!.<span class="built_in">count</span>)</span><br><span class="line">    <span class="keyword">let</span> rect = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: width, height: <span class="number">49</span>)</span><br><span class="line"></span><br><span class="line">    composeBtn.frame = rect.offsetBy(dx: <span class="number">2</span> * width, dy: <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一般都是在<code>viewDidLoad</code>这里添加并在设置<code>frame</code>，我也这么一直认为，但是我在<code>viewDidLoad</code>打印一下<code>print(tabBar.subviews)</code>，发现是空的，而在<code>viewWillAppear</code>打印却有值并且有<code>frame</code>。<code>从iOS7开始就不推荐大家在viewDidLoad中设置frame</code>，所以在<code>viewWillAppear</code>添加加号按钮<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//        print("-----")</span></span><br><span class="line">    <span class="comment">//        print(tabBar.subviews)</span></span><br><span class="line">    <span class="comment">// 有值，有frame</span></span><br><span class="line">    addComposeButton()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>好了，运行一下看看效果。</p>
<p><img src="http://obyghtd4m.bkt.clouddn.com/weibo26198C0D-96FF-4761-A63F-A6EF26D00B73.png" alt=""></p>
<hr>
<h2 id="更新时间：2018-04-27-14-24-34"><a href="#更新时间：2018-04-27-14-24-34" class="headerlink" title="更新时间：2018-04-27 14:24:34"></a>更新时间：2018-04-27 14:24:34</h2><h3 id="重构MainViewController"><a href="#重构MainViewController" class="headerlink" title="重构MainViewController"></a>重构MainViewController</h3><p>把子控制器的类型、标题、图片用一个json文件管理，创建一个为MainVCSetting.json文件。内容如下：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"vcName"</span>: <span class="string">"HomeTableViewController"</span>,</span><br><span class="line"><span class="string">"title"</span>: <span class="string">"首页"</span>,</span><br><span class="line"><span class="string">"imageName"</span>: <span class="string">"tabbar_home"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"vcName"</span>: <span class="string">"MessageTableViewController"</span>,</span><br><span class="line"><span class="string">"title"</span>: <span class="string">"消息"</span>,</span><br><span class="line"><span class="string">"imageName"</span>: <span class="string">"tabbar_message_center"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"vcName"</span>: <span class="string">"NullViewController"</span>,</span><br><span class="line"><span class="string">"title"</span>: <span class="string">""</span>,</span><br><span class="line"><span class="string">"imageName"</span>: <span class="string">""</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"vcName"</span>: <span class="string">"DiscoverTableViewController"</span>,</span><br><span class="line"><span class="string">"title"</span>: <span class="string">"广场"</span>,</span><br><span class="line"><span class="string">"imageName"</span>: <span class="string">"tabbar_discover"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"vcName"</span>: <span class="string">"ProfileTableViewController"</span>,</span><br><span class="line"><span class="string">"title"</span>: <span class="string">"我"</span>,</span><br><span class="line"><span class="string">"imageName"</span>: <span class="string">"tabbar_profile"</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>那么我们就可以通过加载MainVCSetting.json文件来获取数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">fileprivate <span class="function"><span class="keyword">func</span> <span class="title">addChildViewControllers</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取json文件的路径</span></span><br><span class="line">    <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"MainVCSetting.json"</span>, ofType: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> pathName = path &#123;</span><br><span class="line">        <span class="keyword">let</span> jsonData = <span class="keyword">try</span>!<span class="type">Data</span>(contentsOf:<span class="type">URL</span>(fileURLWithPath: pathName))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 有可能异常代码放在这里</span></span><br><span class="line">            <span class="comment">// 序列化json数据 --&gt; Array</span></span><br><span class="line">            <span class="comment">// try: 发生异常会跳到catch中继续执行</span></span><br><span class="line">            <span class="comment">// try!: 发生过异常程序直接崩溃</span></span><br><span class="line">            <span class="keyword">let</span> dicArr = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.jsonObject(with: jsonData, options: <span class="type">JSONSerialization</span>.<span class="type">ReadingOptions</span>.mutableContainers)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历数组,动态创建控制器和设置数据</span></span><br><span class="line">            <span class="comment">// 在swift中，如果需要遍历一个数组，必须明确数据类型</span></span><br><span class="line">            <span class="keyword">for</span> dic <span class="keyword">in</span> dicArr <span class="keyword">as</span>! [[<span class="type">String</span>: <span class="type">String</span>]] &#123;</span><br><span class="line">                <span class="comment">// 报错的原因是因为addChildViewController参数必须有值，但是字典返回的是可选值</span></span><br><span class="line">                <span class="comment">//                    addChildViewController(dic["vcName"], title: dic["title"], imageName: dic["imageName"])</span></span><br><span class="line">                addChildViewController(dic[<span class="string">"vcName"</span>]!, title: dic[<span class="string">"title"</span>]!, imageName: dic[<span class="string">"imageName"</span>]!)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发生异常之后会执行的代码</span></span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从本地创建子控制器</span></span><br><span class="line">            addChildViewController(<span class="string">"HomeTableViewController"</span>, title: <span class="string">"首页"</span>, imageName: <span class="string">"tabbar_home"</span>)</span><br><span class="line">            addChildViewController(<span class="string">"MessageTableViewController"</span>, title: <span class="string">"消息"</span>, imageName: <span class="string">"tabbar_message_center"</span>)</span><br><span class="line">            <span class="comment">// 再添加一个占位控制器</span></span><br><span class="line">            addChildViewController(<span class="string">"NullViewController"</span>, title: <span class="string">""</span>, imageName: <span class="string">""</span>)</span><br><span class="line">            addChildViewController(<span class="string">"DiscoverTableViewController"</span>, title: <span class="string">"广场"</span>, imageName: <span class="string">"tabbar_discover"</span>)</span><br><span class="line">            addChildViewController(<span class="string">"ProfileTableViewController"</span>, title: <span class="string">"我"</span>, imageName: <span class="string">"tabbar_profile"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化每一个子控制器</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 初始化子控制器</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - parameter childController: 需要初始化的子控制器</span></span><br><span class="line"><span class="comment">/// - parameter title:           标题</span></span><br><span class="line"><span class="comment">/// - parameter imageName:       图片</span></span><br><span class="line">fileprivate <span class="function"><span class="keyword">func</span> <span class="title">addChildViewController</span><span class="params">(<span class="number">_</span> childControllerName: String, title:String, imageName:String)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置首页对应的数据</span></span><br><span class="line">    <span class="comment">//        childController.title = title</span></span><br><span class="line">    <span class="comment">//        childController.tabBarItem.image = UIImage(named:imageName)</span></span><br><span class="line">    <span class="comment">//        childController.tabBarItem.selectedImage = UIImage(named:imageName+"_highlighted")</span></span><br><span class="line">    <span class="comment">// 动态获取命名空间</span></span><br><span class="line">    <span class="keyword">let</span> bundleString = <span class="type">Bundle</span>.main.infoDictionary![<span class="string">"CFBundleExecutable"</span>] <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将字符串转为类</span></span><br><span class="line">    <span class="keyword">let</span> className:<span class="type">AnyClass</span>? = <span class="type">NSClassFromString</span>(bundleString + <span class="string">"."</span> + childControllerName)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过类创建对象</span></span><br><span class="line">    <span class="comment">// 将AnyClass转为指定的类型</span></span><br><span class="line">    <span class="keyword">let</span> vcClass = className <span class="keyword">as</span>! <span class="type">UIViewController</span>.<span class="type">Type</span></span><br><span class="line">    <span class="comment">// 通过class创建对象</span></span><br><span class="line">    <span class="keyword">let</span> vc = vcClass.<span class="keyword">init</span>()</span><br><span class="line"></span><br><span class="line">    vc.title = title</span><br><span class="line">    <span class="comment">//        vc.tabBarItem.image = UIImage(named:imageName)</span></span><br><span class="line">    vc.tabBarItem.image = <span class="type">UIImage</span>.<span class="keyword">init</span>(named: imageName)</span><br><span class="line">    vc.tabBarItem.selectedImage = <span class="type">UIImage</span>(named:imageName+<span class="string">"_highlighted"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 包装一个导航器</span></span><br><span class="line">    <span class="keyword">let</span> navController = <span class="type">UINavigationController</span>()</span><br><span class="line">    navController.addChildViewController(vc)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将导航器添加到当前控制器</span></span><br><span class="line">    addChildViewController(navController)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加VisitorView视图"><a href="#添加VisitorView视图" class="headerlink" title="添加VisitorView视图"></a>添加VisitorView视图</h3><p>添加一个自定义VisitorView游客视图，作为每个控制器的基本视图。当没有登录的情况下展示的是VisitorView视图。</p>
<p>为了方便布局，使用UIView+AutoLayout分类布局文件，具体可在工程中找到。</p>
<p>下面是VisitorView视图的关键的代码片段：</p>
<h4 id="定义协议"><a href="#定义协议" class="headerlink" title="定义协议"></a>定义协议</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Swift中如何定义协议：必须遵守NSObjectProtocol</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">VisitorViewDelegate</span>: <span class="title">NSObjectProtocol</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 登录回调</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">loginBtnWillClick</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册回调</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">registerBtnWillClick</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用弱引用"><a href="#使用弱引用" class="headerlink" title="使用弱引用"></a>使用弱引用</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个属性保存代理对象</span></span><br><span class="line"><span class="comment">// 一定要加上weak，避免循环引用</span></span><br><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">VisitorViewDelegate</span>?</span><br></pre></td></tr></table></figure>
<h4 id="重写初始化方法注意点"><a href="#重写初始化方法注意点" class="headerlink" title="重写初始化方法注意点"></a>重写初始化方法注意点</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swift推荐我们自定义一个空间，要么用纯代码，要么使用xib/stroyboard</span></span><br><span class="line"><span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果用过xib/stroyboard创建该类，那么就会崩溃</span></span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加BaseViewController控制器"><a href="#添加BaseViewController控制器" class="headerlink" title="添加BaseViewController控制器"></a>添加BaseViewController控制器</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个变量保存用户当前是否是登录</span></span><br><span class="line"><span class="keyword">var</span> userLogin = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义属性保存未登录界面</span></span><br><span class="line"><span class="keyword">var</span> visitorView: <span class="type">VisitorView</span>?</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">loadView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    userLogin ? <span class="keyword">super</span>.loadView() : setupVisitorView()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fileprivate <span class="function"><span class="keyword">func</span> <span class="title">setupVisitorView</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化未登录界面</span></span><br><span class="line">    <span class="keyword">let</span> visitorView = <span class="type">VisitorView</span>()</span><br><span class="line">    <span class="comment">// 设置当前控制器为代理，那么BaseViewController就要遵循VisitorViewDelegate协议</span></span><br><span class="line">    visitorView.delegate = <span class="keyword">self</span></span><br><span class="line">    view = visitorView</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置导航条未登录按钮</span></span><br><span class="line">    navigationItem.leftBarButtonItem = <span class="type">UIBarButtonItem</span>(title: <span class="string">"注册"</span>, style: <span class="type">UIBarButtonItemStyle</span>.plain, target: <span class="keyword">self</span>, action: #selector(<span class="type">BaseViewController</span>.registerBtnWillClick))</span><br><span class="line">    navigationItem.rightBarButtonItem = <span class="type">UIBarButtonItem</span>(title: <span class="string">"登录"</span>, style: <span class="type">UIBarButtonItemStyle</span>.plain, target: <span class="keyword">self</span>, action: #selector(<span class="type">BaseViewController</span>.loginBtnWillClick))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于BaseViewController控制器遵循VisitorViewDelegate协议，那么VisitorViewDelegate的相应方法就要实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loginBtnWillClick</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(#function)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerBtnWillClick</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(#function)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="主控制器继承基类"><a href="#主控制器继承基类" class="headerlink" title="主控制器继承基类"></a>主控制器继承基类</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeTableViewController</span>: <span class="title">BaseViewController</span></span><br><span class="line"><span class="title">class</span> <span class="title">DiscoverTableViewController</span>: <span class="title">BaseViewController</span></span><br><span class="line"><span class="title">class</span> <span class="title">MessageTableViewController</span>: <span class="title">BaseViewController</span></span><br><span class="line"><span class="title">class</span> <span class="title">ProfileTableViewController</span>: <span class="title">BaseViewController</span></span></span><br></pre></td></tr></table></figure>
<h3 id="导航条按钮"><a href="#导航条按钮" class="headerlink" title="导航条按钮"></a>导航条按钮</h3><p>导航栏中使用UIBarButtonItem来显示每一个item，那么现在为了方便创建，使用扩展extension声明一个类型方法。</p>
<p>创建一个Swift文件，名为：UIBarButtonItem+Category</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIBarButtonItem</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 声明一个类型方法，类方法使用class关键字</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">createBarButtonItem</span>(<span class="title">_</span> <span class="title">imageName</span>:<span class="title">String</span>, <span class="title">target</span>:<span class="title">AnyObject</span>?, <span class="title">action</span>:<span class="title">Selector</span>) -&gt; <span class="title">UIBarButtonItem</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> btn = <span class="type">UIButton</span>()</span><br><span class="line">        btn.setImage(<span class="type">UIImage</span>(named: imageName), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        btn.setImage(<span class="type">UIImage</span>(named: imageName), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line">        btn.addTarget(target, action: action, <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line">        btn.sizeToFit()</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIBarButtonItem</span>(customView: btn)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么在HomeTableViewController中创建导航栏的UIBarButtonItem就可以这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupNav</span><span class="params">()</span></span> &#123;</span><br><span class="line">    navigationItem.leftBarButtonItem = <span class="type">UIBarButtonItem</span>.createBarButtonItem(<span class="string">"navigationbar_friendattention"</span>, target: <span class="keyword">self</span>, action: #selector(leftItemClick))</span><br><span class="line">    navigationItem.rightBarButtonItem = <span class="type">UIBarButtonItem</span>.createBarButtonItem(<span class="string">"navigationbar_pop"</span>, target: <span class="keyword">self</span>, action: #selector(rightItemClick))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> titleBtn = <span class="type">UIButton</span>()</span><br><span class="line">    titleBtn.setTitleColor(<span class="type">UIColor</span>.darkGray, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    titleBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"navigationbar_arrow_down"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    titleBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"navigationbar_arrow_up"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.selected)</span><br><span class="line">    titleBtn.setTitle(<span class="string">" WeiBo"</span>, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    titleBtn.addTarget(<span class="keyword">self</span>, action: #selector(titleItemClick(<span class="number">_</span>:)), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line">    titleBtn.sizeToFit()</span><br><span class="line">    navigationItem.titleView = titleBtn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-04-27-16-53-34"><a href="#更新时间：2018-04-27-16-53-34" class="headerlink" title="更新时间：2018-04-27 16:53:34"></a>更新时间：2018-04-27 16:53:34</h2><h3 id="CocoPods"><a href="#CocoPods" class="headerlink" title="CocoPods"></a>CocoPods</h3><h4 id="第三方框架"><a href="#第三方框架" class="headerlink" title="第三方框架"></a>第三方框架</h4><h5 id="项目中使用到以下第三方框架"><a href="#项目中使用到以下第三方框架" class="headerlink" title="项目中使用到以下第三方框架"></a>项目中使用到以下第三方框架</h5><ul>
<li><code>AFNetworking</code></li>
<li><code>SDWebImage</code></li>
<li><code>SVProgressHUD</code></li>
</ul>
<h4 id="Pod-安装"><a href="#Pod-安装" class="headerlink" title="Pod 安装"></a>Pod 安装</h4><ul>
<li>git 备份</li>
<li>打开终端</li>
<li><code>$ cd</code> 进入项目目录</li>
<li>输入以下终端命令建立或编辑 <code>Podfile</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim Podfile</span><br></pre></td></tr></table></figure>
<ul>
<li>输入以下内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use_frameworks!</span><br><span class="line">pod &apos;AFNetworking&apos;</span><br><span class="line">pod &apos;SDWebImage&apos;</span><br><span class="line">pod &apos;SVProgressHUD&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>:wq</code> 保存退出</li>
</ul>
<blockquote>
<p>在 Swift 项目中，cocoapod 仅支持以 Framework 方式添加框架，因此需要在 Podfile 中添加 <code>use_frameworks!</code></p>
</blockquote>
<h4 id="在终端提交添加的框架"><a href="#在终端提交添加的框架" class="headerlink" title="在终端提交添加的框架"></a>在终端提交添加的框架</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将修改添加至暂存区</span></span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交修改并且添加备注信息</span></span><br><span class="line">$ git commit -m <span class="string">"添加第三方框架"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修改推送到远程服务器</span></span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure>
<h4 id="安装第三方框架"><a href="#安装第三方框架" class="headerlink" title="安装第三方框架"></a>安装第三方框架</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装第三方框架</span></span><br><span class="line">pod install</span><br></pre></td></tr></table></figure>
<h4 id="打开xcworkspace工程"><a href="#打开xcworkspace工程" class="headerlink" title="打开xcworkspace工程"></a>打开xcworkspace工程</h4><p>退出当前工程，进入目录，打开xcworkspace工程即可</p>
<h4 id="添加桥接文件DWeibo-Bridge"><a href="#添加桥接文件DWeibo-Bridge" class="headerlink" title="添加桥接文件DWeibo-Bridge"></a>添加桥接文件DWeibo-Bridge</h4><ul>
<li>使用 Xcode 打开工作组文件</li>
<li>在 <code>Supporting Files</code> 下添加桥接文件 <code>Weibo-Bridge.h</code></li>
<li>输入以下内容</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;SDWebImage/UIImageView+WebCache.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;SVProgressHUD/SVProgressHUD.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>点击 <code>项目</code> - <code>TARGETS</code> - <code>Build Settings</code></li>
<li>搜索 <code>bridg</code></li>
<li>在 <code>Objective-C Bridging Header</code> 中输入 <code>DWeibo/DWeibo-Bridge.h</code>路径</li>
</ul>
<p>然后在swift文件中导入SVProgressHUD，这样就可以使用OC的SVProgressHUD框架了。</p>
<hr>
<h2 id="更新时间：2018-04-28-15-28-34"><a href="#更新时间：2018-04-28-15-28-34" class="headerlink" title="更新时间：2018-04-28 15:28:34"></a>更新时间：2018-04-28 15:28:34</h2><h3 id="微博API"><a href="#微博API" class="headerlink" title="微博API"></a>微博API</h3><p>接入<a href="http://open.weibo.com/wiki/微博API" target="_blank" rel="external">微博API</a>，里面的有许多接口，相对应实现即可。有一些分高级接口，可灵活选择。</p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>使用<a href="http://open.weibo.com/wiki/Oauth2/authorize" target="_blank" rel="external">OAuth 2.0授权接口</a></p>
<p>创建应用：我的应用，获取<code>App Key</code>,<code>App Secret</code>,<code>授权回调页：http://daisuke.cn</code>这三个值，作为授权的参数。</p>
<h4 id="创建OAuthViewController"><a href="#创建OAuthViewController" class="headerlink" title="创建OAuthViewController"></a>创建OAuthViewController</h4><ol>
<li>声明需要的参数：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="type">WB_App_Key</span> = <span class="string">"2624860832"</span></span><br><span class="line"><span class="keyword">let</span> <span class="type">WB_App_Secret</span> = <span class="string">"75430fcbef20686409d7b775b1f10f5e"</span></span><br><span class="line"><span class="keyword">let</span> <span class="type">WB_redirect_uri</span> = <span class="string">"http://www.daisuke.cn"</span></span><br></pre></td></tr></table></figure>
<ol>
<li>拼接获取未授权的RequestToken的路径并加载：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> urlStr = <span class="string">"https://api.weibo.com/oauth2/authorize?client_id=\(WB_App_Key)&amp;redirect_uri=\(WB_redirect_uri)"</span></span><br><span class="line"><span class="keyword">let</span> url = <span class="type">NSURL</span>(string: urlStr)</span><br><span class="line"><span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>: url!)</span><br><span class="line">webView.loadRequest(request)</span><br></pre></td></tr></table></figure>
<p>3.遵循UIWebViewDelegate实现方法，利用已经授权的RequestToken换取AccessToken</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">OAuthViewController</span>: <span class="title">UIWebViewDelegate</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 返回true正常加载，返回false不加载</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webView</span><span class="params">(<span class="number">_</span> webView: UIWebView, shouldStartLoadWith request: URLRequest, navigationType: UIWebViewNavigationType)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否授权回调页面，如果不是继续加载</span></span><br><span class="line">        <span class="keyword">let</span> urlStr = request.url!.absoluteString</span><br><span class="line">        <span class="keyword">if</span> !urlStr.hasPrefix(kRedirectUrl) &#123;</span><br><span class="line">            <span class="comment">// 继续加载</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否授权</span></span><br><span class="line">        <span class="keyword">let</span> codeStr = <span class="string">"code="</span></span><br><span class="line">        <span class="keyword">if</span> request.url!.query!.hasPrefix(codeStr) &#123;</span><br><span class="line">            <span class="comment">// 授权成功</span></span><br><span class="line">            <span class="comment">// 取出已经授权的RequestToken</span></span><br><span class="line">            <span class="keyword">let</span> code = request.url!.query!.substring(from: codeStr.endIndex)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 利用已经授权的RequestToken换取AccessToken</span></span><br><span class="line">            loadAccessToken(code: code)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                close()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidStartLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;</span><br><span class="line">        <span class="type">SVProgressHUD</span>.show(withStatus: <span class="string">"正在加载..."</span>)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">webViewDidFinishLoad</span><span class="params">(<span class="number">_</span> webView: UIWebView)</span></span> &#123;</span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - 自定方法</span></span><br><span class="line">    <span class="comment">/// 换取AccessToken</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">loadAccessToken</span><span class="params">(code:String)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 定义路径</span></span><br><span class="line">        <span class="keyword">let</span> path = <span class="string">"oauth2/access_token"</span></span><br><span class="line">        <span class="comment">// 封装参数</span></span><br><span class="line">        <span class="keyword">let</span> params = [<span class="string">"client_id"</span>:kAppKey, <span class="string">"client_secret"</span>:kAppSecret, <span class="string">"grant_type"</span>:<span class="string">"authorization_code"</span>, <span class="string">"code"</span>:code, <span class="string">"redirect_uri"</span>:kRedirectUrl]</span><br><span class="line"></span><br><span class="line">        <span class="type">NetworkTools</span>.shareNetworkTools().post(path, parameters: params, progress: &#123; (<span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            &#125;, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(json <span class="keyword">as</span> <span class="type">Any</span>)</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">            字典转模型</span><br><span class="line">            plist：特点只能存储系统自带的数据类型</span><br><span class="line">            将对象转化为json之后写入文件中</span><br><span class="line">            偏好设置：本质plist</span><br><span class="line">            归档：可以存储自定义对象</span><br><span class="line">            数据库：用于存储大数据，特点效率高</span><br><span class="line">            */</span></span><br><span class="line">            <span class="keyword">let</span> user = <span class="type">UserAccount</span>(dict: json <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>])</span><br><span class="line">            <span class="built_in">print</span>(user)</span><br><span class="line">            user.loadUserInfo(finishBlock: &#123; (account, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> account != <span class="literal">nil</span> &#123;</span><br><span class="line">                account!.saveAccount()</span><br><span class="line">                <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SVProgressHUD</span>.show(withStatus: <span class="string">"网络不给力"</span>)</span><br><span class="line">            <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 由于加载用户信息是异步的，所以不能在这里保存</span></span><br><span class="line">            <span class="comment">//            // 归档模型</span></span><br><span class="line">            <span class="comment">//            user.saveAccount()</span></span><br><span class="line"></span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UserAccount存储用户信息"><a href="#UserAccount存储用户信息" class="headerlink" title="UserAccount存储用户信息"></a>UserAccount存储用户信息</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swift2.0 打印对象需要重写CustomStringConvertible协议中的description</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAccount</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 用于调用access_token，接口获取授权后的access token。</span></span><br><span class="line">    <span class="keyword">var</span> access_token: <span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// access_token的生命周期，单位是秒数。</span></span><br><span class="line">    <span class="keyword">var</span> expires_in: <span class="type">NSNumber</span>?</span><br><span class="line">    <span class="comment">/// 当前授权用户的UID。</span></span><br><span class="line">    <span class="keyword">var</span> uid:<span class="type">String</span>?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">init</span>(dict: [<span class="type">String</span>: <span class="type">AnyObject</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        access_token = dict[<span class="string">"access_token"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        expires_in = dict[<span class="string">"expires_in"</span>] <span class="keyword">as</span>? <span class="type">NSNumber</span></span><br><span class="line">        uid = dict[<span class="string">"uid"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> description: <span class="type">String</span>&#123;</span><br><span class="line">        <span class="comment">// 1.定义属性数组</span></span><br><span class="line">        <span class="keyword">let</span> properties = [<span class="string">"access_token"</span>, <span class="string">"expires_in"</span>, <span class="string">"uid"</span>]</span><br><span class="line">        <span class="comment">// 2.根据属性数组, 将属性转换为字典</span></span><br><span class="line">        <span class="keyword">let</span> dict =  <span class="keyword">self</span>.dictionaryWithValuesForKeys(properties)</span><br><span class="line">        <span class="comment">// 3.将字典转换为字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(dict)"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="归档用户信息"><a href="#归档用户信息" class="headerlink" title="归档用户信息"></a>归档用户信息</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - 保存和读取  Keyed</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line">保存授权模型</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveAccount</span><span class="params">()</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="type">NSSearchPathForDirectoriesInDomains</span>(<span class="type">NSSearchPathDirectory</span>.<span class="type">CachesDirectory</span>, <span class="type">NSSearchPathDomainMask</span>.<span class="type">UserDomainMask</span>, <span class="literal">true</span>).last!</span><br><span class="line">    <span class="keyword">let</span> filePath = (path <span class="keyword">as</span> <span class="type">NSString</span>).stringByAppendingPathComponent(<span class="string">"account.plist"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"filePath \(filePath)"</span>)</span><br><span class="line">    <span class="type">NSKeyedArchiver</span>.archiveRootObject(<span class="keyword">self</span>, toFile: filePath)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 加载授权模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">loadAccount</span>() -&gt; <span class="title">UserAccount</span>? </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="type">NSSearchPathForDirectoriesInDomains</span>(<span class="type">NSSearchPathDirectory</span>.<span class="type">CachesDirectory</span>, <span class="type">NSSearchPathDomainMask</span>.<span class="type">UserDomainMask</span>, <span class="literal">true</span>).last!</span><br><span class="line">    <span class="keyword">let</span> filePath = (path <span class="keyword">as</span> <span class="type">NSString</span>).stringByAppendingPathComponent(<span class="string">"account.plist"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"filePath \(filePath)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> account =  <span class="type">NSKeyedUnarchiver</span>.unarchiveObjectWithFile(filePath) <span class="keyword">as</span>? <span class="type">UserAccount</span></span><br><span class="line">    <span class="keyword">return</span> account</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - NSCoding</span></span><br><span class="line"><span class="comment">// 将对象写入到文件中</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encodeWithCoder</span><span class="params">(aCoder: NSCoder)</span></span></span><br><span class="line">&#123;</span><br><span class="line">    aCoder.encodeObject(access_token, forKey: <span class="string">"access_token"</span>)</span><br><span class="line">    aCoder.encodeObject(expires_in, forKey: <span class="string">"expires_in"</span>)</span><br><span class="line">    aCoder.encodeObject(uid, forKey: <span class="string">"uid"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从文件中读取对象</span></span><br><span class="line"><span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>)</span><br><span class="line">&#123;</span><br><span class="line">    access_token = aDecoder.decodeObjectForKey(<span class="string">"access_token"</span>) <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">    expires_in = aDecoder.decodeObjectForKey(<span class="string">"expires_in"</span>) <span class="keyword">as</span>? <span class="type">NSNumber</span></span><br><span class="line">    uid = aDecoder.decodeObjectForKey(<span class="string">"uid"</span>) <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a>获取用户信息</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadUserInfo</span><span class="params">(finishBlock: @escaping <span class="params">(<span class="number">_</span> account: UserAccount?, <span class="number">_</span> error: NSError?)</span></span></span>-&gt;()) &#123;</span><br><span class="line">    <span class="built_in">assert</span>(access_token != <span class="literal">nil</span>, <span class="string">"没有授权"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">"2/users/show.json"</span></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>:access_token, <span class="string">"uid"</span>:uid]</span><br><span class="line"></span><br><span class="line">    <span class="type">NetworkTools</span>.shareNetworkTools().<span class="keyword">get</span>(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(json <span class="keyword">as</span> <span class="type">Any</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> dict = json <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">AnyObject</span>] &#123;</span><br><span class="line">            <span class="keyword">self</span>.avatar_large = dict[<span class="string">"avatar_large"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">            <span class="keyword">self</span>.screen_name = dict[<span class="string">"screen_name"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存信息</span></span><br><span class="line">            finishBlock(<span class="keyword">self</span>, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        finishBlock(<span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">            finishBlock(<span class="literal">nil</span>, error <span class="keyword">as</span> <span class="type">NSError</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-08-15-07-39"><a href="#更新时间：2018-05-08-15-07-39" class="headerlink" title="更新时间：2018-05-08 15:07:39"></a>更新时间：2018-05-08 15:07:39</h2><h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><h4 id="创建NewFeatureViewController"><a href="#创建NewFeatureViewController" class="headerlink" title="创建NewFeatureViewController"></a>创建NewFeatureViewController</h4><p>NewFeatureViewController继承UICollectionViewController</p>
<p>实现UICollectionViewDataSource</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - UICollectionViewDataSource</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pageCount</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">    <span class="comment">// 获取cell</span></span><br><span class="line">    <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: reuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">NewFeatureCell</span></span><br><span class="line">    cell.imgaeIndex = indexPath.item</span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建NewFeatureCell"><a href="#创建NewFeatureCell" class="headerlink" title="创建NewFeatureCell"></a>创建NewFeatureCell</h4><p>实现每一个cell的样式在NewFeatureViewController的显示</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NewFeatureCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> iconView: <span class="type">UIImageView</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> view = <span class="type">UIImageView</span>()</span><br><span class="line">        <span class="keyword">return</span> view</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存图片的索引</span></span><br><span class="line">    <span class="comment">// Swift中被private修饰的东西，如果同一个文件中是可以访问的</span></span><br><span class="line">    <span class="keyword">var</span> imgaeIndex:<span class="type">Int</span>?&#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            iconView.image = <span class="type">UIImage</span>(named: <span class="string">"new_feature_\(imgaeIndex! + 1)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">        setupUI()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 添加到contentView控件上</span></span><br><span class="line">        contentView.addSubview(iconView)</span><br><span class="line">        iconView.xmg_Fill(contentView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建NewFeatureLayout"><a href="#创建NewFeatureLayout" class="headerlink" title="创建NewFeatureLayout"></a>创建NewFeatureLayout</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 布局对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NewFeatureLayout</span>: <span class="title">UICollectionViewFlowLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重谢准备布局方法</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 设置layout布局</span></span><br><span class="line">        itemSize = <span class="type">UIScreen</span>.main.bounds.size</span><br><span class="line">        minimumLineSpacing = <span class="number">0</span></span><br><span class="line">        minimumInteritemSpacing = <span class="number">0</span></span><br><span class="line">        scrollDirection = <span class="type">UICollectionViewScrollDirection</span>.horizontal</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置collectionView的属性</span></span><br><span class="line">        collectionView?.showsHorizontalScrollIndicator = <span class="literal">false</span></span><br><span class="line">        collectionView?.bounces = <span class="literal">false</span></span><br><span class="line">        collectionView?.isPagingEnabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完善-amp-添加按钮"><a href="#完善-amp-添加按钮" class="headerlink" title="完善&amp;添加按钮"></a>完善&amp;添加按钮</h3><p>添加按钮</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> startBtn: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> btn = <span class="type">UIButton</span>()</span><br><span class="line">    btn.setBackgroundImage(<span class="type">UIImage</span>(named: <span class="string">"new_feature_button"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    btn.setBackgroundImage(<span class="type">UIImage</span>(named: <span class="string">"new_feature_button"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line">    btn.isHidden = <span class="literal">true</span></span><br><span class="line">    btn.addTarget(<span class="keyword">self</span>, action: #selector(clickStartBtn), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line">    <span class="keyword">return</span> btn</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>添加按钮显示动画</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 给按钮做个动画</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startBtnAnimation</span><span class="params">()</span></span> &#123;</span><br><span class="line">    startBtn.isHidden = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行动画</span></span><br><span class="line">    startBtn.transform = <span class="type">CGAffineTransform</span>.<span class="keyword">init</span>(scaleX: <span class="number">0</span>, y: <span class="number">0</span>)</span><br><span class="line">    startBtn.isUserInteractionEnabled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: <span class="number">2</span>, delay: <span class="number">0</span>, usingSpringWithDamping: <span class="number">0.8</span>, initialSpringVelocity: <span class="number">10</span>, options: <span class="type">UIViewAnimationOptions</span>(rawValue: <span class="number">0</span>), animations: &#123;</span><br><span class="line">        <span class="comment">// 清空形变</span></span><br><span class="line">        <span class="keyword">self</span>.startBtn.transform = <span class="type">CGAffineTransform</span>.identity</span><br><span class="line">    &#125;) &#123; (<span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>.startBtn.isUserInteractionEnabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最后一个cell显示完毕的时候执行按钮动画</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完全显示完cell之后调用</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didEndDisplaying cell: UICollectionViewCell, forItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 拿到当前显示的cell对应的索引</span></span><br><span class="line">    <span class="keyword">let</span> path = collectionView.indexPathsForVisibleItems.last</span><br><span class="line">    <span class="built_in">print</span>(path <span class="keyword">as</span> <span class="type">Any</span>)</span><br><span class="line">    <span class="keyword">if</span> path?.item == (pageCount - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 拿到当前索引对应的cell</span></span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.cellForItem(at: path!) <span class="keyword">as</span>! <span class="type">NewFeatureCell</span></span><br><span class="line">        cell.startBtnAnimation()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weiboweibo%E6%96%B0%E7%89%B9%E6%80%A7.gif" alt="image"></p>
<hr>
<h2 id="更新时间：2018-05-08-16-00-03"><a href="#更新时间：2018-05-08-16-00-03" class="headerlink" title="更新时间：2018-05-08 16:00:03"></a>更新时间：2018-05-08 16:00:03</h2><h3 id="添加欢迎界面"><a href="#添加欢迎界面" class="headerlink" title="添加欢迎界面"></a>添加欢迎界面</h3><p>创建WelcomViewController继承于UIViewController</p>
<h4 id="添加子控件"><a href="#添加子控件" class="headerlink" title="添加子控件"></a>添加子控件</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - 懒加载</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> bgImageView: <span class="type">UIImageView</span> = <span class="type">UIImageView</span>(image: <span class="type">UIImage</span>(named: <span class="string">"ad_background"</span>))</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> iconView: <span class="type">UIImageView</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> view = <span class="type">UIImageView</span>(image: <span class="type">UIImage</span>(named: <span class="string">"avatar_default_big"</span>))</span><br><span class="line">    view.layer.cornerRadius = <span class="number">50</span></span><br><span class="line">    view.layer.masksToBounds = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> message: <span class="type">UILabel</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">    label.text = <span class="string">"欢迎归来"</span></span><br><span class="line">    label.alpha = <span class="number">0.0</span></span><br><span class="line">    label.sizeToFit()</span><br><span class="line">    <span class="keyword">return</span> label</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h4 id="添加显示动画"><a href="#添加显示动画" class="headerlink" title="添加显示动画"></a>添加显示动画</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提示：修改约束不会立即生效，添加了一个标记，统一由自动布局系统更新约束</span></span><br><span class="line">    bottomConstaint?.constant = -<span class="type">UIScreen</span>.main.bounds.height - bottomConstaint!.constant</span><br><span class="line">    <span class="built_in">print</span>(-<span class="type">UIScreen</span>.main.bounds.height)</span><br><span class="line">    <span class="built_in">print</span>(bottomConstaint!.constant)</span><br><span class="line"></span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: <span class="number">1.2</span>, delay: <span class="number">0</span>, usingSpringWithDamping: <span class="number">0.8</span>, initialSpringVelocity: <span class="number">10</span>, options: <span class="type">UIViewAnimationOptions</span>(rawValue: <span class="number">0</span>), animations: &#123;</span><br><span class="line">        <span class="comment">// 强制更新约束</span></span><br><span class="line">        <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">    &#125;) &#123; (finish) <span class="keyword">in</span></span><br><span class="line">        <span class="type">UIView</span>.animate(withDuration: <span class="number">1.2</span>, delay: <span class="number">0</span>, usingSpringWithDamping: <span class="number">0.8</span>, initialSpringVelocity: <span class="number">10</span>, options: <span class="type">UIViewAnimationOptions</span>(rawValue: <span class="number">0</span>), animations: &#123;</span><br><span class="line">            <span class="keyword">self</span>.message.alpha = <span class="number">1.0</span></span><br><span class="line">        &#125;) &#123; (finish) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"OK"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>usingSpringWithDamping 的范围为 0.0f 到 1.0f，数值越小 弹簧 的振动效果越明显</li>
<li>initialSpringVelocity 则表示初始的速度，数值越大一开始移动越快，初始速度取值较高而时间较短时，会出现反弹情况</li>
</ul>
<h4 id="初始化信息"><a href="#初始化信息" class="headerlink" title="初始化信息"></a>初始化信息</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化子控件</span></span><br><span class="line">    setupUI()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置用户信息</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> iconUrl = <span class="type">UserAccount</span>.loadAccount()?.avatar_large &#123;</span><br><span class="line">        iconView.sd_setImage(with: <span class="type">NSURL</span>(string: iconUrl)! <span class="keyword">as</span> <span class="type">URL</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="跟控制器切换"><a href="#跟控制器切换" class="headerlink" title="跟控制器切换"></a>跟控制器切换</h3><p>原理图：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%25E7%2595%258C%25E9%259D%25A2%25E5%2588%2587%25E6%258D%25A2%25E6%25B5%2581%25E7%25A8%258B%25E5%259B%25BE.png" alt="image"></p>
<h4 id="判断新版本"><a href="#判断新版本" class="headerlink" title="判断新版本"></a>判断新版本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isNewUpdate</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前版本信息</span></span><br><span class="line">    <span class="keyword">let</span> currentVersion = <span class="type">Bundle</span>.main.infoDictionary![<span class="string">"CFBundleShortVersionString"</span>] <span class="keyword">as</span>! <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> version = <span class="type">NumberFormatter</span>().number(from: currentVersion)?.doubleValue ?? <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取沙盒版本信息</span></span><br><span class="line">    <span class="keyword">let</span> versionKey = <span class="string">"versionKey"</span></span><br><span class="line">    <span class="keyword">let</span> sandboxVersion = <span class="type">UserDefaults</span>.standard.double(forKey: versionKey)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存当前版本</span></span><br><span class="line">    <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(version, forKey: versionKey)</span><br><span class="line">    <span class="keyword">return</span> version &gt; sandboxVersion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="显示的默认控制器"><a href="#显示的默认控制器" class="headerlink" title="显示的默认控制器"></a>显示的默认控制器</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">defaultController</span><span class="params">()</span></span> -&gt; <span class="type">UIViewController</span>&#123;</span><br><span class="line">    <span class="comment">// 判断用户是否登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="type">UserAccount</span>.userLogin() &#123;</span><br><span class="line">        <span class="keyword">return</span> isNewUpdate() ? <span class="type">NewFeatureViewController</span>() : <span class="type">WelcomViewController</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">MainViewController</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定义通知"><a href="#定义通知" class="headerlink" title="定义通知"></a>定义通知</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 切换控制器通知</span></span><br><span class="line"><span class="keyword">let</span> kSwitchRootViewControllerKey = <span class="string">"kSwitchRootViewControllerKey"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册通知</span></span><br><span class="line"><span class="type">NotificationCenter</span>.<span class="keyword">default</span>.addObserver(<span class="keyword">self</span>, selector: #selector(switchRootViewController(notify:)), name: <span class="type">NSNotification</span>.<span class="type">Name</span>(rawValue: kSwitchRootViewControllerKey), object: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 监听方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">switchRootViewController</span><span class="params">(notify:Notification)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> notify.object <span class="keyword">as</span>! <span class="type">Bool</span> &#123;</span><br><span class="line">        window?.rootViewController = <span class="type">MainViewController</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        window?.rootViewController = <span class="type">WelcomViewController</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注销通知"><a href="#注销通知" class="headerlink" title="注销通知"></a>注销通知</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">deinit</span> &#123;</span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.removeObserver(<span class="keyword">self</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发送通知"><a href="#发送通知" class="headerlink" title="发送通知"></a>发送通知</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(name: <span class="type">Notification</span>.<span class="type">Name</span>(rawValue: kSwitchRootViewControllerKey), object: <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-09-10-13-03"><a href="#更新时间：2018-05-09-10-13-03" class="headerlink" title="更新时间：2018-05-09 10:13:03"></a>更新时间：2018-05-09 10:13:03</h2><h3 id="获取微博数据"><a href="#获取微博数据" class="headerlink" title="获取微博数据"></a>获取微博数据</h3><h4 id="创建Status类"><a href="#创建Status类" class="headerlink" title="创建Status类"></a>创建Status类</h4><p>基本属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 微博创建时间</span></span><br><span class="line"><span class="keyword">var</span> created_at:<span class="type">String</span>?</span><br><span class="line"><span class="comment">/// 微博ID</span></span><br><span class="line"><span class="keyword">var</span> id:<span class="type">Int</span>?</span><br><span class="line"><span class="comment">/// 微博信息内容</span></span><br><span class="line"><span class="keyword">var</span> text:<span class="type">String</span>?</span><br><span class="line"><span class="comment">/// 微博来源</span></span><br><span class="line"><span class="keyword">var</span> source:<span class="type">String</span>?</span><br><span class="line"><span class="comment">/// 配图数组</span></span><br><span class="line"><span class="keyword">var</span> pic_urls: [[<span class="type">String</span>:<span class="type">AnyObject</span>]]?</span><br></pre></td></tr></table></figure></p>
<p>加载微博数据</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">loadStatuses</span>(<span class="title">finishBlock</span>:@<span class="title">escaping</span> (<span class="title">_</span> <span class="title">models</span>:[<span class="title">Status</span>]?, <span class="title">_</span> <span class="title">error</span>:<span class="title">NSError</span>?) -&gt;())</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">"2/statuses/home_timeline.json"</span></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>:<span class="type">UserAccount</span>.loadAccount()!.access_token]</span><br><span class="line"></span><br><span class="line">    <span class="type">SVProgressHUD</span>.setStatus(<span class="string">"loading..."</span>)</span><br><span class="line">    <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line"></span><br><span class="line">    <span class="type">NetworkTools</span>.shareNetworkTools().<span class="keyword">get</span>(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> dict = json <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">AnyObject</span>]&#123;</span><br><span class="line">            <span class="comment">// 取出字典数组，转为model数组</span></span><br><span class="line">            <span class="keyword">let</span> dictList = dict[<span class="string">"statuses"</span>] <span class="keyword">as</span>! [[<span class="type">String</span>: <span class="type">AnyObject</span>]]</span><br><span class="line">            <span class="keyword">let</span> models = dictToModel(list: dictList)</span><br><span class="line">            finishBlock(models, <span class="literal">nil</span>)</span><br><span class="line">            <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">    &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">        finishBlock(<span class="literal">nil</span>, error <span class="keyword">as</span> <span class="type">NSError</span>)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HomeTableViewController填充数据"><a href="#HomeTableViewController填充数据" class="headerlink" title="HomeTableViewController填充数据"></a>HomeTableViewController填充数据</h4><p>声明数组存储微博数据<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存微博数组</span></span><br><span class="line"><span class="keyword">var</span> statuses: [<span class="type">Status</span>]? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// 设置数据完毕，刷新表格</span></span><br><span class="line">        tableView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册cell</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册cell</span></span><br><span class="line">tableView.register(<span class="type">UITableViewCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: kHomeCellReuseIdentifier)</span><br></pre></td></tr></table></figure>
<p>加载数据</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 加载数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadData</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">Status</span>.loadStatuses &#123; (models, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.statuses = models</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>扩展HomeTableViewController现实数据源</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">HomeTableViewController</span> </span>&#123;</span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> tableView: UITableView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="comment">// #warning Incomplete implementation, return the number of sections</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="comment">// #warning Incomplete implementation, return the number of rows</span></span><br><span class="line">    <span class="keyword">return</span> statuses?.<span class="built_in">count</span> ?? <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: kHomeCellReuseIdentifier, <span class="keyword">for</span>: indexPath)</span><br><span class="line">        <span class="keyword">if</span> statuses!.<span class="built_in">count</span> &gt; indexPath.row &#123;</span><br><span class="line">            <span class="keyword">let</span> status = statuses![indexPath.row]</span><br><span class="line">            cell.textLabel?.text = status.text</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE1.gif" alt="image"></p>
<h3 id="获取用户数据"><a href="#获取用户数据" class="headerlink" title="获取用户数据"></a>获取用户数据</h3><h4 id="创建User"><a href="#创建User" class="headerlink" title="创建User"></a>创建User</h4><p>声明user的属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 用户ID</span></span><br><span class="line"><span class="keyword">var</span> id: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"><span class="comment">/// 名称</span></span><br><span class="line"><span class="keyword">var</span> name:<span class="type">String</span>?</span><br><span class="line"><span class="comment">/// 用户头像地址（中图）</span></span><br><span class="line"><span class="keyword">var</span> profile_image_url:<span class="type">String</span>?</span><br><span class="line"><span class="comment">/// 认证，ture是</span></span><br><span class="line"><span class="keyword">var</span> verified: <span class="type">Bool</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment">/// 用户的认证类型， -1没有认证， 0认证用户， 2.3.5企业认证， 220达人</span></span><br><span class="line"><span class="keyword">var</span> verified_type: <span class="type">Int</span> = -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="Status监听user的数据"><a href="#Status监听user的数据" class="headerlink" title="Status监听user的数据"></a>Status监听user的数据</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setValue</span><span class="params">(<span class="number">_</span> value: Any?, forKey key: String)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 判断当前是否给字典的user赋值</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"user"</span> == key &#123;</span><br><span class="line">        user = <span class="type">User</span>(dict: value <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用父类的方法，按照系统默认处理</span></span><br><span class="line">    <span class="keyword">super</span>.setValue(value, forKey: key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="StatusTableViewCell"><a href="#StatusTableViewCell" class="headerlink" title="StatusTableViewCell"></a>StatusTableViewCell</h3><h4 id="添加子控件-1"><a href="#添加子控件-1" class="headerlink" title="添加子控件"></a>添加子控件</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contentView.addSubview(iconView)</span><br><span class="line">contentView.addSubview(verifiedView)</span><br><span class="line">contentView.addSubview(nameLabel)</span><br><span class="line">contentView.addSubview(vipView)</span><br><span class="line">contentView.addSubview(timeLabel)</span><br><span class="line">contentView.addSubview(sourceLabel)</span><br><span class="line">contentView.addSubview(contentLabel)</span><br><span class="line">contentView.addSubview(footerView)</span><br></pre></td></tr></table></figure>
<h4 id="监听微博属性"><a href="#监听微博属性" class="headerlink" title="监听微博属性"></a>监听微博属性</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        nameLabel.text = status?.user?.name</span><br><span class="line">        <span class="comment">//            timeLabel.text = status?.created_at</span></span><br><span class="line">        <span class="comment">//            sourceLabel.text = status?.source</span></span><br><span class="line">        timeLabel.text = <span class="string">"刚刚"</span></span><br><span class="line">        sourceLabel.text = <span class="string">"来自：daisuke"</span></span><br><span class="line">        contentLabel.text = status?.text</span><br><span class="line">        iconView.sd_setImage(with: <span class="type">URL</span>(string: (status?.user?.profile_image_url)!))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="替换UITableViewCell"><a href="#替换UITableViewCell" class="headerlink" title="替换UITableViewCell"></a>替换UITableViewCell</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: kHomeCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">StatusTableViewCell</span></span><br><span class="line">    <span class="keyword">if</span> statuses!.<span class="built_in">count</span> &gt; indexPath.row &#123;</span><br><span class="line">        <span class="keyword">let</span> status = statuses![indexPath.row]</span><br><span class="line">        <span class="comment">//            cell.textLabel?.text = status.text</span></span><br><span class="line">        cell.status = status</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE2.gif" alt="image"></p>
<h3 id="封装UILabel和UIButton"><a href="#封装UILabel和UIButton" class="headerlink" title="封装UILabel和UIButton"></a>封装UILabel和UIButton</h3><h4 id="扩展UILabel-UILabel-Category-swift"><a href="#扩展UILabel-UILabel-Category-swift" class="headerlink" title="扩展UILabel, UILabel+Category.swift"></a>扩展UILabel, UILabel+Category.swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UILabel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 快速创建一个label</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">createLabel</span>(<span class="title">color</span>:<span class="title">UIColor</span>, <span class="title">fontSize</span>:<span class="title">CGFloat</span>) -&gt; <span class="title">UILabel</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">        label.textColor = color</span><br><span class="line">        label.font = <span class="type">UIFont</span>.systemFont(ofSize: fontSize)</span><br><span class="line">        <span class="keyword">return</span> label</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="扩展UIButton-UIButton-Category-swift"><a href="#扩展UIButton-UIButton-Category-swift" class="headerlink" title="扩展UIButton, UIButton+Category.swift"></a>扩展UIButton, UIButton+Category.swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 快速创建一个Button</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">createButton</span>(<span class="title">imageName</span>: <span class="title">String</span>, <span class="title">title</span>: <span class="title">String</span>) -&gt; <span class="title">UIButton</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> btn = <span class="type">UIButton</span>()</span><br><span class="line">        btn.setTitle(title, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        btn.setImage(<span class="type">UIImage</span>(named: imageName), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        btn.titleLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">10</span>)</span><br><span class="line">        btn.setBackgroundImage(<span class="type">UIImage</span>(named: <span class="string">"timeline_card_bottom_background"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        btn.setTitleColor(<span class="type">UIColor</span>.darkGray, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        btn.titleEdgeInsets = <span class="type">UIEdgeInsets</span>(top: <span class="number">0</span>, <span class="keyword">left</span>: <span class="number">10</span>, bottom: <span class="number">0</span>, <span class="keyword">right</span>: <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> btn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="StatusTableViewCell-swift重构"><a href="#StatusTableViewCell-swift重构" class="headerlink" title="StatusTableViewCell.swift重构"></a>StatusTableViewCell.swift重构</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 昵称</span></span><br><span class="line"><span class="comment">//    private lazy var nameLabel: UILabel = &#123;</span></span><br><span class="line"><span class="comment">//        let name = UILabel()</span></span><br><span class="line"><span class="comment">//        name.textColor = UIColor.darkGray</span></span><br><span class="line"><span class="comment">//        name.font = UIFont.systemFont(ofSize: 14)</span></span><br><span class="line"><span class="comment">//        return name</span></span><br><span class="line"><span class="comment">//    &#125;()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> nameLabel: <span class="type">UILabel</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> name = <span class="type">UILabel</span>.createLabel(color: <span class="type">UIColor</span>.darkGray, fontSize: <span class="number">14</span>)</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    private lazy var commonBtn: UIButton = &#123;</span></span><br><span class="line"><span class="comment">//        let btn = UIButton()</span></span><br><span class="line"><span class="comment">//        btn.setImage(UIImage(named: "timeline_icon_comment"), for: UIControlState.normal)</span></span><br><span class="line"><span class="comment">//        btn.setTitle("评论", for: UIControlState.normal)</span></span><br><span class="line"><span class="comment">//        btn.titleLabel?.font = UIFont.systemFont(ofSize: 10)</span></span><br><span class="line"><span class="comment">//        btn.setTitleColor(UIColor.darkGray, for: UIControlState.normal)</span></span><br><span class="line"><span class="comment">//        btn.titleEdgeInsets = UIEdgeInsetsMake(0, 10, 0, 0)</span></span><br><span class="line"><span class="comment">//        btn.setBackgroundImage(UIImage(named: "timeline_card_bottom_background"), for: UIControlState.normal)</span></span><br><span class="line"><span class="comment">//        return btn</span></span><br><span class="line"><span class="comment">//    &#125;()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> commonBtn: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> btn = <span class="type">UIButton</span>.createButton(imageName: <span class="string">"timeline_icon_comment"</span>, title: <span class="string">"评论"</span>)</span><br><span class="line">    <span class="keyword">return</span> btn</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-10-10-11-16"><a href="#更新时间：2018-05-10-10-11-16" class="headerlink" title="更新时间：2018-05-10 10:11:16"></a>更新时间：2018-05-10 10:11:16</h2><h3 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h3><h4 id="认证图标"><a href="#认证图标" class="headerlink" title="认证图标"></a>认证图标</h4><p>User.swift<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 用户的认证类型， -1没有认证， 0认证用户， 2.3.5企业认证， 220达人</span></span><br><span class="line"><span class="keyword">var</span> verified_type: <span class="type">Int</span> = -<span class="number">1</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> verified_type &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            verifiedImage = <span class="type">UIImage</span>(named: <span class="string">"avatar_vip"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>:</span><br><span class="line">            verifiedImage = <span class="type">UIImage</span>(named: <span class="string">"avatar_enterprise_vip"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="number">220</span>:</span><br><span class="line">            verifiedImage = <span class="type">UIImage</span>(named: <span class="string">"avatar_grassroot"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            verifiedImage = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 保存当前用户的认证图片</span></span><br><span class="line"><span class="keyword">var</span> verifiedImage:<span class="type">UIImage</span>?</span><br></pre></td></tr></table></figure></p>
<p>StatusTableViewCell.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        nameLabel.text = status?.user?.name</span><br><span class="line">        <span class="comment">//            timeLabel.text = status?.created_at</span></span><br><span class="line">        <span class="comment">//            sourceLabel.text = status?.source</span></span><br><span class="line">        timeLabel.text = <span class="string">"刚刚"</span></span><br><span class="line">        sourceLabel.text = <span class="string">"来自：daisuke"</span></span><br><span class="line">        contentLabel.text = status?.text</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = status?.user?.profile_image_url &#123;</span><br><span class="line">            iconView.sd_setImage(with: <span class="type">URL</span>(string: url))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置会员图标</span></span><br><span class="line">        verifiedView.image = status?.user?.verifiedImage</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="会员图标"><a href="#会员图标" class="headerlink" title="会员图标"></a>会员图标</h4><p>User.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 会员等级</span></span><br><span class="line"><span class="keyword">var</span> mbrank: <span class="type">Int</span> = <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> mbrank &gt; <span class="number">0</span> &amp;&amp; mbrank &lt; <span class="number">7</span> &#123;</span><br><span class="line">            mbrankImage = <span class="type">UIImage</span>(named: <span class="string">"common_icon_membership_level\(mbrank)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 会员图标</span></span><br><span class="line"><span class="keyword">var</span> mbrankImage:<span class="type">UIImage</span>?</span><br></pre></td></tr></table></figure>
<p>StatusTableViewCell.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        nameLabel.text = status?.user?.name</span><br><span class="line">        <span class="comment">//            timeLabel.text = status?.created_at</span></span><br><span class="line">        <span class="comment">//            sourceLabel.text = status?.source</span></span><br><span class="line">        timeLabel.text = <span class="string">"刚刚"</span></span><br><span class="line">        sourceLabel.text = <span class="string">"来自：daisuke"</span></span><br><span class="line">        contentLabel.text = status?.text</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = status?.user?.profile_image_url &#123;</span><br><span class="line">            iconView.sd_setImage(with: <span class="type">URL</span>(string: url))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置会员图标</span></span><br><span class="line">        verifiedView.image = status?.user?.verifiedImage</span><br><span class="line">        vipView.image = status?.user?.mbrankImage</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="来源处理"><a href="#来源处理" class="headerlink" title="来源处理"></a>来源处理</h4><p>Status.swift<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 微博来源</span></span><br><span class="line"><span class="keyword">var</span> source:<span class="type">String</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// &lt;a href=\"http://app.weibo.com/t/feed/4fuyNj\" rel=\"nofollow\"&gt;即刻笔记&lt;/a&gt;</span></span><br><span class="line">        <span class="comment">// 截取字符串</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> str = source &#123;</span><br><span class="line">            <span class="comment">// 获取开始截取的位置</span></span><br><span class="line">            <span class="keyword">let</span> startLocation = (str <span class="keyword">as</span> <span class="type">NSString</span>).range(of: <span class="string">"&gt;"</span>).location+<span class="number">1</span></span><br><span class="line">            <span class="comment">// 获取截取的长度</span></span><br><span class="line">            <span class="keyword">let</span> length = (str <span class="keyword">as</span> <span class="type">NSString</span>).range(of: <span class="string">"&lt;"</span>, options: <span class="type">NSString</span>.<span class="type">CompareOptions</span>.backwards).location - startLocation</span><br><span class="line">            source = <span class="string">"来自:"</span>+(str <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: <span class="type">NSRange</span>(location: startLocation, length: length))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="创建时间处理"><a href="#创建时间处理" class="headerlink" title="创建时间处理"></a>创建时间处理</h4><p>扩展NSDate，创建Date+Category.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSDate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 字符串转date</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">dateWithString</span>(<span class="title">time</span>:<span class="title">String</span>) -&gt; <span class="title">NSDate</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建fomatter</span></span><br><span class="line">        <span class="keyword">let</span> fomatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        <span class="comment">// 设置时间格式</span></span><br><span class="line">        fomatter.dateFormat = <span class="string">"EEE MMM d HH:mm:ss Z yyyy"</span></span><br><span class="line">        <span class="comment">// 设置时间的区域（真机必须设置，否则可能转换不成功）</span></span><br><span class="line">        fomatter.locale = <span class="type">Locale</span>(identifier: <span class="string">"en"</span>)</span><br><span class="line">        <span class="keyword">let</span> createDate = fomatter.date(from: time)!</span><br><span class="line">        <span class="keyword">return</span> createDate <span class="keyword">as</span> <span class="type">NSDate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    刚刚(一分钟内)</span><br><span class="line">    X分钟前(一小时内)</span><br><span class="line">    X小时前(当天)</span><br><span class="line">    昨天 HH:mm(昨天)</span><br><span class="line">    MM-dd HH:mm(一年内)</span><br><span class="line">    yyyy-MM-dd HH:mm(更早期)</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">var</span> descDate:<span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> calendar = <span class="type">NSCalendar</span>.current</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否今天</span></span><br><span class="line">        <span class="keyword">if</span> calendar.isDateInToday(<span class="keyword">self</span> <span class="keyword">as</span> <span class="type">Date</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取当前时间和系统时间之间的差距</span></span><br><span class="line">            <span class="keyword">let</span> since = <span class="type">Int</span>(<span class="type">NSDate</span>().timeIntervalSince(<span class="keyword">self</span> <span class="keyword">as</span> <span class="type">Date</span>))</span><br><span class="line">            <span class="keyword">if</span> since &lt; <span class="number">60</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"刚刚"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> since &lt; <span class="number">60</span> * <span class="number">60</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"\(since/60)分钟前"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"\(since/60/60)小时前"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否是昨天</span></span><br><span class="line">        <span class="keyword">var</span> fomatterStr = <span class="string">"HH:mm"</span></span><br><span class="line">        <span class="keyword">if</span> calendar.isDateInYesterday(<span class="keyword">self</span> <span class="keyword">as</span> <span class="type">Date</span>) &#123;</span><br><span class="line">            fomatterStr = <span class="string">"昨天:"</span> + fomatterStr</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理一年以内</span></span><br><span class="line">            fomatterStr = <span class="string">"MM-dd"</span> + fomatterStr</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理更早时间</span></span><br><span class="line">            <span class="keyword">let</span> comps = calendar.dateComponents([<span class="type">Calendar</span>.<span class="type">Component</span>.year], from: (<span class="keyword">self</span> <span class="keyword">as</span> <span class="type">Date</span>), to: <span class="type">Date</span>())</span><br><span class="line">            <span class="keyword">if</span> comps.year! &gt;= <span class="number">1</span> &#123;</span><br><span class="line">                fomatterStr = <span class="string">"yyyy-"</span> + fomatterStr</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建fomatter</span></span><br><span class="line">        <span class="keyword">let</span> fomatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        fomatter.dateFormat = fomatterStr</span><br><span class="line">        fomatter.locale = <span class="type">Locale</span>(identifier: <span class="string">"en"</span>)</span><br><span class="line">        <span class="keyword">return</span> fomatter.string(from: <span class="keyword">self</span> <span class="keyword">as</span> <span class="type">Date</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Status.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 微博创建时间</span></span><br><span class="line"><span class="keyword">var</span> created_at:<span class="type">String</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> date = <span class="type">NSDate</span>.dateWithString(time: created_at!)</span><br><span class="line">        created_at = date.descDate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="缓存配图"><a href="#缓存配图" class="headerlink" title="缓存配图"></a>缓存配图</h4><p>Status.swift</p>
<p>添加storedPicURLs数组&amp;重写pic_urls的set方法<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 配图数组</span></span><br><span class="line"><span class="keyword">var</span> pic_urls: [[<span class="type">String</span>:<span class="type">AnyObject</span>]]? &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        storedPicURLs = [<span class="type">NSURL</span>]()</span><br><span class="line">        <span class="keyword">for</span> dict <span class="keyword">in</span> pic_urls! &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> urlStr = dict[<span class="string">"thumbnail_pic"</span>]&#123;</span><br><span class="line">                <span class="comment">// 将字符串转为URL保存到数组中</span></span><br><span class="line">                storedPicURLs?.append(<span class="type">NSURL</span>(string: urlStr <span class="keyword">as</span>! <span class="type">String</span>)!)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 保存当前微博所有配图的URL</span></span><br><span class="line"><span class="keyword">var</span> storedPicURLs:[<span class="type">NSURL</span>]?</span><br></pre></td></tr></table></figure></p>
<p>添加类方法缓存微博图片</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 缓存微博图片</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">cacheStatusImages</span>(<span class="title">list</span>:[<span class="title">Status</span>], <span class="title">finishBlock</span>:@<span class="title">escaping</span> (<span class="title">_</span> <span class="title">models</span>:[<span class="title">Status</span>]?, <span class="title">_</span> <span class="title">error</span>:<span class="title">NSError</span>?) -&gt;()) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个数组</span></span><br><span class="line">    <span class="keyword">let</span> group = <span class="type">DispatchGroup</span>()</span><br><span class="line">    <span class="keyword">for</span> status <span class="keyword">in</span> list &#123;</span><br><span class="line">        <span class="comment">// 判断当前微博是否有配图，没有就直接跳过</span></span><br><span class="line">        <span class="comment">//            if status.storedPicURLs == nil &#123;</span></span><br><span class="line">        <span class="comment">//                continue</span></span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 新语法</span></span><br><span class="line">        <span class="comment">// 如果条件为nil，那么久会执行else后面的语句</span></span><br><span class="line">        <span class="keyword">guard</span> status.storedPicURLs != <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> status.storedPicURLs! &#123;</span><br><span class="line">            <span class="comment">// 将当前的下载操作添加到组</span></span><br><span class="line">            group.enter()</span><br><span class="line"></span><br><span class="line">            <span class="type">SDWebImageManager</span>.shared().downloadImage(with: url <span class="keyword">as</span> <span class="type">URL</span>, options: <span class="type">SDWebImageOptions</span>(rawValue: <span class="number">0</span>), progress: <span class="literal">nil</span>) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 离开当前组</span></span><br><span class="line">                group.leave()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当所有图片都下载完毕再通过闭包通用调用者</span></span><br><span class="line">    group.notify(queue: <span class="type">DispatchQueue</span>.main) &#123;</span><br><span class="line">        <span class="comment">// 能够来到这个地方，一定是所有图片都下载完毕</span></span><br><span class="line">        finishBlock(list, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用缓存微博图片方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 加载微博数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">loadStatuses</span>(<span class="title">finishBlock</span>:@<span class="title">escaping</span> (<span class="title">_</span> <span class="title">models</span>:[<span class="title">Status</span>]?, <span class="title">_</span> <span class="title">error</span>:<span class="title">NSError</span>?) -&gt;())</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">"2/statuses/home_timeline.json"</span></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>:<span class="type">UserAccount</span>.loadAccount()!.access_token]</span><br><span class="line"></span><br><span class="line">    <span class="type">SVProgressHUD</span>.setStatus(<span class="string">"loading..."</span>)</span><br><span class="line">    <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line"></span><br><span class="line">    <span class="type">NetworkTools</span>.shareNetworkTools().<span class="keyword">get</span>(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> dict = json <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">AnyObject</span>]&#123;</span><br><span class="line">            <span class="comment">// 取出字典数组，转为model数组</span></span><br><span class="line">            <span class="keyword">let</span> dictList = dict[<span class="string">"statuses"</span>] <span class="keyword">as</span>! [[<span class="type">String</span>: <span class="type">AnyObject</span>]]</span><br><span class="line">            <span class="keyword">let</span> models = dictToModel(list: dictList)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//                finishBlock(models, nil)</span></span><br><span class="line">            <span class="comment">// 替换成缓存微博图片方法</span></span><br><span class="line">            cacheStatusImages(list: models, finishBlock: finishBlock)</span><br><span class="line"></span><br><span class="line">            <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">    &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">        finishBlock(<span class="literal">nil</span>, error <span class="keyword">as</span> <span class="type">NSError</span>)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="计算配图大小"><a href="#计算配图大小" class="headerlink" title="计算配图大小"></a>计算配图大小</h4><p>StatusTableViewCell.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算配图的尺寸</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">calculateImageSize</span><span class="params">()</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">    <span class="comment">// 取出配图个数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = status?.storedPicURLs?.<span class="built_in">count</span></span><br><span class="line">    <span class="comment">// 如果没有配图zero</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">0</span> || <span class="built_in">count</span> == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>.zero</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果只有一张配图，返回图片的实际大小</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// 取出缓存的图片</span></span><br><span class="line">        <span class="keyword">let</span> key = status?.storedPicURLs?.first?.absoluteString</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">SDWebImageManager</span>.shared().imageCache.imageFromDiskCache(forKey: key!)</span><br><span class="line">        <span class="keyword">return</span> (image?.size)!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有4张配图，计算字格的大小</span></span><br><span class="line">    <span class="keyword">let</span> width = <span class="number">90</span></span><br><span class="line">    <span class="keyword">let</span> margin = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewWidth = width * <span class="number">2</span> + margin</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>(width: viewWidth, height: viewWidth)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是其他（多张），计算九宫格的大小</span></span><br><span class="line">    <span class="keyword">let</span> colNumber = <span class="number">3</span></span><br><span class="line">    <span class="keyword">let</span> rowNumber = (<span class="built_in">count</span>! - <span class="number">1</span>) / <span class="number">3</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> viewWidth = colNumber * width + (colNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">let</span> viewHeight = rowNumber * width + (rowNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGSize</span>(width: viewWidth, height: viewHeight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="显示配图"><a href="#显示配图" class="headerlink" title="显示配图"></a>显示配图</h4><h5 id="懒加载配图控件"><a href="#懒加载配图控件" class="headerlink" title="懒加载配图控件"></a>懒加载配图控件</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配图</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> pictureLayout: <span class="type">UICollectionViewFlowLayout</span> = <span class="type">UICollectionViewFlowLayout</span>()</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> pictureView: <span class="type">UICollectionView</span> = <span class="type">UICollectionView</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: <span class="keyword">self</span>.pictureLayout)</span><br></pre></td></tr></table></figure>
<h5 id="初始化配图控件"><a href="#初始化配图控件" class="headerlink" title="初始化配图控件"></a>初始化配图控件</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 初始化配图的相关属性</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupPictureView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 注册cell</span></span><br><span class="line">    pictureView.register(<span class="type">PictureViewCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kPictureViewCellId)</span><br><span class="line">    pictureView.dataSource = <span class="keyword">self</span></span><br><span class="line">    <span class="comment">// 设置cell之间的间隙</span></span><br><span class="line">    pictureLayout.minimumLineSpacing = <span class="number">10</span></span><br><span class="line">    pictureLayout.minimumInteritemSpacing = <span class="number">10</span></span><br><span class="line">    <span class="comment">// 设置配图的背景颜色</span></span><br><span class="line">    pictureView.backgroundColor = <span class="type">UIColor</span>.darkGray</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="扩展StatusTableViewCell实现数据源"><a href="#扩展StatusTableViewCell实现数据源" class="headerlink" title="扩展StatusTableViewCell实现数据源"></a>扩展StatusTableViewCell实现数据源</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">StatusTableViewCell</span>:<span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> status?.storedPicURLs?.<span class="built_in">count</span> ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kPictureViewCellId, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">PictureViewCell</span></span><br><span class="line">        <span class="keyword">if</span> (status?.storedPicURLs?.<span class="built_in">count</span>)! &gt; indexPath.item &#123;</span><br><span class="line">            cell.imageUrl = status?.storedPicURLs![indexPath.item]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="自定义配图cell"><a href="#自定义配图cell" class="headerlink" title="自定义配图cell"></a>自定义配图cell</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PictureViewCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> imageUrl:<span class="type">NSURL</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span>&#123;</span><br><span class="line">            iconView.sd_setImage(with: imageUrl! <span class="keyword">as</span> <span class="type">URL</span>!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">        contentView.addSubview(iconView)</span><br><span class="line"></span><br><span class="line">        iconView.xmg_Fill(contentView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> iconView = <span class="type">UIImageView</span> ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="完善计算配图方法，返回总试图的尺寸-amp-每个子视图的尺寸"><a href="#完善计算配图方法，返回总试图的尺寸-amp-每个子视图的尺寸" class="headerlink" title="完善计算配图方法，返回总试图的尺寸&amp;每个子视图的尺寸"></a>完善计算配图方法，返回总试图的尺寸&amp;每个子视图的尺寸</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算配图的尺寸</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">calculateImageSize</span><span class="params">()</span></span> -&gt; (viewSize:<span class="type">CGSize</span>, itemSize:<span class="type">CGSize</span>) &#123;</span><br><span class="line">    <span class="comment">// 取出配图个数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = status?.storedPicURLs?.<span class="built_in">count</span></span><br><span class="line">    <span class="comment">// 如果没有配图zero</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">0</span> || <span class="built_in">count</span> == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">CGSize</span>.zero, <span class="type">CGSize</span>.zero)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果只有一张配图，返回图片的实际大小</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &#123;</span><br><span class="line">    <span class="comment">// 取出缓存的图片</span></span><br><span class="line">    <span class="keyword">let</span> key = status?.storedPicURLs?.first?.absoluteString</span><br><span class="line">    <span class="keyword">let</span> image = <span class="type">SDWebImageManager</span>.shared().imageCache.imageFromDiskCache(forKey: key!)</span><br><span class="line">        <span class="keyword">return</span> (image!.size, image!.size)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有4张配图，计算字格的大小</span></span><br><span class="line">    <span class="keyword">let</span> width = <span class="number">90</span></span><br><span class="line">    <span class="keyword">let</span> margin = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewWidth = width * <span class="number">2</span> + margin</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">CGSize</span>(width: viewWidth, height: viewWidth), <span class="type">CGSize</span>(width: width, height: width))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是其他（多张），计算九宫格的大小</span></span><br><span class="line">    <span class="keyword">let</span> colNumber = <span class="number">3</span></span><br><span class="line">    <span class="keyword">let</span> rowNumber = (<span class="built_in">count</span>! - <span class="number">1</span>) / <span class="number">3</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> viewWidth = colNumber * width + (colNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">let</span> viewHeight = rowNumber * width + (rowNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">CGSize</span>(width: viewWidth, height: viewHeight), <span class="type">CGSize</span>(width: width, height: width))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="设置配图尺寸"><a href="#设置配图尺寸" class="headerlink" title="设置配图尺寸"></a>设置配图尺寸</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        nameLabel.text = status?.user?.name</span><br><span class="line">        timeLabel.text = status?.created_at</span><br><span class="line">        sourceLabel.text = status?.source</span><br><span class="line">        contentLabel.text = status?.text</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = status?.user?.profile_image_url &#123;</span><br><span class="line">            iconView.sd_setImage(with: <span class="type">URL</span>(string: url))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置会员图标</span></span><br><span class="line">        verifiedView.image = status?.user?.verifiedImage</span><br><span class="line">        vipView.image = status?.user?.mbrankImage</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置配图尺寸</span></span><br><span class="line">        <span class="keyword">let</span> size = calculateImageSize()</span><br><span class="line">        pictureWidthCons?.constant = size.viewSize.width</span><br><span class="line">        pictureHeightCons?.constant = size.viewSize.height</span><br><span class="line">        pictureLayout.itemSize = size.itemSize</span><br><span class="line">        pictureView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="缓存行高"><a href="#缓存行高" class="headerlink" title="缓存行高"></a>缓存行高</h4><p>在StatusTableViewCell.swift添加获取行高的方法<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 获取行高</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rowHeight</span><span class="params">(status:Status)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">    <span class="comment">// 为了调用didSet， 计算配图的高度</span></span><br><span class="line">    <span class="keyword">self</span>.status = status</span><br><span class="line">    <span class="comment">// 强制更新页面</span></span><br><span class="line">    <span class="keyword">self</span>.layoutIfNeeded()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回底部试图最大的Y值</span></span><br><span class="line">    <span class="keyword">return</span> footerView.frame.maxY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>HomeTableViewController.swift</p>
<p>声明缓存行高的数组<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 微博行高的缓存，利用字典作为容器，key是微博的ID，值就是对应微博的行高</span></span><br><span class="line"><span class="keyword">var</span> rowCache: [<span class="type">Int</span>:<span class="type">CGFloat</span>] = [<span class="type">Int</span>:<span class="type">CGFloat</span>]()</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 清空缓存</span></span><br><span class="line">    rowCache.removeAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Status.swift中吧id属性可选属性去掉，给默认值</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 微博ID</span></span><br><span class="line"><span class="comment">// var id:Int?</span></span><br><span class="line"><span class="keyword">var</span> id:<span class="type">Int</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>实现返回数据源方法，返回行高</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, heightForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">    <span class="comment">// 取出对应的模型</span></span><br><span class="line">    <span class="keyword">let</span> status = statuses![indexPath.row]</span><br><span class="line">    <span class="comment">// 判断缓存中有没有</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> height = rowCache[status.id] &#123;</span><br><span class="line">        <span class="keyword">return</span> height</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到cell</span></span><br><span class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: kHomeCellReuseIdentifier) <span class="keyword">as</span>! <span class="type">StatusTableViewCell</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到行高</span></span><br><span class="line">    <span class="keyword">let</span> rowHeight = cell.rowHeight(status: status)</span><br><span class="line">    <span class="comment">// 缓存行高</span></span><br><span class="line">    rowCache[status.id] = rowHeight</span><br><span class="line">    <span class="keyword">return</span> rowHeight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE3.gif" alt="image"></p>
<h3 id="重构StatusTableViewCell-swift"><a href="#重构StatusTableViewCell-swift" class="headerlink" title="重构StatusTableViewCell.swift"></a>重构StatusTableViewCell.swift</h3><p>cell的子控件分为四个部分，工具条封装成一个个view，头部封装成一个view，如下图：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/%E9%A6%96%E9%A1%B5%E6%95%B0%E6%8D%AE4.png" alt="image"></p>
<h4 id="创建StatusCellTopView"><a href="#创建StatusCellTopView" class="headerlink" title="创建StatusCellTopView"></a>创建StatusCellTopView</h4><p>分别包含有昵称、头像、认证图标、会员图标、来源、时间这个几个控件</p>
<p>部分代码，具体看实现<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        nameLabel.text = status?.user?.name</span><br><span class="line">        timeLabel.text = status?.created_at</span><br><span class="line">        sourceLabel.text = status?.source</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = status?.user?.profile_image_url &#123;</span><br><span class="line">            iconView.sd_setImage(with: <span class="type">URL</span>(string: url))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置会员图标</span></span><br><span class="line">        verifiedView.image = status?.user?.verifiedImage</span><br><span class="line">        vipView.image = status?.user?.mbrankImage</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们把topView替换成cell里面的控件</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> topView:<span class="type">StatusCellTopView</span> = <span class="type">StatusCellTopView</span>()</span><br></pre></td></tr></table></figure>
<p>数据赋值<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line"><span class="comment">//            nameLabel.text = status?.user?.name</span></span><br><span class="line"><span class="comment">//            timeLabel.text = status?.created_at</span></span><br><span class="line"><span class="comment">//            sourceLabel.text = status?.source</span></span><br><span class="line"><span class="comment">//            if let url = status?.user?.profile_image_url &#123;</span></span><br><span class="line"><span class="comment">//                iconView.sd_setImage(with: URL(string: url))</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 设置会员图标</span></span><br><span class="line"><span class="comment">//            verifiedView.image = status?.user?.verifiedImage</span></span><br><span class="line"><span class="comment">//            vipView.image = status?.user?.mbrankImage</span></span><br><span class="line">        topView.status = status</span><br><span class="line"></span><br><span class="line">        contentLabel.text = status?.text</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置配图尺寸</span></span><br><span class="line">        <span class="keyword">let</span> size = calculateImageSize()</span><br><span class="line">        pictureWidthCons?.constant = size.viewSize.width</span><br><span class="line">        pictureHeightCons?.constant = size.viewSize.height</span><br><span class="line">        pictureLayout.itemSize = size.itemSize</span><br><span class="line">        pictureView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="创建StatusCellBottomView"><a href="#创建StatusCellBottomView" class="headerlink" title="创建StatusCellBottomView"></a>创建StatusCellBottomView</h4><p>工具条包含三个按钮</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> retweetBtn: <span class="type">UIButton</span> = <span class="type">UIButton</span>.createButton(imageName: <span class="string">"timeline_icon_retweet"</span>, title: <span class="string">"转发"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> unLikeBtn: <span class="type">UIButton</span> = <span class="type">UIButton</span>.createButton(imageName: <span class="string">"timeline_icon_unlike"</span>, title: <span class="string">"赞"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> commonBtn: <span class="type">UIButton</span> = <span class="type">UIButton</span>.createButton(imageName: <span class="string">"timeline_icon_comment"</span>, title: <span class="string">"评论"</span>)</span><br></pre></td></tr></table></figure>
<p>替换成StatusCellBottomView</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底部工具条</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> footerView: <span class="type">StatusCellBottomView</span> = <span class="type">StatusCellBottomView</span>()</span><br></pre></td></tr></table></figure>
<h4 id="创建StatusCellPictureView"><a href="#创建StatusCellPictureView" class="headerlink" title="创建StatusCellPictureView"></a>创建StatusCellPictureView</h4><p>设置数据，初始化（具体查看文件）<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> pictureLayout: <span class="type">UICollectionViewFlowLayout</span> = <span class="type">UICollectionViewFlowLayout</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">init</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: pictureLayout)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册cell</span></span><br><span class="line">    register(<span class="type">PictureViewCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kPictureViewCellId)</span><br><span class="line">    dataSource = <span class="keyword">self</span></span><br><span class="line">    <span class="comment">// 设置cell之间的间隙</span></span><br><span class="line">    pictureLayout.minimumLineSpacing = <span class="number">10</span></span><br><span class="line">    pictureLayout.minimumInteritemSpacing = <span class="number">10</span></span><br><span class="line">    <span class="comment">// 设置配图的背景颜色</span></span><br><span class="line">    backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>替换成StatusCellPictureView</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> pictureView:<span class="type">StatusCellPictureView</span> = <span class="type">StatusCellPictureView</span>()</span><br></pre></td></tr></table></figure>
<p>重构结束。。。</p>
<hr>
<h2 id="更新时间：2018-05-11-09-51-39"><a href="#更新时间：2018-05-11-09-51-39" class="headerlink" title="更新时间：2018-05-11 09:51:39"></a>更新时间：2018-05-11 09:51:39</h2><h3 id="转发微博"><a href="#转发微博" class="headerlink" title="转发微博"></a>转发微博</h3><p>转发与正常发布的cell样式有所不同，所以创建两个cell继承于基类cell（StatusTableViewCell）</p>
<h4 id="创建StatusNormalTableViewCell显示普通状态下的微博"><a href="#创建StatusNormalTableViewCell显示普通状态下的微博" class="headerlink" title="创建StatusNormalTableViewCell显示普通状态下的微博"></a>创建StatusNormalTableViewCell显示普通状态下的微博</h4><p>由于显示普通状态下的cell，基类已具备样式，所以只需要重写setupUI()方法，调整布局即可。（先把基类的setupUI()使用private声明去掉，不然重写不了, 因为调整配图的布局，把声明pictureView和contentLabel的private关键字也去掉）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatusNormalTableViewCell</span>: <span class="title">StatusTableViewCell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.setupUI()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cons = pictureView.xmg_AlignVertical(type: <span class="type">XMG_AlignType</span>.bottomLeft, referView: contentLabel, size: <span class="type">CGSize</span>.zero, offset: <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">        pictureWidthCons = pictureView.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.width)</span><br><span class="line">        pictureHeightCons = pictureView.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.height)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Status-swift"><a href="#Status-swift" class="headerlink" title="Status.swift"></a>Status.swift</h4><p>在Status.swift中声明两个属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 转发微博</span></span><br><span class="line"><span class="keyword">var</span> retweeted_status:<span class="type">Status</span>?</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 如果有转发，原创就没有配图</span></span><br><span class="line"><span class="comment">/// 定义一个计算属性，用于返回原创获取转发配图的URL数组</span></span><br><span class="line"><span class="keyword">var</span> pictureURLs:[<span class="type">NSURL</span>]? &#123;</span><br><span class="line">    <span class="keyword">return</span> retweeted_status != <span class="literal">nil</span> ? retweeted_status?.storedPicURLs : storedPicURLs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改相关方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/// 缓存微博图片</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">cacheStatusImages</span>(<span class="title">list</span>:[<span class="title">Status</span>], <span class="title">finishBlock</span>:@<span class="title">escaping</span> (<span class="title">_</span> <span class="title">models</span>:[<span class="title">Status</span>]?, <span class="title">_</span> <span class="title">error</span>:<span class="title">NSError</span>?) -&gt;()) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个数组</span></span><br><span class="line">    <span class="keyword">let</span> group = <span class="type">DispatchGroup</span>()</span><br><span class="line">    <span class="keyword">for</span> status <span class="keyword">in</span> list &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断当前微博是否有配图，没有就直接跳过</span></span><br><span class="line">        <span class="comment">//            if status.storedPicURLs == nil &#123;</span></span><br><span class="line">        <span class="comment">//                continue</span></span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新语法</span></span><br><span class="line">        <span class="comment">// 如果条件为nil，那么久会执行else后面的语句</span></span><br><span class="line">        <span class="comment">//            guard status.storedPicURLs != nil else &#123;</span></span><br><span class="line">        <span class="comment">//                continue</span></span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> <span class="number">_</span> = status.pictureURLs <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> status.pictureURLs! &#123;</span><br><span class="line">            <span class="comment">// 将当前的下载操作添加到组</span></span><br><span class="line">            group.enter()</span><br><span class="line"></span><br><span class="line">            <span class="type">SDWebImageManager</span>.shared().downloadImage(with: url <span class="keyword">as</span> <span class="type">URL</span>, options: <span class="type">SDWebImageOptions</span>(rawValue: <span class="number">0</span>), progress: <span class="literal">nil</span>) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">                <span class="comment">// 离开当前组</span></span><br><span class="line">                group.leave()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当所有图片都下载完毕再通过闭包通用调用者</span></span><br><span class="line">    group.notify(queue: <span class="type">DispatchQueue</span>.main) &#123;</span><br><span class="line">        <span class="comment">// 能够来到这个地方，一定是所有图片都下载完毕</span></span><br><span class="line">        finishBlock(list, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setValue</span><span class="params">(<span class="number">_</span> value: Any?, forKey key: String)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 判断当前是否给字典的user赋值</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"user"</span> == key &#123;</span><br><span class="line">        user = <span class="type">User</span>(dict: value <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"retweeted_status"</span> == key &#123;</span><br><span class="line">        retweeted_status = <span class="type">Status</span>(dict: value <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用父类的方法，按照系统默认处理</span></span><br><span class="line">    <span class="keyword">super</span>.setValue(value, forKey: key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建StatusForwardTableViewCell显示转发状态下的微博"><a href="#创建StatusForwardTableViewCell显示转发状态下的微博" class="headerlink" title="创建StatusForwardTableViewCell显示转发状态下的微博"></a>创建StatusForwardTableViewCell显示转发状态下的微博</h4><p>创建两个控件属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> foreardLabel: <span class="type">UILabel</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> label = <span class="type">UILabel</span>.createLabel(color: <span class="type">UIColor</span>.darkGray, fontSize: <span class="number">15</span>)</span><br><span class="line">    label.numberOfLines = <span class="number">0</span></span><br><span class="line">    label.preferredMaxLayoutWidth = <span class="type">UIScreen</span>.main.bounds.width - <span class="number">20</span></span><br><span class="line">    <span class="keyword">return</span> label</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> forwardButton: <span class="type">UIButton</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> btn = <span class="type">UIButton</span>()</span><br><span class="line">    btn.backgroundColor = <span class="type">UIColor</span>(white: <span class="number">0.9</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">    <span class="keyword">return</span> btn</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></p>
<p>重写setupUI()方法。（因为调整配图的布局，把声明footerView的private关键字去掉, 另外需要声明一个成员变量：var pictureTopCons:NSLayoutConstraint?（保存配图的顶部约束<br>））<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.setupUI()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加子控件</span></span><br><span class="line">    contentView.insertSubview(forwardButton, belowSubview: pictureView)</span><br><span class="line">    contentView.insertSubview(foreardLabel, aboveSubview: forwardButton)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 布局</span></span><br><span class="line">    forwardButton.xmg_AlignVertical(type: <span class="type">XMG_AlignType</span>.bottomLeft, referView: contentLabel, size: <span class="literal">nil</span>, offset: <span class="type">CGPoint</span>(x: -<span class="number">10</span>, y: <span class="number">10</span>))</span><br><span class="line">    forwardButton.xmg_AlignVertical(type: <span class="type">XMG_AlignType</span>.topRight, referView: footerView, size: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    foreardLabel.text = <span class="string">"上大号实打实大师"</span></span><br><span class="line">    foreardLabel.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.topLeft, referView: forwardButton, size: <span class="literal">nil</span>, offset: <span class="type">CGPoint</span>(x: <span class="number">10</span>, y: <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新调整配图</span></span><br><span class="line">    <span class="keyword">let</span> cons = pictureView.xmg_AlignVertical(type: <span class="type">XMG_AlignType</span>.bottomLeft, referView: foreardLabel, size: <span class="type">CGSize</span>(width: <span class="number">290</span>, height: <span class="number">290</span>), offset: <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    pictureWidthCons = pictureView.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.width)</span><br><span class="line">    pictureHeightCons = pictureView.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.height)</span><br><span class="line">    pictureTopCons = pictureView.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.top)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重写status属性，设置相关数据</p>
<ul>
<li>重写父类的属性的didSet并不会阀盖父类的操作</li>
<li>只需要在重写方法中，做自己想做的事情即可</li>
<li>注意点：如果父类是didSet，那么子类重写也只能重写didSet<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">重写父类的属性的didSet并不会阀盖父类的操作</span><br><span class="line">只需要在重写方法中，做自己想做的事情即可</span><br><span class="line">注意点：如果父类是didSet，那么子类重写也只能重写didSet</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> status: <span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> name = status?.retweeted_status?.user?.name ?? <span class="string">""</span></span><br><span class="line">        <span class="keyword">let</span> text = status?.retweeted_status?.text ?? <span class="string">""</span></span><br><span class="line">        foreardLabel.text = name + <span class="string">":"</span> + text</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="创建切换不同cell的标记"><a href="#创建切换不同cell的标记" class="headerlink" title="创建切换不同cell的标记"></a>创建切换不同cell的标记</h4><p>在StatusTableViewCell.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">保存cell的重用标志</span><br><span class="line"></span><br><span class="line">NormalCell：原创微博的重用标志</span><br><span class="line">ForwardCell：转发微博的重用标志</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">StatusTableViewCellIdentifier</span>:<span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">NormalCell</span> = <span class="string">"NormalCell"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">ForwardCell</span> = <span class="string">"ForwardCell"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    如果在枚举中利用static修饰一个方法，相当于类中的class修饰方法</span><br><span class="line">    如果调用枚举值的rawValue，那么意味着拿到枚举对应的原始值</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">cellID</span><span class="params">(status:Status)</span></span> -&gt;<span class="type">String</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> status.retweeted_status != <span class="literal">nil</span> ? <span class="type">ForwardCell</span>.rawValue : <span class="type">NormalCell</span>.rawValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="完善StatusCellPictureView-swift"><a href="#完善StatusCellPictureView-swift" class="headerlink" title="完善StatusCellPictureView.swift"></a>完善StatusCellPictureView.swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算配图的尺寸</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculateImageSize</span><span class="params">()</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">    <span class="comment">// 取出配图个数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = status?.storedPicURLs?.<span class="built_in">count</span></span><br><span class="line">    <span class="comment">// 如果没有配图zero</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">0</span> || <span class="built_in">count</span> == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>.zero</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果只有一张配图，返回图片的实际大小</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// 取出缓存的图片</span></span><br><span class="line">        <span class="keyword">let</span> key = status?.storedPicURLs?.first?.absoluteString</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">SDWebImageManager</span>.shared().imageCache.imageFromDiskCache(forKey: key!)</span><br><span class="line">        pictureLayout.itemSize = image!.size</span><br><span class="line">        <span class="keyword">return</span> image!.size</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有4张配图，计算字格的大小</span></span><br><span class="line">    <span class="keyword">let</span> width = <span class="number">90</span></span><br><span class="line">    <span class="keyword">let</span> margin = <span class="number">10</span></span><br><span class="line">    pictureLayout.itemSize = <span class="type">CGSize</span>(width: width, height: width)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> == <span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewWidth = width * <span class="number">2</span> + margin</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>(width: viewWidth, height: viewWidth)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是其他（多张），计算九宫格的大小</span></span><br><span class="line">    <span class="keyword">let</span> colNumber = <span class="number">3</span></span><br><span class="line">    <span class="keyword">let</span> rowNumber = (<span class="built_in">count</span>! - <span class="number">1</span>) / <span class="number">3</span> + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> viewWidth = colNumber * width + (colNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">let</span> viewHeight = rowNumber * width + (rowNumber - <span class="number">1</span>) * margin</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGSize</span>(width: viewWidth, height: viewHeight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="完善HomeTableViewController-swift"><a href="#完善HomeTableViewController-swift" class="headerlink" title="完善HomeTableViewController.swift"></a>完善HomeTableViewController.swift</h4><p>注册两个cell<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tableView.register(<span class="type">StatusTableViewCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.<span class="type">NormalCell</span>.rawValue)</span><br><span class="line">tableView.register(<span class="type">StatusTableViewCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.<span class="type">ForwardCell</span>.rawValue)</span><br></pre></td></tr></table></figure></p>
<p>代理方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> status = statuses![indexPath.row]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.cellID(status: status), <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">StatusTableViewCell</span></span><br><span class="line">    cell.status = status</span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, heightForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">    <span class="comment">// 取出对应的模型</span></span><br><span class="line">    <span class="keyword">let</span> status = statuses![indexPath.row]</span><br><span class="line">    <span class="comment">// 判断缓存中有没有</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> height = rowCache[status.id] &#123;</span><br><span class="line">        <span class="keyword">return</span> height</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到cell</span></span><br><span class="line">    <span class="comment">//        let cell = tableView.dequeueReusableCell(withIdentifier: kHomeCellReuseIdentifier) as! StatusTableViewCell</span></span><br><span class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.cellID(status: status)) <span class="keyword">as</span>! <span class="type">StatusTableViewCell</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到行高</span></span><br><span class="line">    <span class="keyword">let</span> rowHeight = cell.rowHeight(status: status)</span><br><span class="line">    <span class="comment">// 缓存行高</span></span><br><span class="line">    rowCache[status.id] = rowHeight</span><br><span class="line">    <span class="keyword">return</span> rowHeight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转发功能完成。</p>
<h3 id="下拉刷新"><a href="#下拉刷新" class="headerlink" title="下拉刷新"></a>下拉刷新</h3><h4 id="添加刷新控件"><a href="#添加刷新控件" class="headerlink" title="添加刷新控件"></a>添加刷新控件</h4><p>在Profile添加<code>pod &#39;MJRefresh&#39;</code>,然后<code>pod install</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> weakSelf = <span class="keyword">self</span></span><br><span class="line">tableView.mj_header = <span class="type">MJRefreshNormalHeader</span>(refreshingBlock: &#123;</span><br><span class="line">    weakSelf?.loadData()</span><br><span class="line">&#125;)</span><br><span class="line">tableView.mj_footer = <span class="type">MJRefreshBackNormalFooter</span>(refreshingBlock: &#123;</span><br><span class="line">    weakSelf?.loadData()</span><br><span class="line">&#125;)</span><br><span class="line">tableView.mj_header.beginRefreshing()</span><br></pre></td></tr></table></figure>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>处理加载微博数据上拉还是下拉</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 定义变量记录当时上拉还是下拉</span></span><br><span class="line"><span class="keyword">var</span> pullupRefreshFalg = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 加载数据</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">loadData</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    1、默认最新返回20条数据</span><br><span class="line">    2、since_id: 会返回比since_id大的微博</span><br><span class="line">    3、max_id:会返回小鱼等于max_id的微博</span><br><span class="line"></span><br><span class="line">    每条微博都有一个微博id,而且微博ID越后面发送的微博，他的微博ID越大</span><br><span class="line">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> since_id = statuses?.first?.id ?? <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> max_id = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 判断是否上拉</span></span><br><span class="line">    <span class="keyword">if</span> pullupRefreshFalg &#123;</span><br><span class="line">        since_id = <span class="number">0</span></span><br><span class="line">        max_id = statuses?.last?.id ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> weakSelf = <span class="keyword">self</span></span><br><span class="line">    <span class="type">Status</span>.loadStatuses(since_id:since_id, max_id:max_id) &#123; (models, error) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">        weakSelf?.tableView.mj_header.endRefreshing()</span><br><span class="line">        weakSelf?.tableView.mj_footer.endRefreshing()</span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="type">SVProgressHUD</span>.showError(withStatus: <span class="string">"服务器错误"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> since_id &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// 下拉刷新</span></span><br><span class="line">            weakSelf?.statuses = models! + (weakSelf?.statuses!)!</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> max_id &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// 如果是上拉加载更多，将数据取到的数据拼在原有的数据后面</span></span><br><span class="line">            weakSelf?.statuses = (weakSelf?.statuses!)! + models!</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            weakSelf?.statuses = models</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断是上拉还是下拉</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tableView.mj_header = <span class="type">MJRefreshNormalHeader</span>(refreshingBlock: &#123;</span><br><span class="line">    weakSelf?.pullupRefreshFalg = <span class="literal">false</span></span><br><span class="line">    weakSelf?.loadData()</span><br><span class="line">&#125;)</span><br><span class="line">tableView.mj_footer = <span class="type">MJRefreshBackNormalFooter</span>(refreshingBlock: &#123;</span><br><span class="line">    weakSelf?.pullupRefreshFalg = <span class="literal">true</span></span><br><span class="line">    weakSelf?.loadData()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-16-15-09-32"><a href="#更新时间：2018-05-16-15-09-32" class="headerlink" title="更新时间：2018-05-16 15:09:32"></a>更新时间：2018-05-16 15:09:32</h2><h3 id="修改BaseViewController继承UIViewController"><a href="#修改BaseViewController继承UIViewController" class="headerlink" title="修改BaseViewController继承UIViewController"></a>修改BaseViewController继承UIViewController</h3><p>继承BaseViewController分别修改，首页创建UItableview</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> tableView: <span class="type">UITableView</span>! = &#123;</span><br><span class="line">    <span class="keyword">let</span> view = <span class="type">UITableView</span>(frame: <span class="type">CGRect</span>.zero, style: <span class="type">UITableViewStyle</span>.plain)</span><br><span class="line">    view.dataSource = <span class="keyword">self</span></span><br><span class="line">    view.delegate = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">// 注册cell</span></span><br><span class="line">    view.register(<span class="type">StatusTableViewCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.<span class="type">NormalCell</span>.rawValue)</span><br><span class="line">    view.register(<span class="type">StatusTableViewCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">StatusTableViewCellIdentifier</span>.<span class="type">ForwardCell</span>.rawValue)</span><br><span class="line">    view.separatorStyle = <span class="type">UITableViewCellSeparatorStyle</span>.<span class="keyword">none</span></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> weakSelf = <span class="keyword">self</span></span><br><span class="line">    view.mj_header = <span class="type">MJRefreshNormalHeader</span>(refreshingBlock: &#123;</span><br><span class="line">        weakSelf?.pullupRefreshFalg = <span class="literal">false</span></span><br><span class="line">        weakSelf?.loadData()</span><br><span class="line">    &#125;)</span><br><span class="line">    view.mj_footer = <span class="type">MJRefreshBackNormalFooter</span>(refreshingBlock: &#123;</span><br><span class="line">        weakSelf?.pullupRefreshFalg = <span class="literal">true</span></span><br><span class="line">        weakSelf?.loadData()</span><br><span class="line">    &#125;)</span><br><span class="line">    view.mj_header.beginRefreshing()</span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h3 id="显示刷新提醒"><a href="#显示刷新提醒" class="headerlink" title="显示刷新提醒"></a>显示刷新提醒</h3><h4 id="创建显示文本"><a href="#创建显示文本" class="headerlink" title="创建显示文本"></a>创建显示文本</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> newStatusLabel: <span class="type">UILabel</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">    label.backgroundColor = <span class="type">UIColor</span>.orange</span><br><span class="line">    label.textColor = <span class="type">UIColor</span>.white</span><br><span class="line">    label.textAlignment = <span class="type">NSTextAlignment</span>.center</span><br><span class="line">    label.frame = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="type">UIScreen</span>.main.bounds.size.width, height: <span class="number">44</span>)</span><br><span class="line">    <span class="comment">// 加到导航栏上</span></span><br><span class="line">    <span class="keyword">self</span>.navigationController?.navigationBar.insertSubview(label, at: <span class="number">0</span>)</span><br><span class="line">    label.isHidden = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> label</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h4 id="展示文本方法"><a href="#展示文本方法" class="headerlink" title="展示文本方法"></a>展示文本方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">showNewStatusCount</span><span class="params">(<span class="built_in">count</span>:Int)</span></span>&#123;</span><br><span class="line">    newStatusLabel.isHidden = <span class="literal">false</span></span><br><span class="line">    newStatusLabel.text = (<span class="built_in">count</span> == <span class="number">0</span>) ? <span class="string">"没有刷新到新的微博数据"</span> : <span class="string">"已更新\(count)条数据"</span></span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: <span class="number">2</span>, animations: &#123;</span><br><span class="line">        <span class="keyword">self</span>.newStatusLabel.transform = <span class="type">CGAffineTransform</span>(translationX: <span class="number">0</span>, y: <span class="keyword">self</span>.newStatusLabel.frame.size.height)</span><br><span class="line">    &#125;) &#123; (finish) <span class="keyword">in</span></span><br><span class="line">        <span class="type">UIView</span>.animate(withDuration: <span class="number">2</span>, animations: &#123;</span><br><span class="line">            <span class="keyword">self</span>.newStatusLabel.transform = <span class="type">CGAffineTransform</span>.identity</span><br><span class="line">        &#125;, completion: &#123; (<span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.newStatusLabel.isHidden = <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调用展示方法"><a href="#调用展示方法" class="headerlink" title="调用展示方法"></a>调用展示方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示刷新提醒</span></span><br><span class="line">weakSelf?.showNewStatusCount(<span class="built_in">count</span>: models?.<span class="built_in">count</span> ?? <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="浏览大图"><a href="#浏览大图" class="headerlink" title="浏览大图"></a>浏览大图</h3><h4 id="获取大图"><a href="#获取大图" class="headerlink" title="获取大图"></a>获取大图</h4><p>在Status.swift中声明storeLargePictureURLs属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 配图数组</span></span><br><span class="line"><span class="keyword">var</span> pic_urls: [[<span class="type">String</span>:<span class="type">AnyObject</span>]]? &#123;</span><br><span class="line">    <span class="keyword">didSet</span> &#123;</span><br><span class="line">        <span class="comment">// 判断数组中是否有数据 nil</span></span><br><span class="line">        <span class="keyword">if</span> pic_urls?.<span class="built_in">count</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        storedPicURLs = [<span class="type">NSURL</span>]()</span><br><span class="line">        storeLargePictureURLs = [<span class="type">NSURL</span>]()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> dict <span class="keyword">in</span> pic_urls! &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> urlStr = dict[<span class="string">"thumbnail_pic"</span>]&#123;</span><br><span class="line">                <span class="comment">// 将字符串转为URL保存到数组中</span></span><br><span class="line">                <span class="comment">// 生成小图</span></span><br><span class="line">                storedPicURLs?.append(<span class="type">NSURL</span>(string: urlStr <span class="keyword">as</span>! <span class="type">String</span>)!)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成大图</span></span><br><span class="line">                <span class="keyword">let</span> largeUrlStr = urlStr.replacingOccurrences(of: <span class="string">"thumbnail"</span>, with: <span class="string">"large"</span>)</span><br><span class="line">                storeLargePictureURLs?.append(<span class="type">NSURL</span>(string: largeUrlStr)!)</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 保存当前微博所有配图的URL</span></span><br><span class="line"><span class="keyword">var</span> storedPicURLs:[<span class="type">NSURL</span>]?</span><br><span class="line"><span class="comment">/// 保存配图的大图URL数组</span></span><br><span class="line"><span class="keyword">var</span> storeLargePictureURLs: [<span class="type">NSURL</span>]?</span><br><span class="line"><span class="keyword">var</span> largePictureURLs: [<span class="type">NSURL</span>]? &#123;</span><br><span class="line">    <span class="keyword">return</span> retweeted_status == <span class="literal">nil</span> ? storeLargePictureURLs : retweeted_status?.storeLargePictureURLs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="获取当前点击图片"><a href="#获取当前点击图片" class="headerlink" title="获取当前点击图片"></a>获取当前点击图片</h4><p>在StatusCellPictureView.swift中实现UICollectionViewDelegate代理方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 拿到当前点击图片</span></span><br><span class="line">    <span class="built_in">print</span>(status?.pictureURLs![indexPath.item])</span><br><span class="line">    <span class="built_in">print</span>(status?.storedPicURLs![indexPath.item])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建浏览器"><a href="#创建浏览器" class="headerlink" title="创建浏览器"></a>创建浏览器</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoBrowserViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 图片数组</span></span><br><span class="line">    <span class="keyword">var</span> imageUrls: [<span class="type">NSURL</span>]?</span><br><span class="line">    <span class="comment">/// 用户选中的图片索引</span></span><br><span class="line">    <span class="keyword">var</span> currentIndex: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(urls:[<span class="type">NSURL</span>], index:<span class="type">Int</span>) &#123;</span><br><span class="line">        imageUrls = urls</span><br><span class="line">        currentIndex = index</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        view.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">        setupUI()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        view.addSubview(collectionView)</span><br><span class="line">        view.addSubview(closeBtn)</span><br><span class="line">        view.addSubview(saveBtn)</span><br><span class="line"></span><br><span class="line">        closeBtn.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.bottomLeft, referView: view, size: <span class="type">CGSize</span>(width: <span class="number">100</span>, height: <span class="number">32</span>), offset: <span class="type">CGPoint</span>(x: <span class="number">8</span>, y: -<span class="number">8</span>))</span><br><span class="line">        saveBtn.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.bottomRight, referView: view, size: <span class="type">CGSize</span>(width: <span class="number">100</span>, height: <span class="number">32</span>), offset: <span class="type">CGPoint</span>(x: <span class="number">8</span>, y: -<span class="number">8</span>))</span><br><span class="line">        collectionView.frame = <span class="type">UIScreen</span>.main.bounds</span><br><span class="line"></span><br><span class="line">        saveBtn.addTarget(<span class="keyword">self</span>, action: #selector(save), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line">        closeBtn.addTarget(<span class="keyword">self</span>, action: #selector(close), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">        dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">save</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"保存图片"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> closeBtn: <span class="type">UIButton</span> = <span class="type">UIButton</span>(tittle: <span class="string">"关闭"</span>, fontSize: <span class="number">14</span>, color: <span class="type">UIColor</span>.white, backColor: <span class="type">UIColor</span>.darkGray)</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> saveBtn: <span class="type">UIButton</span> = <span class="type">UIButton</span>(tittle: <span class="string">"保存"</span>, fontSize: <span class="number">14</span>, color: <span class="type">UIColor</span>.white, backColor: <span class="type">UIColor</span>.darkGray)</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> collectionView = <span class="type">UICollectionView</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: <span class="type">UICollectionViewFlowLayout</span>())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加通知"><a href="#添加通知" class="headerlink" title="添加通知"></a>添加通知</h4><p>在StatusCellPictureView.swift声明三个通知字段<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 选中照片通知</span></span><br><span class="line"><span class="keyword">let</span> kStatusCellSelectPictureNotify = <span class="string">"kStatusCellSelectPictureNotify"</span></span><br><span class="line"><span class="comment">/// 照片的URL</span></span><br><span class="line"><span class="keyword">let</span> kStatusCellSelectPictureURLNotify = <span class="string">"kStatusCellSelectPictureURLNotify"</span></span><br><span class="line"><span class="comment">/// 照片的index</span></span><br><span class="line"><span class="keyword">let</span> kStatusCellSelectPictureIndexNotify = <span class="string">"kStatusCellSelectPictureIndexNotify"</span></span><br></pre></td></tr></table></figure></p>
<p>在HomeTableViewController.swift<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加通知</span></span><br><span class="line"><span class="type">NotificationCenter</span>.<span class="keyword">default</span>.addObserver(<span class="keyword">self</span>, selector: #selector(selectPicture(notify:)), name: <span class="type">NSNotification</span>.<span class="type">Name</span>(rawValue: kStatusCellSelectPictureNotify), object: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure></p>
<p>并实现监听方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectPicture</span><span class="params">(notify:Notification)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取参数。提示：从自定义通知获取参数，一定记住检查参数值</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> urls = notify.userInfo![kStatusCellSelectPictureURLNotify] <span class="keyword">as</span>? [<span class="type">NSURL</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"url数组不存在"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> indexPath = notify.userInfo![kStatusCellSelectPictureIndexNotify] <span class="keyword">as</span>? <span class="type">NSIndexPath</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"indexPath不存在"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> vc = <span class="type">PhotoBrowserViewController</span>(urls: urls, index: indexPath.item)</span><br><span class="line">    present(vc, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在StatusCellPictureView.swift中点击照片的时候发出通知</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 拿到当前点击图片</span></span><br><span class="line">    <span class="comment">//        print(status?.pictureURLs![indexPath.item])</span></span><br><span class="line">    <span class="comment">//        print(status?.storedPicURLs![indexPath.item])</span></span><br><span class="line"></span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(name: <span class="type">NSNotification</span>.<span class="type">Name</span>(rawValue: kStatusCellSelectPictureNotify), object: <span class="keyword">self</span>, userInfo: [kStatusCellSelectPictureURLNotify:status!.storeLargePictureURLs!, kStatusCellSelectPictureIndexNotify:indexPath])</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="显示大图"><a href="#显示大图" class="headerlink" title="显示大图"></a>显示大图</h4><h5 id="创建PhotoBrowserCell"><a href="#创建PhotoBrowserCell" class="headerlink" title="创建PhotoBrowserCell"></a>创建PhotoBrowserCell</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoBrowserCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图片的URL</span></span><br><span class="line">    <span class="keyword">var</span> imageURL: <span class="type">NSURL</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span>&#123;</span><br><span class="line"></span><br><span class="line">            imageView.sd_setImage(with: imageURL <span class="keyword">as</span> <span class="type">URL</span>?, placeholderImage: <span class="literal">nil</span>, options: <span class="type">SDWebImageOptions</span>.retryFailed) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.imageView.sizeToFit()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">        setupUI()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        contentView.addSubview(scrollView)</span><br><span class="line">        scrollView.addSubview(imageView)</span><br><span class="line"></span><br><span class="line">        scrollView.frame = <span class="type">UIScreen</span>.main.bounds</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> scrollView = <span class="type">UIScrollView</span>()</span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> imageView = <span class="type">UIImageView</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h5><p>注册cell</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册cell</span></span><br><span class="line">collectionView.dataSource = <span class="keyword">self</span></span><br><span class="line">collectionView.register(<span class="type">PhotoBrowserCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kCellReuseIdentifier)</span><br></pre></td></tr></table></figure>
<p>实现数据源方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PhotoBrowserViewController</span>: <span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> imageUrls!.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">PhotoBrowserCell</span></span><br><span class="line">        cell.imageURL = imageUrls![indexPath.item]</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建布局</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoBrowserLayout</span>: <span class="title">UICollectionViewFlowLayout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">()</span></span> &#123;</span><br><span class="line">        itemSize = <span class="type">UIScreen</span>.main.bounds.size</span><br><span class="line">        minimumLineSpacing = <span class="number">0</span></span><br><span class="line">        minimumInteritemSpacing = <span class="number">0</span></span><br><span class="line">        scrollDirection = <span class="type">UICollectionViewScrollDirection</span>.horizontal</span><br><span class="line">        collectionView?.isPagingEnabled = <span class="literal">true</span></span><br><span class="line">        collectionView?.showsHorizontalScrollIndicator = <span class="literal">false</span></span><br><span class="line">        collectionView?.bounces = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="点击图片指定位置展示"><a href="#点击图片指定位置展示" class="headerlink" title="点击图片指定位置展示"></a>点击图片指定位置展示</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 滚动到指定位置</span></span><br><span class="line"><span class="keyword">let</span> indexPath = <span class="type">IndexPath</span>(item: currentIndex, section: <span class="number">0</span>)</span><br><span class="line">collectionView.scrollToItem(at: indexPath, at: <span class="type">UICollectionViewScrollPosition</span>.<span class="keyword">left</span>, animated: <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%A6%96%E9%A1%B5%E6%B5%8F%E8%A7%88%E5%A4%A7%E5%9B%BE1.gif" alt="image"></p>
<hr>
<h2 id="更新时间：2018-05-17-16-13-21"><a href="#更新时间：2018-05-17-16-13-21" class="headerlink" title="更新时间：2018-05-17 16:13:21"></a>更新时间：2018-05-17 16:13:21</h2><h3 id="长短图计算"><a href="#长短图计算" class="headerlink" title="长短图计算"></a>长短图计算</h3><p>计算显示的图像尺寸</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算显示的图像尺寸，以scrollview的宽度为准</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">displaySize</span><span class="params">(image:UIImage)</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">    <span class="comment">// 图像宽高比</span></span><br><span class="line">    <span class="keyword">let</span> scale = image.size.height / image.size.width</span><br><span class="line">    <span class="keyword">let</span> height = scale * scrollView.bounds.size.width</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGSize</span>(width: scrollView.bounds.size.width, height: height)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化位置</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupImagePosition</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> size = <span class="keyword">self</span>.displaySize(image: imageView.image!)</span><br><span class="line">    <span class="comment">// 图像高度比视图高度小，短图</span></span><br><span class="line">    <span class="keyword">if</span> size.height &lt; scrollView.bounds.size.height &#123;</span><br><span class="line">        <span class="comment">// 垂直居中</span></span><br><span class="line">        <span class="keyword">let</span> y = (scrollView.bounds.size.height - size.height) * <span class="number">0.5</span></span><br><span class="line">        imageView.frame = <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>.zero, size: size)</span><br><span class="line">        <span class="comment">// 设置间距，能够保证缩放完成后，同样能够显示完整画面</span></span><br><span class="line">        scrollView.contentInset = <span class="type">UIEdgeInsetsMake</span>(y, <span class="number">0</span>, y, <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 长图</span></span><br><span class="line">        imageView.frame = <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>.zero, size: size)</span><br><span class="line">        scrollView.contentSize = size</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片的URL</span></span><br><span class="line"><span class="keyword">var</span> imageURL: <span class="type">NSURL</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line"></span><br><span class="line">        imageView.sd_setImage(with: imageURL <span class="keyword">as</span> <span class="type">URL</span>?, placeholderImage: <span class="literal">nil</span>, options: <span class="type">SDWebImageOptions</span>.retryFailed) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.setupImagePosition()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缩放图片"><a href="#缩放图片" class="headerlink" title="缩放图片"></a>缩放图片</h3><p>重设scrollview的偏移属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 重设scrollview的偏移属性</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">resetScrollView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    imageView.transform = <span class="type">CGAffineTransform</span>.identity</span><br><span class="line">    scrollView.contentInset = <span class="type">UIEdgeInsets</span>.zero</span><br><span class="line">    scrollView.contentOffset = <span class="type">CGPoint</span>.zero</span><br><span class="line">    scrollView.contentSize = <span class="type">CGSize</span>.zero</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加载图片前重设偏移属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">·<span class="comment">// 图片的URL</span></span><br><span class="line"><span class="keyword">var</span> imageURL: <span class="type">NSURL</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// 重设scrollview</span></span><br><span class="line">        resetScrollView()</span><br><span class="line"></span><br><span class="line">        imageView.sd_setImage(with: imageURL <span class="keyword">as</span> <span class="type">URL</span>?, placeholderImage: <span class="literal">nil</span>, options: <span class="type">SDWebImageOptions</span>.retryFailed) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.setupImagePosition()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>遵循UIScrollViewDelegate</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> scrollView: <span class="type">UIScrollView</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> view = <span class="type">UIScrollView</span>()</span><br><span class="line">    view.delegate = <span class="keyword">self</span></span><br><span class="line">    <span class="comment">// 最大/最小缩放比例</span></span><br><span class="line">    view.minimumZoomScale = <span class="number">0.5</span></span><br><span class="line">    view.maximumZoomScale = <span class="number">2.0</span></span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>实现相关UIScrollViewDelegate方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PhotoBrowserCell</span>: <span class="title">UIScrollViewDelegate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 告诉scrollview要缩放的控件</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">viewForZooming</span><span class="params">(<span class="keyword">in</span> scrollView: UIScrollView)</span></span> -&gt; <span class="type">UIView</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> imageView</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    在缩放完成后，会被调用一次</span><br><span class="line">    view：被缩放的view</span><br><span class="line">    scale：缩放完成后的缩放比例</span><br><span class="line">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndZooming</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView, with view: UIView?, atScale scale: CGFloat)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 重新计算间距</span></span><br><span class="line">        <span class="comment">// 通过transform改变view的缩放，bound本身没有变化，frame会变化</span></span><br><span class="line">        <span class="keyword">var</span> offsetX = (scrollView.bounds.width - view!.frame.size.width) * <span class="number">0.5</span></span><br><span class="line">        <span class="comment">// 如果边距小于0，需要修正</span></span><br><span class="line">        offsetX = offsetX &lt; <span class="number">0</span> ? <span class="number">0</span> : offsetX</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> offsetY = (scrollView.bounds.size.height - view!.frame.size.height) * <span class="number">0.5</span></span><br><span class="line">        offsetY = offsetY &lt; <span class="number">0</span> ? <span class="number">0</span> : offsetY</span><br><span class="line"></span><br><span class="line">        scrollView.contentInset = <span class="type">UIEdgeInsetsMake</span>(offsetY, offsetX, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示菊花"><a href="#显示菊花" class="headerlink" title="显示菊花"></a>显示菊花</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 菊花</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> indicator = <span class="type">UIActivityIndicatorView</span>(activityIndicatorStyle: <span class="type">UIActivityIndicatorViewStyle</span>.white)</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片的URL</span></span><br><span class="line"><span class="keyword">var</span> imageURL: <span class="type">NSURL</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.indicator.startAnimating()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重设scrollview</span></span><br><span class="line">        resetScrollView()</span><br><span class="line"></span><br><span class="line">        imageView.sd_setImage(with: imageURL <span class="keyword">as</span> <span class="type">URL</span>?, placeholderImage: <span class="literal">nil</span>, options: <span class="type">SDWebImageOptions</span>.retryFailed) &#123; (<span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.indicator.stopAnimating()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.setupImagePosition()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示gif图标"><a href="#显示gif图标" class="headerlink" title="显示gif图标"></a>显示gif图标</h3><p>在StatusCellPictureView.swift中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PictureViewCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> imageUrl:<span class="type">NSURL</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span>&#123;</span><br><span class="line">            iconView.sd_setImage(with: imageUrl! <span class="keyword">as</span> <span class="type">URL</span>?)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置时候显示gif图标</span></span><br><span class="line">            gifImageView.isHidden = ((imageUrl!.absoluteString! <span class="keyword">as</span> <span class="type">NSString</span>).pathExtension.lowercased() != <span class="string">"gif"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">        contentView.addSubview(iconView)</span><br><span class="line">        contentView.addSubview(gifImageView)</span><br><span class="line"></span><br><span class="line">        iconView.xmg_Fill(contentView)</span><br><span class="line">        gifImageView.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.bottomRight, referView: iconView, size: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> iconView = <span class="type">UIImageView</span> ()</span><br><span class="line">        <span class="built_in">lazy</span> <span class="keyword">var</span> gifImageView: <span class="type">UIImageView</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> view = <span class="type">UIImageView</span>()</span><br><span class="line">        view.image = <span class="type">UIImage</span>(named: <span class="string">"timeline_image_gif"</span>)</span><br><span class="line">        view.isHidden = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> view</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="关闭浏览器"><a href="#关闭浏览器" class="headerlink" title="关闭浏览器"></a>关闭浏览器</h3><p>PhotoBrowserCell.swift</p>
<p>添加手势</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加imageView手势监听</span></span><br><span class="line"><span class="keyword">let</span> tap = <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: #selector(clickImageView))</span><br><span class="line">imageView.addGestureRecognizer(tap)</span><br><span class="line">imageView.isUserInteractionEnabled = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>声明代理</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PhotoBrowserCellDelegate</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 结束缩放</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoBrowserCellDidTapImageView</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>声明代理属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明代理属性</span></span><br><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> photoDelegate:<span class="type">PhotoBrowserCellDelegate</span>?</span><br></pre></td></tr></table></figure>
<p>在PhotoBrowserViewController类中实现PhotoBrowserCellDelegate</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PhotoBrowserViewController</span>: <span class="title">UICollectionViewDataSource</span>, <span class="title">PhotoBrowserCellDelegate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> imageUrls!.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">PhotoBrowserCell</span></span><br><span class="line">        cell.imageURL = imageUrls![indexPath.item]</span><br><span class="line">        cell.backgroundColor = <span class="type">UIColor</span>.randomColor()</span><br><span class="line">        cell.photoDelegate = <span class="keyword">self</span></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - PhotoBrowserCellDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoBrowserCellDidTapImageView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-18-10-19-39"><a href="#更新时间：2018-05-18-10-19-39" class="headerlink" title="更新时间：2018-05-18 10:19:39"></a>更新时间：2018-05-18 10:19:39</h2><h3 id="添加表情数据包"><a href="#添加表情数据包" class="headerlink" title="添加表情数据包"></a>添加表情数据包</h3><p>可在工程上找<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%981.png" alt="image"></p>
<h3 id="表情控制器"><a href="#表情控制器" class="headerlink" title="表情控制器"></a>表情控制器</h3><p>主要控件</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - 懒加载</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> toolBar = <span class="type">UIToolbar</span>()</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> collectionView = <span class="type">UICollectionView</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: <span class="type">UICollectionViewFlowLayout</span>())</span><br></pre></td></tr></table></figure>
<p>初始化工具条</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupToolbar</span><span class="params">()</span></span> &#123;</span><br><span class="line">    toolBar.tintColor = <span class="type">UIColor</span>.darkGray</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">UIBarButtonItem</span>]()</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> str <span class="keyword">in</span> [<span class="string">"最近"</span>, <span class="string">"默认"</span>, <span class="string">"emoji"</span>, <span class="string">"浪小花"</span>] &#123;</span><br><span class="line">        <span class="keyword">let</span> item = <span class="type">UIBarButtonItem</span>(title: str, style: <span class="type">UIBarButtonItemStyle</span>.plain, target: <span class="keyword">self</span>, action: #selector(clickItem(item:)))</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">        item.tag = index</span><br><span class="line">        items.append(item)</span><br><span class="line">        items.append(<span class="type">UIBarButtonItem</span>(barButtonSystemItem: <span class="type">UIBarButtonSystemItem</span>.flexibleSpace, target: <span class="literal">nil</span>, action: <span class="literal">nil</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    items.removeLast()</span><br><span class="line">    toolBar.items = items</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="布局CollectionView界面"><a href="#布局CollectionView界面" class="headerlink" title="布局CollectionView界面"></a>布局CollectionView界面</h3><h4 id="设置layout"><a href="#设置layout" class="headerlink" title="设置layout"></a>设置layout</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">EmoticonLayout</span>: <span class="title">UICollectionViewFlowLayout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.prepare()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> width = collectionView!.bounds.size.width / <span class="number">7</span></span><br><span class="line">        itemSize = <span class="type">CGSize</span>(width: width, height: width)</span><br><span class="line">        minimumLineSpacing = <span class="number">0</span></span><br><span class="line">        minimumInteritemSpacing = <span class="number">0</span></span><br><span class="line">        scrollDirection = <span class="type">UICollectionViewScrollDirection</span>.horizontal</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由于不CGFloat准确，所以不要写0.5，可能出现只显示2</span></span><br><span class="line">        <span class="keyword">let</span> y = (collectionView!.bounds.size.height - <span class="number">3</span> * width) * <span class="number">0.45</span></span><br><span class="line">        collectionView?.contentInset = <span class="type">UIEdgeInsetsMake</span>(y, <span class="number">0</span>, y, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        collectionView?.isPagingEnabled = <span class="literal">true</span></span><br><span class="line">        collectionView?.bounces = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建EmoticonCell"><a href="#创建EmoticonCell" class="headerlink" title="创建EmoticonCell"></a>创建EmoticonCell</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmoticonCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">        contentView.addSubview(emoticonBtn)</span><br><span class="line">        emoticonBtn.frame = bounds.insetBy(dx: <span class="number">4</span>, dy: <span class="number">4</span>)</span><br><span class="line">        emoticonBtn.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> emoticonBtn = <span class="type">UIButton</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置collectionView"><a href="#设置collectionView" class="headerlink" title="设置collectionView"></a>设置collectionView</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupCollectionView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    collectionView.register(<span class="type">EmoticonCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kEmoticonCellReuseIdentifier)</span><br><span class="line">    collectionView.dataSource = <span class="keyword">self</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现数据源方法"><a href="#实现数据源方法" class="headerlink" title="实现数据源方法"></a>实现数据源方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">EmoticonViewController</span>: <span class="title">UICollectionViewDataSource</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">21</span> * <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kEmoticonCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">EmoticonCell</span></span><br><span class="line">        cell.backgroundColor = (indexPath.item % <span class="number">2</span> == <span class="number">0</span>) ? <span class="type">UIColor</span>.red : <span class="type">UIColor</span>.blue</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%982.png" alt="image"></p>
<h3 id="加载数据模型准备"><a href="#加载数据模型准备" class="headerlink" title="加载数据模型准备"></a>加载数据模型准备</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">说明：</span><br><span class="line">1、Emoticons.bundle的根目录下存放emoticons.plist保存了packages表情包信息</span><br><span class="line">&gt; package是一个数组，数组中存放的是字典</span><br><span class="line">&gt; 字典中的属性id对应的分组路径的名称</span><br><span class="line">2、在id对应的目录下，各自都保存有info.plist</span><br><span class="line">&gt; group_name_cn     保存的是分组名称</span><br><span class="line">&gt; emoticons         保存的是表情信息数组</span><br><span class="line">&gt; code              UNICODE编码字符串</span><br><span class="line">&gt; chs               表情文字，发送给新浪微博服务器的文本内容</span><br><span class="line">&gt; png               报请图片，在APP中进行图文混排使用的图片</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 表情包，存储每一组表情数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmoticonPackage</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 表情路径</span></span><br><span class="line">    <span class="keyword">var</span> id:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 分组名称</span></span><br><span class="line">    <span class="keyword">var</span> groupName:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 表情数组</span></span><br><span class="line">    <span class="keyword">var</span> emoticons: [<span class="type">Emoticon</span>]?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(id: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.id = id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 加载表情包·数组·</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">packages</span>() -&gt; [<span class="title">EmoticonPackage</span>] </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> list = [<span class="type">EmoticonPackage</span>]()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取emoticons.plist文件</span></span><br><span class="line">        <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"emoticons.plist"</span>, ofType: <span class="literal">nil</span>, inDirectory: <span class="string">"Emoticons.bundle"</span>)</span><br><span class="line">        <span class="keyword">let</span> dict = <span class="type">NSDictionary</span>(contentsOfFile: path!)!</span><br><span class="line">        <span class="keyword">let</span> array = dict[<span class="string">"packages"</span>] <span class="keyword">as</span>! [[<span class="type">String</span> : <span class="type">AnyObject</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历数组</span></span><br><span class="line">        <span class="keyword">for</span> dic <span class="keyword">in</span> array &#123;</span><br><span class="line">            <span class="comment">// 创建表情包，并初始化对应的路径</span></span><br><span class="line">            <span class="keyword">let</span> package = <span class="type">EmoticonPackage</span>(id: dic[<span class="string">"id"</span>] <span class="keyword">as</span>! <span class="type">String</span>)</span><br><span class="line">            <span class="comment">// 加载表情数组</span></span><br><span class="line">            package.loadEmoticons()</span><br><span class="line">            <span class="comment">// 添加表情包</span></span><br><span class="line">            list.append(package)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 加载对应的表情数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">loadEmoticons</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 加载info.plist数据</span></span><br><span class="line">        <span class="keyword">let</span> dict = <span class="type">NSDictionary</span>(contentsOfFile: plistPath())!</span><br><span class="line">        <span class="comment">// 设置分组名</span></span><br><span class="line">        groupName = dict[<span class="string">"group_name_cn"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        <span class="comment">// 获取表情数组</span></span><br><span class="line">        <span class="keyword">let</span> array = dict[<span class="string">"emoticons"</span>] <span class="keyword">as</span>! [[<span class="type">String</span> : <span class="type">String</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化表情数组</span></span><br><span class="line">        emoticons = [<span class="type">Emoticon</span>]()</span><br><span class="line">        <span class="comment">// 遍历数组</span></span><br><span class="line">        <span class="keyword">for</span> dic <span class="keyword">in</span> array &#123;</span><br><span class="line">            emoticons?.append(<span class="type">Emoticon</span>(dict: dic))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 返回info.plist路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">plistPath</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">EmoticonPackage</span>.bundlePath().appendingPathComponent(id!) <span class="keyword">as</span> <span class="type">NSString</span>).appendingPathComponent(<span class="string">"info.plist"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 返回表情包路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">bundlePath</span>() -&gt; <span class="title">NSString</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">Bundle</span>.main.bundlePath <span class="keyword">as</span> <span class="type">NSString</span>).appendingPathComponent(<span class="string">"Emoticons.bundle"</span>) <span class="keyword">as</span> <span class="type">NSString</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 表情模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Emoticon</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 表情路径</span></span><br><span class="line">    <span class="keyword">var</span> id:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 表情文字，发送给新浪微博服务器的文本内容</span></span><br><span class="line">    <span class="keyword">var</span> chs:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 表情图片，在APP中进行图文混排的图片</span></span><br><span class="line">    <span class="keyword">var</span> png:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// UNICODE编码字符串</span></span><br><span class="line">    <span class="keyword">var</span> code:<span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dict:[<span class="type">String</span> : <span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        <span class="comment">// 使用KVC设置属性之前，必须调用super.init()</span></span><br><span class="line">        setValuesForKeys(dict)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setValue</span><span class="params">(<span class="number">_</span> value: Any?, forUndefinedKey key: String)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="emoji字符扫描及转换原理"><a href="#emoji字符扫描及转换原理" class="headerlink" title="emoji字符扫描及转换原理"></a>emoji字符扫描及转换原理</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 十六进制的字符串</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">"0x2600"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描器，可以扫描指定字符串中特定文字</span></span><br><span class="line"><span class="keyword">let</span> scannser = <span class="type">Scanner</span>(string: code)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描整数</span></span><br><span class="line"><span class="keyword">var</span> result: <span class="type">UInt32</span> = <span class="number">0</span></span><br><span class="line">scannser.scanHexInt32(&amp;result)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result) <span class="comment">// 9728</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成字符串</span></span><br><span class="line"><span class="keyword">let</span> str = <span class="string">"\(Character(UnicodeScalar(result)!))"</span></span><br><span class="line"><span class="built_in">print</span>(str) <span class="comment">// ☀</span></span><br></pre></td></tr></table></figure>
<p>那么在Emoticon中（注意点：需要设置id参数）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 表情模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Emoticon</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 表情路径</span></span><br><span class="line">    <span class="keyword">var</span> id:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 表情文字，发送给新浪微博服务器的文本内容</span></span><br><span class="line">    <span class="keyword">var</span> chs:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// 表情图片，在APP中进行图文混排的图片</span></span><br><span class="line">    <span class="keyword">var</span> png:<span class="type">String</span>?</span><br><span class="line">    <span class="comment">/// UNICODE编码字符串</span></span><br><span class="line">    <span class="keyword">var</span> code:<span class="type">String</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span>&#123;</span><br><span class="line">            <span class="comment">// 扫描器，可以扫描指定字符串中特定的文字</span></span><br><span class="line">            <span class="keyword">let</span> scanner = <span class="type">Scanner</span>(string: code!)</span><br><span class="line">            <span class="comment">// 扫描整数</span></span><br><span class="line">            <span class="keyword">var</span> result: <span class="type">UInt32</span> = <span class="number">0</span></span><br><span class="line">            scanner.scanHexInt32(&amp;result)</span><br><span class="line">            <span class="comment">// 生成字符串</span></span><br><span class="line">            emoji = <span class="string">"\(Character(UnicodeScalar(result)!))"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// emoji字符串</span></span><br><span class="line">    <span class="keyword">var</span> emoji:<span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 图片的完整路径</span></span><br><span class="line">    <span class="keyword">var</span> imagePath:<span class="type">String</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> png == <span class="literal">nil</span> ? <span class="literal">nil</span> : (<span class="type">EmoticonPackage</span>.bundlePath().appendingPathComponent(id!) <span class="keyword">as</span> <span class="type">NSString</span>).appendingPathComponent(png!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(id:<span class="type">String</span>, dict:[<span class="type">String</span> : <span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        <span class="keyword">self</span>.id = id</span><br><span class="line">        <span class="comment">// 使用KVC设置属性之前，必须调用super.init()</span></span><br><span class="line">        setValuesForKeys(dict)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setValue</span><span class="params">(<span class="number">_</span> value: Any?, forUndefinedKey key: String)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示图片和emoji"><a href="#显示图片和emoji" class="headerlink" title="显示图片和emoji"></a>显示图片和emoji</h3><p>加载数据<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> packages: [<span class="type">EmoticonPackage</span>] = <span class="type">EmoticonPackage</span>.packages()</span><br></pre></td></tr></table></figure></p>
<p>设置EmoticonCell数据</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> emoticon: <span class="type">Emoticon</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// 设置图片</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> path = emoticon?.imagePath &#123;</span><br><span class="line">        emoticonBtn.setImage(<span class="type">UIImage</span>(named: path), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 防止cell的重用</span></span><br><span class="line">        emoticonBtn.setImage(<span class="literal">nil</span>, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置emoji，直接过滤调用cell重用的问题</span></span><br><span class="line">        emoticonBtn.setTitle(emoticon?.emoji ?? <span class="string">""</span>, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据源方法修改</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">EmoticonViewController</span>: <span class="title">UICollectionViewDataSource</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> collectionView: UICollectionView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> packages.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> packages[section].emoticons?.<span class="built_in">count</span> ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kEmoticonCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">EmoticonCell</span></span><br><span class="line">        cell.backgroundColor = (indexPath.item % <span class="number">2</span> == <span class="number">0</span>) ? <span class="type">UIColor</span>.red : <span class="type">UIColor</span>.blue</span><br><span class="line">        cell.emoticon = packages[indexPath.section].emoticons![indexPath.item]</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%983.png" alt="image"></p>
<h3 id="完善模型"><a href="#完善模型" class="headerlink" title="完善模型"></a>完善模型</h3><p>由于零散点修改多，这里只贴出部分，具体参看EmoticonPackage.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 追加空白按钮，方便界面布局，如果一个界面的图标不足20个，补足，最后添加一个删除按钮</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">appendEmptyEmoticons</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> emoticons == <span class="literal">nil</span> &#123;</span><br><span class="line">        emoticons = [<span class="type">Emoticon</span>]()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = emoticons!.<span class="built_in">count</span> % <span class="number">21</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">count</span> &gt; <span class="number">0</span> || emoticons!.<span class="built_in">count</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="built_in">count</span>..&lt;<span class="number">20</span> &#123;</span><br><span class="line">            <span class="comment">// 追加空白按钮</span></span><br><span class="line">            emoticons?.append(<span class="type">Emoticon</span>(isRemoveBtn: <span class="literal">false</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 追加一个删除按钮</span></span><br><span class="line">        emoticons?.append(<span class="type">Emoticon</span>(isRemoveBtn: <span class="literal">true</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在EmoticonViewController.swift中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> emoticon: <span class="type">Emoticon</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// 设置图片</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> path = emoticon?.imagePath &#123;</span><br><span class="line">            emoticonBtn.setImage(<span class="type">UIImage</span>(named: path), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 防止cell的重用</span></span><br><span class="line">            emoticonBtn.setImage(<span class="literal">nil</span>, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置emoji，直接过滤调用cell重用的问题</span></span><br><span class="line">        emoticonBtn.setTitle(emoticon?.emoji ?? <span class="string">""</span>, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置删除按钮</span></span><br><span class="line">        <span class="keyword">if</span> emoticon!.removeBtn &#123;</span><br><span class="line">            emoticonBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"compose_emoticon_delete"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">            emoticonBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"compose_emoticon_delete_highlighted"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调整表情分组"><a href="#调整表情分组" class="headerlink" title="调整表情分组"></a>调整表情分组</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clickItem</span><span class="params">(item: UIBarButtonItem)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(item.tag)</span><br><span class="line">    <span class="keyword">let</span> indexPath = <span class="type">NSIndexPath</span>(item: <span class="number">0</span>, section: item.tag)</span><br><span class="line">    collectionView.scrollToItem(at: indexPath <span class="keyword">as</span> <span class="type">IndexPath</span>, at: <span class="type">UICollectionViewScrollPosition</span>.<span class="keyword">left</span>, animated: <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="插入emoji表情"><a href="#插入emoji表情" class="headerlink" title="插入emoji表情"></a>插入emoji表情</h3><p>定义一个闭包属性<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 定义一个闭包属性，用于传递选中的表情模型</span></span><br><span class="line"><span class="keyword">var</span> emoticonDidSelectedCallBack: (<span class="number">_</span> emoticon: <span class="type">Emoticon</span>)-&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化属性值</span></span><br><span class="line"><span class="keyword">init</span>(callBack:@escaping (<span class="number">_</span> emoticon: <span class="type">Emoticon</span>)-&gt;()) &#123;</span><br><span class="line">    <span class="keyword">self</span>.emoticonDidSelectedCallBack = callBack</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改懒加载collectionView</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> collectionView: <span class="type">UICollectionView</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> collectionView = <span class="type">UICollectionView</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: <span class="type">EmoticonLayout</span>())</span><br><span class="line">    collectionView.register(<span class="type">EmoticonCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kEmoticonCellReuseIdentifier)</span><br><span class="line">    collectionView.dataSource = <span class="keyword">self</span></span><br><span class="line">    collectionView.delegate = <span class="keyword">self</span></span><br><span class="line">    <span class="keyword">return</span> collectionView</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>实现UICollectionViewDelegate代理方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取表情模型</span></span><br><span class="line">    <span class="keyword">let</span> emoticon = packages[indexPath.section].emoticons![indexPath.item]</span><br><span class="line">    <span class="comment">// 执行闭包</span></span><br><span class="line">    emoticonDidSelectedCallBack(emoticon)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关闭cell中按钮的点击，否则与点击cell的事件冲突</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">    contentView.addSubview(emoticonBtn)</span><br><span class="line">    emoticonBtn.frame = bounds.insetBy(dx: <span class="number">4</span>, dy: <span class="number">4</span>)</span><br><span class="line">    emoticonBtn.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">    emoticonBtn.isUserInteractionEnabled = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiscoverTableViewController</span>: <span class="title">BaseViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        view.addSubview(textView)</span><br><span class="line">        textView.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.topCenter, referView: view, size: <span class="type">CGSize</span>(width: <span class="number">150</span>, height: <span class="number">50</span>), offset: <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: navHeight+<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">        addChildViewController(emojiController)</span><br><span class="line">        textView.inputView = emojiController.view</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> textView: <span class="type">UITextView</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> view = <span class="type">UITextView</span>()</span><br><span class="line">        view.text = <span class="string">"start"</span></span><br><span class="line">        view.backgroundColor = <span class="type">UIColor</span>.red</span><br><span class="line">        <span class="keyword">return</span> view</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// weak 相当于OC中的__weak,特点对象释放之后会将变量设置nil</span></span><br><span class="line">    <span class="comment">// unowned相当于OC中的unsafe_unretained ，特点对象释放之后不会将变量设置nil</span></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> emojiController: <span class="type">EmoticonViewController</span> = <span class="type">EmoticonViewController</span> &#123;</span><br><span class="line">        [<span class="keyword">unowned</span> <span class="keyword">self</span>]</span><br><span class="line">        (emoticon) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> emoticon.chs != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.textView.replace(<span class="keyword">self</span>.textView.selectedTextRange!, withText: emoticon.chs!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%984.gif" alt="image"></p>
<h3 id="插入图片表情"><a href="#插入图片表情" class="headerlink" title="插入图片表情"></a>插入图片表情</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// weak 相当于OC中的__weak,特点对象释放之后会将变量设置nil</span></span><br><span class="line"><span class="comment">// unowned相当于OC中的unsafe_unretained ，特点对象释放之后不会将变量设置nil</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> emojiController: <span class="type">EmoticonViewController</span> = <span class="type">EmoticonViewController</span> &#123;</span><br><span class="line">    [<span class="keyword">unowned</span> <span class="keyword">self</span>]</span><br><span class="line">    (emoticon) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.emoji != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.replace(<span class="keyword">self</span>.textView.selectedTextRange!, withText: emoticon.emoji!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前点击的是否是表情图片</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.png != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 创建附件</span></span><br><span class="line">        <span class="keyword">let</span> attachment = <span class="type">NSTextAttachment</span>()</span><br><span class="line">        attachment.image = <span class="type">UIImage</span>(contentsOfFile: emoticon.imagePath!)</span><br><span class="line">        <span class="comment">// 设置附件大小</span></span><br><span class="line">        attachment.bounds = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: -<span class="number">4</span>, width: <span class="number">20</span>, height: <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据附件创建属性字符串</span></span><br><span class="line">        <span class="keyword">let</span> imageText = <span class="type">NSAttributedString</span>(attachment: attachment)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到当前所有内容</span></span><br><span class="line">        <span class="keyword">let</span> strM = <span class="type">NSMutableAttributedString</span>(attributedString: <span class="keyword">self</span>.textView.attributedText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入表情到当前光标所在的位置</span></span><br><span class="line">        <span class="keyword">let</span> range = <span class="keyword">self</span>.textView.selectedRange</span><br><span class="line">        strM.replaceCharacters(<span class="keyword">in</span>: range, with: imageText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性字符串有自己默认的尺寸</span></span><br><span class="line">        strM.addAttribute(<span class="type">NSFontAttributeName</span>, value: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">19</span>), range: <span class="type">NSMakeRange</span>(range.location, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将替换后的字符串赋值给textView</span></span><br><span class="line">        <span class="keyword">self</span>.textView.attributedText = strM</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复光标所在的位置</span></span><br><span class="line">        <span class="comment">// 两个参数：第一个是指定光标所在的位置，第二个是选中文本的个数</span></span><br><span class="line">        <span class="keyword">self</span>.textView.selectedRange = <span class="type">NSMakeRange</span>(range.location+<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%985.gif" alt="image"></p>
<hr>
<h2 id="更新时间：2018-05-19-10-48-31"><a href="#更新时间：2018-05-19-10-48-31" class="headerlink" title="更新时间：2018-05-19 10:48:31"></a>更新时间：2018-05-19 10:48:31</h2><h3 id="简单的图文混排-测试"><a href="#简单的图文混排-测试" class="headerlink" title="简单的图文混排(测试)"></a>简单的图文混排(测试)</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> attributed = <span class="type">NSMutableAttributedString</span>()</span><br><span class="line">    <span class="keyword">let</span> str1 = <span class="type">NSAttributedString</span>(string: <span class="string">"我"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> attachment = <span class="type">NSTextAttachment</span>()</span><br><span class="line">    attachment.image = <span class="type">UIImage</span>(named: <span class="string">"preview_like_icon"</span>)</span><br><span class="line">    <span class="comment">// 修改附件尺寸</span></span><br><span class="line">    attachment.bounds = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: -<span class="number">4</span>, width: <span class="number">20</span>, height: <span class="number">20</span>)</span><br><span class="line">    <span class="keyword">let</span> imageText = <span class="type">NSAttributedString</span>(attachment: attachment)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> str2 = <span class="type">NSMutableAttributedString</span>(string: <span class="string">"LOVE YOU"</span>)</span><br><span class="line">    str2.addAttribute(<span class="type">NSForegroundColorAttributeName</span>, value: <span class="type">UIColor</span>.red, range: <span class="type">NSMakeRange</span>(<span class="number">5</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    attributed.append(str1)</span><br><span class="line">    attributed.append(imageText)</span><br><span class="line">    attributed.append(str2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.customLabel.attributedText = attributed</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E9%94%AE%E7%9B%986.png" alt="image"></p>
<h3 id="获取发送文本"><a href="#获取发送文本" class="headerlink" title="获取发送文本"></a>获取发送文本</h3><p>创建附件类</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmoticonTextAttachment</span>: <span class="title">NSTextAttachment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 保存对应表情的文字</span></span><br><span class="line">    <span class="keyword">var</span> chs:<span class="type">String</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NSTextAttachment替换为EmoticonTextAttachment<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// weak 相当于OC中的__weak,特点对象释放之后会将变量设置nil</span></span><br><span class="line"><span class="comment">// unowned相当于OC中的unsafe_unretained ，特点对象释放之后不会将变量设置nil</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> emojiController: <span class="type">EmoticonViewController</span> = <span class="type">EmoticonViewController</span> &#123;</span><br><span class="line">    [<span class="keyword">unowned</span> <span class="keyword">self</span>]</span><br><span class="line">    (emoticon) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.emoji != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.replace(<span class="keyword">self</span>.textView.selectedTextRange!, withText: emoticon.emoji!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前点击的是否是表情图片</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.png != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 创建附件</span></span><br><span class="line">        <span class="comment">//            let attachment = NSTextAttachment()</span></span><br><span class="line">        <span class="keyword">let</span> attachment = <span class="type">EmoticonTextAttachment</span>()</span><br><span class="line">        attachment.chs = emoticon.chs</span><br><span class="line">        attachment.image = <span class="type">UIImage</span>(contentsOfFile: emoticon.imagePath!)</span><br><span class="line">        <span class="comment">// 设置附件大小</span></span><br><span class="line">        attachment.bounds = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: -<span class="number">4</span>, width: <span class="number">20</span>, height: <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据附件创建属性字符串</span></span><br><span class="line">        <span class="keyword">let</span> imageText = <span class="type">NSAttributedString</span>(attachment: attachment)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到当前所有内容</span></span><br><span class="line">        <span class="keyword">let</span> strM = <span class="type">NSMutableAttributedString</span>(attributedString: <span class="keyword">self</span>.textView.attributedText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入表情到当前光标所在的位置</span></span><br><span class="line">        <span class="keyword">let</span> range = <span class="keyword">self</span>.textView.selectedRange</span><br><span class="line">        strM.replaceCharacters(<span class="keyword">in</span>: range, with: imageText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性字符串有自己默认的尺寸</span></span><br><span class="line">        strM.addAttribute(<span class="type">NSFontAttributeName</span>, value: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">19</span>), range: <span class="type">NSMakeRange</span>(range.location, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将替换后的字符串赋值给textView</span></span><br><span class="line">        <span class="keyword">self</span>.textView.attributedText = strM</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复光标所在的位置</span></span><br><span class="line">        <span class="comment">// 两个参数：第一个是指定光标所在的位置，第二个是选中文本的个数</span></span><br><span class="line">        <span class="keyword">self</span>.textView.selectedRange = <span class="type">NSMakeRange</span>(range.location+<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取发送文本</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strM = <span class="type">String</span>()</span><br><span class="line"><span class="comment">// 后台需要发送给服务器的数据</span></span><br><span class="line"><span class="keyword">self</span>.textView.attributedText.enumerateAttributes(<span class="keyword">in</span>: <span class="type">NSMakeRange</span>(<span class="number">0</span>, <span class="keyword">self</span>.textView.attributedText.length), options: <span class="type">NSAttributedString</span>.<span class="type">EnumerationOptions</span>(rawValue: <span class="number">0</span>)) &#123; (objc, range, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历的时候传递给我们的objc是一个字典，如果字典中的NSAttachment这个可以有值，那么久证明当前是一个图片</span></span><br><span class="line">    <span class="built_in">print</span>(objc[<span class="string">"NSAttachment"</span>] <span class="keyword">as</span> <span class="type">Any</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// range就是春字符串的范围，如果春字符串中间有图片表情，那么range就会传递多次</span></span><br><span class="line">    <span class="built_in">print</span>(range)</span><br><span class="line">    <span class="keyword">let</span> les = (<span class="keyword">self</span>.textView.text <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: range)</span><br><span class="line">    <span class="built_in">print</span>(les)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> objc[<span class="string">"NSAttachment"</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 图片</span></span><br><span class="line">        <span class="keyword">let</span> attachment = objc[<span class="string">"NSAttachment"</span>] <span class="keyword">as</span>! <span class="type">EmoticonTextAttachment</span></span><br><span class="line">        strM += attachment.chs!</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 文字</span></span><br><span class="line">        strM += (<span class="keyword">self</span>.textView.text <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: range)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(strM)</span><br><span class="line"><span class="comment">// shshasdaHAH双手合十[馋嘴][馋嘴][馋嘴][馋嘴][馋嘴][馋嘴][馋嘴][可爱]</span></span><br></pre></td></tr></table></figure>
<h3 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h3><p>传入表情模型，获取图片文本<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmoticonTextAttachment</span>: <span class="title">NSTextAttachment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 保存对应表情的文字</span></span><br><span class="line">    <span class="keyword">var</span> chs:<span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">imageText</span>(<span class="title">emoticon</span>:<span class="title">Emoticon</span>, <span class="title">font</span>:<span class="title">CGFloat</span>) -&gt; <span class="title">NSAttributedString</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建附件</span></span><br><span class="line">        <span class="keyword">let</span> attachment = <span class="type">EmoticonTextAttachment</span>()</span><br><span class="line">        attachment.chs = emoticon.chs</span><br><span class="line">        attachment.image = <span class="type">UIImage</span>(contentsOfFile: emoticon.imagePath!)</span><br><span class="line">        <span class="comment">// 设置附件大小</span></span><br><span class="line">        attachment.bounds = <span class="type">CGRect</span>(x: <span class="number">0</span>, y: -<span class="number">4</span>, width: font, height: font)</span><br><span class="line">        <span class="comment">// 根据附件创建属性字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSAttributedString</span>(attachment: attachment)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>扩展UITextView</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UITextView</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 插入表情</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insertEmoticon</span><span class="params">(emoticon:Emoticon, font:CGFloat)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> emoticon.emoji != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.replace(<span class="keyword">self</span>.selectedTextRange!, withText: emoticon.emoji!)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断当前点击的是否是表情图片</span></span><br><span class="line">        <span class="keyword">if</span> emoticon.png != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据附件创建属性字符串</span></span><br><span class="line">            <span class="keyword">let</span> imageText = <span class="type">EmoticonTextAttachment</span>.imageText(emoticon: emoticon, font: font)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拿到当前所有内容</span></span><br><span class="line">            <span class="keyword">let</span> strM = <span class="type">NSMutableAttributedString</span>(attributedString: <span class="keyword">self</span>.attributedText)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 插入表情到当前光标所在的位置</span></span><br><span class="line">            <span class="keyword">let</span> range = <span class="keyword">self</span>.selectedRange</span><br><span class="line">            strM.replaceCharacters(<span class="keyword">in</span>: range, with: imageText)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 属性字符串有自己默认的尺寸</span></span><br><span class="line">            strM.addAttribute(<span class="type">NSFontAttributeName</span>, value: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">19</span>), range: <span class="type">NSMakeRange</span>(range.location, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将替换后的字符串赋值给textView</span></span><br><span class="line">            <span class="keyword">self</span>.attributedText = strM</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 恢复光标所在的位置</span></span><br><span class="line">            <span class="comment">// 两个参数：第一个是指定光标所在的位置，第二个是选中文本的个数</span></span><br><span class="line">            <span class="keyword">self</span>.selectedRange = <span class="type">NSMakeRange</span>(range.location+<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">emoticonAttributeText</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> strM = <span class="type">String</span>()</span><br><span class="line">        <span class="comment">// 后台需要发送给服务器的数据</span></span><br><span class="line">        attributedText.enumerateAttributes(<span class="keyword">in</span>: <span class="type">NSMakeRange</span>(<span class="number">0</span>, attributedText.length), options: <span class="type">NSAttributedString</span>.<span class="type">EnumerationOptions</span>(rawValue: <span class="number">0</span>)) &#123; (objc, range, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历的时候传递给我们的objc是一个字典，如果字典中的NSAttachment这个可以有值，那么久证明当前是一个图片</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// range就是春字符串的范围，如果春字符串中间有图片表情，那么range就会传递多次</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> objc[<span class="string">"NSAttachment"</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// 图片</span></span><br><span class="line">                <span class="keyword">let</span> attachment = objc[<span class="string">"NSAttachment"</span>] <span class="keyword">as</span>! <span class="type">EmoticonTextAttachment</span></span><br><span class="line">                strM += attachment.chs!</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 文字</span></span><br><span class="line">                strM += (<span class="keyword">self</span>.text <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: range)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> strM</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除按钮处理"><a href="#删除按钮处理" class="headerlink" title="删除按钮处理"></a>删除按钮处理</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 插入表情</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertEmoticon</span><span class="params">(emoticon:Emoticon, font:CGFloat)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 处理删除按钮</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.removeBtn &#123;</span><br><span class="line">        deleteBackward()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前点击是否是emoji表情</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.emoji != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.replace(<span class="keyword">self</span>.selectedTextRange!, withText: emoticon.emoji!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前点击的是否是表情图片</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.png != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据附件创建属性字符串</span></span><br><span class="line">        <span class="keyword">let</span> imageText = <span class="type">EmoticonTextAttachment</span>.imageText(emoticon: emoticon, font: font)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到当前所有内容</span></span><br><span class="line">        <span class="keyword">let</span> strM = <span class="type">NSMutableAttributedString</span>(attributedString: <span class="keyword">self</span>.attributedText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入表情到当前光标所在的位置</span></span><br><span class="line">        <span class="keyword">let</span> range = <span class="keyword">self</span>.selectedRange</span><br><span class="line">        strM.replaceCharacters(<span class="keyword">in</span>: range, with: imageText)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性字符串有自己默认的尺寸</span></span><br><span class="line">        strM.addAttribute(<span class="type">NSFontAttributeName</span>, value: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">19</span>), range: <span class="type">NSMakeRange</span>(range.location, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将替换后的字符串赋值给textView</span></span><br><span class="line">        <span class="keyword">self</span>.attributedText = strM</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复光标所在的位置</span></span><br><span class="line">        <span class="comment">// 两个参数：第一个是指定光标所在的位置，第二个是选中文本的个数</span></span><br><span class="line">        <span class="keyword">self</span>.selectedRange = <span class="type">NSMakeRange</span>(range.location+<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理最近表情"><a href="#处理最近表情" class="headerlink" title="处理最近表情"></a>处理最近表情</h3><p>在Emoticon类中声明属性记录使用次数</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 记录当前表情被使用次数</span></span><br><span class="line"><span class="keyword">var</span> times:<span class="type">Int</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>在EmoticonPackage类中添加方法用来添加表情</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 用于添加最近表情</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendEmoticons</span><span class="params">(emoticon: Emoticon)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 判断是否是删除按钮</span></span><br><span class="line">    <span class="keyword">if</span> emoticon.removeBtn &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前点击的表情是否已经添加到最近数组中</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">contains</span> = emoticons!.<span class="built_in">contains</span>(emoticon)</span><br><span class="line">    <span class="keyword">if</span> !<span class="built_in">contains</span> &#123;</span><br><span class="line">        <span class="comment">// 删除删除按钮</span></span><br><span class="line">        emoticons?.removeLast()</span><br><span class="line">        emoticons?.append(emoticon)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对数组进行排序</span></span><br><span class="line">    <span class="keyword">var</span> result = emoticons?.sorted(by: &#123; (e1, e2) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> e1.times &gt; e2.times</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除多余的表情</span></span><br><span class="line">    <span class="keyword">if</span> !<span class="built_in">contains</span> &#123;</span><br><span class="line">        result?.removeLast()</span><br><span class="line">        result?.append(<span class="type">Emoticon</span>(isRemoveBtn: <span class="literal">true</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emoticons = result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在EmoticonViewController类中点击表情时候进行记录存储</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取表情模型</span></span><br><span class="line">    <span class="keyword">let</span> emoticon = packages[indexPath.section].emoticons![indexPath.item]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理最近表情，将当前使用的表情添加到最近表情的数组中</span></span><br><span class="line">    emoticon.times += <span class="number">1</span></span><br><span class="line">    packages[<span class="number">0</span>].appendEmoticons(emoticon: emoticon)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行闭包</span></span><br><span class="line">    emoticonDidSelectedCallBack(emoticon)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-19-16-00-31"><a href="#更新时间：2018-05-19-16-00-31" class="headerlink" title="更新时间：2018-05-19 16:00:31"></a>更新时间：2018-05-19 16:00:31</h2><h3 id="布局发送微博界面"><a href="#布局发送微博界面" class="headerlink" title="布局发送微博界面"></a>布局发送微博界面</h3><p>创建ComposeViewController.swift</p>
<p>设置导航栏按钮</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupNav</span><span class="params">()</span></span> &#123;</span><br><span class="line">    navigationItem.leftBarButtonItem = <span class="type">UIBarButtonItem</span>(title: <span class="string">"关闭"</span>, style: <span class="type">UIBarButtonItemStyle</span>.plain, target: <span class="keyword">self</span>, action: #selector(close))</span><br><span class="line">    navigationItem.rightBarButtonItem = <span class="type">UIBarButtonItem</span>(title: <span class="string">"发送"</span>, style: <span class="type">UIBarButtonItemStyle</span>.plain, target: <span class="keyword">self</span>, action: #selector(send))</span><br><span class="line">    navigationItem.rightBarButtonItem?.isEnabled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间视图</span></span><br><span class="line">    <span class="keyword">let</span> titleView = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">100</span>, height: <span class="number">32</span>))</span><br><span class="line">    <span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">    label.text = <span class="string">"发送微博"</span></span><br><span class="line">    label.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">15</span>)</span><br><span class="line">    label.sizeToFit()</span><br><span class="line">    titleView.addSubview(label)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> label1 = <span class="type">UILabel</span>()</span><br><span class="line">    label1.text = <span class="type">UserAccount</span>.loadAccount()?.screen_name</span><br><span class="line">    label1.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">15</span>)</span><br><span class="line">    label1.textColor = <span class="type">UIColor</span>.darkGray</span><br><span class="line">    label1.sizeToFit()</span><br><span class="line">    titleView.addSubview(label1)</span><br><span class="line"></span><br><span class="line">    label.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.topCenter, referView: titleView, size: <span class="literal">nil</span>)</span><br><span class="line">    label1.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.bottomCenter, referView: titleView, size: <span class="literal">nil</span>)</span><br><span class="line">    navigationItem.titleView = titleView</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置输入框</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupInputView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    view.addSubview(textView)</span><br><span class="line">    textView.addSubview(placeholderLabel)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 布局子控件</span></span><br><span class="line">    textView.xmg_Fill(view)</span><br><span class="line">    placeholderLabel.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.topLeft, referView: textView, size: <span class="literal">nil</span>, offset: <span class="type">CGPoint</span>(x: <span class="number">5</span>, y: <span class="number">8</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听文本输入变化，改变按钮是否可以点击状态</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ComposeViewController</span>: <span class="title">UITextViewDelegate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">textViewDidChange</span><span class="params">(<span class="number">_</span> textView: UITextView)</span></span> &#123;</span><br><span class="line">        placeholderLabel.isHidden = textView.hasText</span><br><span class="line">        navigationItem.rightBarButtonItem?.isEnabled = textView.hasText</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击tabbar按钮，跳转ComposeViewController页面</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 监听加好按钮点击，注意：监听按钮点击方法不能私有</span></span><br><span class="line"><span class="comment">/// 按钮点击事件的调用是由  运行循环 监听并且以消息机制传递的，因此，按钮监听函数不能设置为fileprivate</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">composeBtnClick</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(#function)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"点击按钮"</span>)</span><br><span class="line">    <span class="keyword">let</span> composeVC = <span class="type">ComposeViewController</span>()</span><br><span class="line">    <span class="keyword">let</span> nav = <span class="type">UINavigationController</span>(rootViewController: composeVC)</span><br><span class="line">    present(nav, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送微博"><a href="#发送微博" class="headerlink" title="发送微博"></a>发送微博</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">SVProgressHUD</span>.show(withStatus: <span class="string">"正在发送。。。"</span>)</span><br><span class="line">    <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">"2/statuses/update.json"</span></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>: <span class="type">UserAccount</span>.loadAccount()?.access_token, <span class="string">"status"</span>:textView.text]</span><br><span class="line">    <span class="type">NetworkTools</span>.shareNetworkTools().post(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">    </span><br><span class="line">        <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">        <span class="comment">// 提示用户发送成功</span></span><br><span class="line">        <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送成功"</span>)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭页面</span></span><br><span class="line">        <span class="keyword">self</span>.close()</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">        <span class="comment">// 提示发送失败</span></span><br><span class="line">        <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送失败"</span>)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="继承表情键盘"><a href="#继承表情键盘" class="headerlink" title="继承表情键盘"></a>继承表情键盘</h3><p>声明键盘属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 表情键盘</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> emoticonKeyboradVC: <span class="type">EmoticonViewController</span> = <span class="type">EmoticonViewController</span> &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (emoticon) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">self</span>.textView.insertEmoticon(emoticon: emoticon)</span><br><span class="line">    <span class="keyword">self</span>.textViewDidChange(<span class="keyword">self</span>.textView)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加键盘控制器</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加子控制器</span></span><br><span class="line">addChildViewController(emoticonKeyboradVC)</span><br></pre></td></tr></table></figure>
<p>切换键盘</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 切换表情键盘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inputEmoticon</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 如果输入视图是nul，说明使用的是系统键盘</span></span><br><span class="line">    <span class="built_in">print</span>(textView.inputView)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要切换键盘之前，需要先关闭键盘</span></span><br><span class="line">    textView.resignFirstResponder()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更换键盘输入视图</span></span><br><span class="line">    textView.inputView = (textView.inputView == <span class="literal">nil</span>) ? emoticonKeyboradVC.view : <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新设置检点</span></span><br><span class="line">    textView.becomeFirstResponder()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E5%8F%91%E5%B8%832.gif" alt="image"></p>
<hr>
<h2 id="更新时间：2018-05-21-10-04-56"><a href="#更新时间：2018-05-21-10-04-56" class="headerlink" title="更新时间：2018-05-21 10:04:56"></a>更新时间：2018-05-21 10:04:56</h2><h3 id="创建浏览器-amp-布局"><a href="#创建浏览器-amp-布局" class="headerlink" title="创建浏览器&amp;布局"></a>创建浏览器&amp;布局</h3><p>懒加载三个属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - 懒加载</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> layout = <span class="type">UICollectionViewFlowLayout</span>()</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> collectionView = <span class="type">UICollectionView</span>(frame: <span class="type">CGRect</span>.zero, collectionViewLayout: <span class="keyword">self</span>.layout)</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> photos = [<span class="type">UIImage</span>]()</span><br></pre></td></tr></table></figure>
<p>创建cell</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoSelectorCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line"></span><br><span class="line">        setupUI()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        contentView.addSubview(photoBtn)</span><br><span class="line">        contentView.addSubview(removeBtn)</span><br><span class="line"></span><br><span class="line">        photoBtn.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line">        removeBtn.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">var</span> cons = [<span class="type">NSLayoutConstraint</span>]()</span><br><span class="line">        <span class="comment">// 背景</span></span><br><span class="line">        cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"H:|-0-[photoButton]-0-|"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"photoButton"</span>: photoBtn])</span><br><span class="line">        cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"V:|-0-[photoButton]-0-|"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"photoButton"</span>: photoBtn])</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除按钮</span></span><br><span class="line">        cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"H:[removeButton]-0-|"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"removeButton"</span>:removeBtn])</span><br><span class="line">        cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"V:|-0-[removeButton]"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"removeButton"</span>:removeBtn])</span><br><span class="line"></span><br><span class="line">        contentView.addConstraints(cons)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置监听方法</span></span><br><span class="line">        photoBtn.addTarget(<span class="keyword">self</span>, action: #selector(selectPhoto), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpOutside)</span><br><span class="line">        removeBtn.addTarget(<span class="keyword">self</span>, action: #selector(removePhoto), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpOutside)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">selectPhoto</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">removePhoto</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - 懒加载</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> photoBtn = <span class="type">PhotoSelectorCell</span>.createBtn(imageName: <span class="string">"compose_ic_add"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> removeBtn = <span class="type">PhotoSelectorCell</span>.createBtn(imageName: <span class="string">"compose_ic_close"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">createBtn</span>(<span class="title">imageName</span>:<span class="title">String</span>) -&gt; <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> button = <span class="type">UIButton</span>()</span><br><span class="line">        button.setImage(<span class="type">UIImage</span>(named: imageName), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        button.setImage(<span class="type">UIImage</span>(named: imageName + <span class="string">"_highlighted"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line">        <span class="keyword">return</span> button</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PhotoSelectorController初始化UI</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupUI</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    view.addSubview(collectionView)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置layout</span></span><br><span class="line">    layout.itemSize = <span class="type">CGSize</span>(width: <span class="number">80</span>, height: <span class="number">80</span>)</span><br><span class="line">    layout.sectionInset = <span class="type">UIEdgeInsetsMake</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置collectionView</span></span><br><span class="line">    collectionView.backgroundColor = <span class="type">UIColor</span>.lightGray</span><br><span class="line">    collectionView.register(<span class="type">PhotoSelectorCell</span>.<span class="keyword">self</span>, forCellWithReuseIdentifier: kPhotoSelectorCellReuseIdentifier)</span><br><span class="line">    collectionView.dataSource = <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置布局</span></span><br><span class="line">    collectionView.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> cons = [<span class="type">NSLayoutConstraint</span>]()</span><br><span class="line">    cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"H:|-0-[collectionView]-0-|"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"collectionView"</span>: collectionView])</span><br><span class="line">    cons += <span class="type">NSLayoutConstraint</span>.constraints(withVisualFormat: <span class="string">"V:|-0-[collectionView]-0-|"</span>, options: <span class="type">NSLayoutFormatOptions</span>(rawValue: <span class="number">0</span>), metrics: <span class="literal">nil</span>, views: [<span class="string">"collectionView"</span>: collectionView])</span><br><span class="line">    view.addConstraints(cons)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现数据源方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PhotoSelectorController</span>: <span class="title">UICollectionViewDataSource</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kPhotoSelectorCellReuseIdentifier, <span class="keyword">for</span>: indexPath)</span><br><span class="line">        cell.backgroundColor = <span class="type">UIColor</span>.randomColor()</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示图片浏览器"><a href="#显示图片浏览器" class="headerlink" title="显示图片浏览器"></a>显示图片浏览器</h3><h4 id="创建代理"><a href="#创建代理" class="headerlink" title="创建代理"></a>创建代理</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PhotoSelectorCellDelegate</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 要选择照片</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorSelectPhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span></span><br><span class="line">    <span class="comment">/// 要删除照片</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorRemovePhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>协议的某些属性或方法是可选实现的。遵循协议的类，就可以灵活实现相关属性和方法了。协议中使用optional关键字作为前缀定义可选类型。因为要跟OC打交道，所以协议以及属性、方法前面都要加上@objc。那么也推导出只有OC类型的类或者是@objc类遵循，其他类以及结构体和枚举都不能遵循这种协议</p>
<h4 id="代理属性"><a href="#代理属性" class="headerlink" title="代理属性"></a>代理属性</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 定义代理</span></span><br><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">PhotoSelectorCellDelegate</span>?</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectPhoto</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    delegate?.photoSelectorSelectPhoto!(cell: <span class="keyword">self</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removePhoto</span><span class="params">()</span></span> &#123;</span><br><span class="line">    delegate?.photoSelectorRemovePhoto!(cell: <span class="keyword">self</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现PhotoSelectorCellDelegate"><a href="#实现PhotoSelectorCellDelegate" class="headerlink" title="实现PhotoSelectorCellDelegate"></a>实现PhotoSelectorCellDelegate</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PhotoSelectorController</span>: <span class="title">UICollectionViewDataSource</span>, <span class="title">PhotoSelectorCellDelegate</span>, <span class="title">UIImagePickerControllerDelegate</span>, <span class="title">UINavigationControllerDelegate</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kPhotoSelectorCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">PhotoSelectorCell</span></span><br><span class="line">        cell.backgroundColor = <span class="type">UIColor</span>.randomColor()</span><br><span class="line">        cell.delegate = <span class="keyword">self</span></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - PhotoSelectorCellDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorSelectPhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        UIIimagePickerController专门用来选择照片的</span><br><span class="line">        PhotoLibrary : 照片库（所有的照片，拍照&amp;用iTunes &amp; photo 同步的照片，不能删除）</span><br><span class="line">        SavePPhotosAlbum 相册（自助机拍摄的，可以删除）</span><br><span class="line">        Camera 相机</span><br><span class="line">        */</span></span><br><span class="line">        <span class="keyword">if</span> !<span class="type">UIImagePickerController</span>.isSourceTypeAvailable(<span class="type">UIImagePickerControllerSourceType</span>.photoLibrary) &#123;</span><br><span class="line">            <span class="comment">// 没有授权</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> vc = <span class="type">UIImagePickerController</span>()</span><br><span class="line">        vc.delegate = <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许编辑 - 如果上传头像，记得把这个属性打开</span></span><br><span class="line">        <span class="comment">// 能够建立一个正方形的图像，方便后续的头像处理</span></span><br><span class="line">        <span class="comment">//        vc.allowsEditing = true</span></span><br><span class="line"></span><br><span class="line">        present(vc, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorRemovePhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - UIImagePickerControllerDelegate, UINavigationControllerDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">imagePickerController</span><span class="params">(<span class="number">_</span> picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [String : Any])</span></span> &#123;</span><br><span class="line">        <span class="comment">// 提示：所有关于相册的处理，都需要处理内存</span></span><br><span class="line">        <span class="built_in">print</span>(info)</span><br><span class="line">        <span class="comment">// 获取图片</span></span><br><span class="line">        <span class="built_in">print</span>(info[<span class="type">UIImagePickerControllerOriginalImage</span>] <span class="keyword">as</span> <span class="type">Any</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭</span></span><br><span class="line">        dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示照片"><a href="#显示照片" class="headerlink" title="显示照片"></a>显示照片</h3><p>在PhotoSelectorCell中添加图片属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不能解包可选项 -&gt; 将nil使用了惊叹号</span></span><br><span class="line"><span class="keyword">var</span> image:<span class="type">UIImage</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> image != <span class="literal">nil</span> &#123;</span><br><span class="line">            photoBtn.setImage(image, <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            photoBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"compose_pic_add"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.normal)</span><br><span class="line">            photoBtn.setImage(<span class="type">UIImage</span>(named: <span class="string">"compose_pic_add_highlighted"</span>), <span class="keyword">for</span>: <span class="type">UIControlState</span>.highlighted)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeBtn.isHidden = (image == <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据源方法&amp;cell代理方法相关修改</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">extension</span> <span class="title">PhotoSelectorController</span>: <span class="title">UICollectionViewDataSource</span>, <span class="title">PhotoSelectorCellDelegate</span>, <span class="title">UIImagePickerControllerDelegate</span>, <span class="title">UINavigationControllerDelegate</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> photos.<span class="built_in">count</span> + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: kPhotoSelectorCellReuseIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">PhotoSelectorCell</span></span><br><span class="line">        cell.backgroundColor = <span class="type">UIColor</span>.randomColor()</span><br><span class="line">        cell.delegate = <span class="keyword">self</span></span><br><span class="line">        <span class="comment">// 设置图片</span></span><br><span class="line">        cell.image = indexPath.item &lt; photos.<span class="built_in">count</span> ? photos[indexPath.item] : <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - PhotoSelectorCellDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorSelectPhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        UIIimagePickerController专门用来选择照片的</span><br><span class="line">        PhotoLibrary : 照片库（所有的照片，拍照&amp;用iTunes &amp; photo 同步的照片，不能删除）</span><br><span class="line">        SavePPhotosAlbum 相册（自助机拍摄的，可以删除）</span><br><span class="line">        Camera 相机</span><br><span class="line">        */</span></span><br><span class="line">        <span class="keyword">if</span> !<span class="type">UIImagePickerController</span>.isSourceTypeAvailable(<span class="type">UIImagePickerControllerSourceType</span>.photoLibrary) &#123;</span><br><span class="line">            <span class="comment">// 没有授权</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> vc = <span class="type">UIImagePickerController</span>()</span><br><span class="line">        vc.delegate = <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许编辑 - 如果上传头像，记得把这个属性打开</span></span><br><span class="line">        <span class="comment">// 能够建立一个正方形的图像，方便后续的头像处理</span></span><br><span class="line">        <span class="comment">//        vc.allowsEditing = true</span></span><br><span class="line"></span><br><span class="line">        present(vc, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">photoSelectorRemovePhoto</span><span class="params">(cell: PhotoSelectorCell)</span></span> &#123;</span><br><span class="line">        <span class="comment">// indexpatch</span></span><br><span class="line">        <span class="keyword">let</span> indexPath = collectionView.indexPath(<span class="keyword">for</span>: cell)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除照片</span></span><br><span class="line">        photos.remove(at: indexPath!.item)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新</span></span><br><span class="line">        collectionView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - UIImagePickerControllerDelegate, UINavigationControllerDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">imagePickerController</span><span class="params">(<span class="number">_</span> picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [String : Any])</span></span> &#123;</span><br><span class="line">        <span class="comment">// 提示：所有关于相册的处理，都需要处理内存</span></span><br><span class="line">        <span class="comment">//        print(info)</span></span><br><span class="line">        <span class="comment">// 获取图片</span></span><br><span class="line">        <span class="comment">//        print(info[UIImagePickerControllerOriginalImage] as Any)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将图片保存到数组中</span></span><br><span class="line">        <span class="keyword">if</span> photos.<span class="built_in">count</span> &lt; kMaxPhotoSelectCount - <span class="number">1</span> &#123;</span><br><span class="line">            photos.append(info[<span class="type">UIImagePickerControllerOriginalImage</span>] <span class="keyword">as</span>! <span class="type">UIImage</span>)</span><br><span class="line">            collectionView.reloadData()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭</span></span><br><span class="line">        dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E7%85%A7%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A82.gif" alt="image"></p>
<h3 id="内存问题处理"><a href="#内存问题处理" class="headerlink" title="内存问题处理"></a>内存问题处理</h3><h4 id="UIImageJPEGRepresentation"><a href="#UIImageJPEGRepresentation" class="headerlink" title="UIImageJPEGRepresentation"></a>UIImageJPEGRepresentation</h4><p>使用UIImageJPEGRepresentation(, )来压缩图片会严重影响图片质量</p>
<ul>
<li>解压缩性能消耗太大，苹果不推荐</li>
<li>JPEG压缩图片是不保真的，压缩后可能很难看</li>
</ul>
<h4 id="写入到本地"><a href="#写入到本地" class="headerlink" title="写入到本地"></a>写入到本地</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> image = info[<span class="type">UIImagePickerControllerOriginalImage</span>] <span class="keyword">as</span>! <span class="type">UIImage</span></span><br><span class="line"><span class="keyword">let</span> data1 = <span class="type">UIImageJPEGRepresentation</span>(image, <span class="number">1.0</span>)</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> data1?.write(to: <span class="type">URL</span>(string: <span class="string">"Users/Daisuke/Desktop/1.jpg"</span>)!, options: <span class="type">Data</span>.<span class="type">WritingOptions</span>.atomic)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"捕捉到异常"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="内存警告"><a href="#内存警告" class="headerlink" title="内存警告"></a>内存警告</h4><ul>
<li>关于应用程序内存，UI的APP空的程序运行占用20M左右，一般程序消耗100M以内都是可以接受的</li>
<li>内存飙升到500M接受到第一次内存警告，内存释放后的结果120M，程序仍然能够正常运行</li>
</ul>
<h4 id="缩放图片-1"><a href="#缩放图片-1" class="headerlink" title="缩放图片"></a>缩放图片</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIImage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 将图片缩放到指定宽度</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scaleImageToWidth</span><span class="params">(width:CGFloat)</span></span> -&gt; <span class="type">UIImage</span> &#123;</span><br><span class="line">        <span class="comment">// 提示：不要使用比例，如果所有照片都按照指定比例来缩放，图片太小就看不见了</span></span><br><span class="line">        <span class="comment">// 判断宽度，如果小于指定宽度直接返回对象</span></span><br><span class="line">        <span class="keyword">if</span> size.width &lt; width &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算等比例缩放的高度</span></span><br><span class="line">        <span class="keyword">let</span> height = width * size.height / size.width</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 图像的上下文</span></span><br><span class="line">        <span class="keyword">let</span> sizeContext = <span class="type">CGSize</span>(width: width, height: height)</span><br><span class="line">        <span class="type">UIGraphicsBeginImageContext</span>(sizeContext)</span><br><span class="line">        <span class="comment">// 在指定区域中缩放绘制完整图像</span></span><br><span class="line">        draw(<span class="keyword">in</span>: <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>.zero, size: sizeContext))</span><br><span class="line">        <span class="comment">// 获取绘制结果</span></span><br><span class="line">        <span class="keyword">let</span> result = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">        <span class="comment">// 关闭上下文</span></span><br><span class="line">        <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line">        <span class="keyword">return</span> result!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将图片保存到数组中</span></span><br><span class="line"><span class="keyword">if</span> photos.<span class="built_in">count</span> &lt; kMaxPhotoSelectCount - <span class="number">1</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> image = info[<span class="type">UIImagePickerControllerOriginalImage</span>] <span class="keyword">as</span>! <span class="type">UIImage</span></span><br><span class="line">    image = image.scaleImageToWidth(width: <span class="number">300</span>)</span><br><span class="line">    photos.append(image)</span><br><span class="line">    collectionView.reloadData()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-21-15-25-27"><a href="#更新时间：2018-05-21-15-25-27" class="headerlink" title="更新时间：2018-05-21 15:25:27"></a>更新时间：2018-05-21 15:25:27</h2><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><h4 id="NSRegularExpression"><a href="#NSRegularExpression" class="headerlink" title="NSRegularExpression"></a>NSRegularExpression</h4><ul>
<li>NSRegularExpressionCaseInsensitive             = 1 &lt;&lt; 0,     忽略大小写</li>
<li>NSRegularExpressionAllowCommentsAndWhitespace  = 1 &lt;&lt; 1,     忽略空白字符，以及前缀是 # 开始的注释</li>
<li>NSRegularExpressionIgnoreMetacharacters        = 1 &lt;&lt; 2,     将整个匹配方案作为文字字符串</li>
<li>NSRegularExpressionDotMatchesLineSeparators    = 1 &lt;&lt; 3,     允许 . 匹配任意字符，包括回车换行</li>
<li>NSRegularExpressionAnchorsMatchLines           = 1 &lt;&lt; 4,     允许 ^ 和 $ 匹配多行文本的开始和结尾</li>
<li>NSRegularExpressionUseUnixLineSeparators       = 1 &lt;&lt; 5,     仅将 \n 作为换行符</li>
<li>NSRegularExpressionUseUnicodeWordBoundaries    = 1 &lt;&lt; 6      使用 Unicode TR#29 指定单词边界</li>
</ul>
<h4 id="方法介绍"><a href="#方法介绍" class="headerlink" title="方法介绍"></a>方法介绍</h4><ul>
<li>open func numberOfMatches(in string: String, options: NSRegularExpression.MatchingOptions = [], range: NSRange) -&gt; Int（返回正确匹配的个数）</li>
<li>open func firstMatch(in string: String, options: NSRegularExpression.MatchingOptions = [], range: NSRange) -&gt; NSTextCheckingResult?（返回第一个匹配的结果）</li>
<li>open func rangeOfFirstMatch(in string: String, options: NSRegularExpression.MatchingOptions = [], range: NSRange) -&gt; NSRange（返回第一个正确匹配结果字符串的NSRange）</li>
<li>open func matches(in string: String, options: NSRegularExpression.MatchingOptions = [], range: NSRange) -&gt; [NSTextCheckingResult]（返回所有匹配结果的集合（适合从一段字符串中提取我们想要匹配的所有数据））</li>
</ul>
<h3 id="练习匹配微博正文"><a href="#练习匹配微博正文" class="headerlink" title="练习匹配微博正文"></a>练习匹配微博正文</h3><h4 id="匹配URL"><a href="#匹配URL" class="headerlink" title="匹配URL"></a>匹配URL</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">urlRegex</span><span class="params">(str:String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 创建匹配对象</span></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        NSDataDetector：是NSRegularExpression的子类，里面能够匹配URL,电话,日期,地址</span><br><span class="line">        */</span></span><br><span class="line">        <span class="keyword">let</span> dataDetector = <span class="keyword">try</span> <span class="type">NSDataDetector</span>(types: <span class="type">NSTextCheckingTypes</span>(<span class="type">NSTextCheckingResult</span>.<span class="type">CheckingType</span>.link.rawValue))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 匹配所有的URL</span></span><br><span class="line">        <span class="keyword">let</span> array = dataDetector.matches(<span class="keyword">in</span>: str, options: <span class="type">NSRegularExpression</span>.<span class="type">MatchingOptions</span>(rawValue: <span class="number">0</span>), range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, str.<span class="built_in">count</span>))</span><br><span class="line">        <span class="keyword">if</span> array.<span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> checking <span class="keyword">in</span> array &#123;</span><br><span class="line">                <span class="built_in">print</span>((str <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: checking.range))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="匹配表情、用户名、话题、URL"><a href="#匹配表情、用户名、话题、URL" class="headerlink" title="匹配表情、用户名、话题、URL"></a>匹配表情、用户名、话题、URL</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contentRegex</span><span class="params">(str:String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        - . 匹配任意字符，除了换行</span><br><span class="line">        - * 匹配任意长度的内容</span><br><span class="line">        - ? 尽量少的匹配</span><br><span class="line">        */</span></span><br><span class="line">        <span class="comment">// 1.创建规则</span></span><br><span class="line">        <span class="comment">// 1.1表情规则</span></span><br><span class="line">        <span class="keyword">let</span> emoticonPattern = <span class="string">"\\[.*?\\]"</span></span><br><span class="line">        <span class="comment">// 1.2用户名规则</span></span><br><span class="line">        <span class="keyword">let</span> atPattern = <span class="string">"@.*?:"</span></span><br><span class="line">        <span class="comment">// 1.3话题规则</span></span><br><span class="line">        <span class="keyword">let</span> topicPattern = <span class="string">"#.*?#"</span></span><br><span class="line">        <span class="comment">// 1.4url规则</span></span><br><span class="line">        <span class="keyword">let</span> urlPattern = <span class="string">"http(s)?://([\\w-]+\\.)+[\\w-]+(/[\\w- ./?%&amp;=]*)?"</span></span><br><span class="line">        <span class="keyword">let</span> pattern = emoticonPattern + <span class="string">"|"</span> + atPattern + <span class="string">"|"</span> + topicPattern + <span class="string">"|"</span> + urlPattern</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建正则表达式对象</span></span><br><span class="line">        <span class="keyword">let</span> regex = <span class="keyword">try</span> <span class="type">NSRegularExpression</span>(pattern: pattern, options: <span class="type">NSRegularExpression</span>.<span class="type">Options</span>(rawValue: <span class="number">0</span>))</span><br><span class="line">        <span class="comment">// 开始匹配</span></span><br><span class="line">        <span class="keyword">let</span> array = regex.matches(<span class="keyword">in</span>: str, options: <span class="type">NSRegularExpression</span>.<span class="type">MatchingOptions</span>(rawValue: <span class="number">0</span>), range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, str.<span class="built_in">count</span>))</span><br><span class="line">        <span class="keyword">if</span> array.<span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> checking <span class="keyword">in</span> array &#123;</span><br><span class="line">                <span class="built_in">print</span>((str <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: checking.range))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">"@jack12:【动物尖叫合辑】#肥猪流#猫头鹰这么尖叫[偷笑]、@南哥: 老鼠这么尖叫、兔子这么尖叫[吃惊]、@花满楼: 莫名奇#小笼包#妙的笑到最后[挖鼻屎]！~ http://t.cn/zYBuKZ8"</span></span><br><span class="line">    urlRegex(str: str) <span class="comment">// http://t.cn/zYBuKZ8</span></span><br><span class="line">    contentRegex(str: str)</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    @jack12:</span><br><span class="line">    #肥猪流#</span><br><span class="line">    [偷笑]</span><br><span class="line">    @南哥:</span><br><span class="line">    [吃惊]</span><br><span class="line">    @花满楼:</span><br><span class="line">    #小笼包#</span><br><span class="line">    [挖鼻屎]</span><br><span class="line">    http://t.cn/zYBuKZ8</span><br><span class="line">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成表情文字"><a href="#生成表情文字" class="headerlink" title="生成表情文字"></a>生成表情文字</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">emoticonRegex</span><span class="params">(str:String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> strM = <span class="type">NSMutableAttributedString</span>(string: str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 创建规则</span></span><br><span class="line">        <span class="keyword">let</span> pattern = <span class="string">"\\[.*?\\]"</span></span><br><span class="line">        <span class="comment">// 创建正则对象</span></span><br><span class="line">        <span class="keyword">let</span> regex = <span class="keyword">try</span> <span class="type">NSRegularExpression</span>(pattern: pattern, options: <span class="type">NSRegularExpression</span>.<span class="type">Options</span>(rawValue: <span class="number">0</span>))</span><br><span class="line">        <span class="comment">// 开始匹配</span></span><br><span class="line">        <span class="keyword">let</span> array = regex.matches(<span class="keyword">in</span>: str, options: <span class="type">NSRegularExpression</span>.<span class="type">MatchingOptions</span>(rawValue: <span class="number">0</span>), range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, str.<span class="built_in">count</span>))</span><br><span class="line">        <span class="comment">// 遍历结果数组</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">count</span> = array.<span class="built_in">count</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// 拿到匹配结果</span></span><br><span class="line">            <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">let</span> res = array[<span class="built_in">count</span>]</span><br><span class="line">            <span class="comment">// 拿到range</span></span><br><span class="line">            <span class="keyword">let</span> range = res.range</span><br><span class="line">            <span class="comment">// 拿到匹配的字符串</span></span><br><span class="line">            <span class="keyword">let</span> tempStr = (str <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: range)</span><br><span class="line">            <span class="comment">// 查找模型</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> emoticon = emotcionWithStr(str: tempStr)&#123;</span><br><span class="line">                <span class="comment">// 生成属性字符串</span></span><br><span class="line">                <span class="keyword">let</span> attstr = <span class="type">EmoticonTextAttachment</span>.imageText(emoticon: emoticon, font: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">17</span>))</span><br><span class="line">                <span class="comment">// 替换表情</span></span><br><span class="line">                strM.replaceCharacters(<span class="keyword">in</span>: range, with: attstr)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(strM)</span><br><span class="line">            <span class="keyword">self</span>.customLabel.attributedText = strM</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">    <span class="built_in">print</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 根据指定字符串获得表情模型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">emotcionWithStr</span><span class="params">(str:String)</span></span> -&gt; <span class="type">Emoticon</span>? &#123;</span><br><span class="line">    <span class="keyword">var</span> emoticon:<span class="type">Emoticon</span>?</span><br><span class="line">    <span class="keyword">for</span> package <span class="keyword">in</span> <span class="type">EmoticonPackage</span>.packages() &#123;</span><br><span class="line">        emoticon = package.emoticons?.<span class="built_in">filter</span>(&#123; (emo) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> emo.chs == str</span><br><span class="line">        &#125;).last</span><br><span class="line">        <span class="keyword">if</span> emoticon != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> emoticon</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emoticonRegex(str: <span class="string">"我[爱你]好久了[好爱哦]"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibo%E6%AD%A3%E5%88%991.png" alt="image"></p>
<h3 id="生成表情文字重构"><a href="#生成表情文字重构" class="headerlink" title="生成表情文字重构"></a>生成表情文字重构</h3><p>在EmoticonPackage.swift中把生成表情字符串的方法封装在里面</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">let</span> packageList: [<span class="type">EmoticonPackage</span>] = <span class="type">EmoticonPackage</span>.packages()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">emoticonRegex</span>(<span class="title">str</span>:<span class="title">String</span>) -&gt;<span class="title">NSAttributedString</span>?</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> strM = <span class="type">NSMutableAttributedString</span>(string: str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 创建规则</span></span><br><span class="line">        <span class="keyword">let</span> pattern = <span class="string">"\\[.*?\\]"</span></span><br><span class="line">        <span class="comment">// 创建正则对象</span></span><br><span class="line">        <span class="keyword">let</span> regex = <span class="keyword">try</span> <span class="type">NSRegularExpression</span>(pattern: pattern, options: <span class="type">NSRegularExpression</span>.<span class="type">Options</span>(rawValue: <span class="number">0</span>))</span><br><span class="line">        <span class="comment">// 开始匹配</span></span><br><span class="line">        <span class="keyword">let</span> array = regex.matches(<span class="keyword">in</span>: str, options: <span class="type">NSRegularExpression</span>.<span class="type">MatchingOptions</span>(rawValue: <span class="number">0</span>), range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, str.<span class="built_in">count</span>))</span><br><span class="line">        <span class="comment">// 遍历结果数组</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">count</span> = array.<span class="built_in">count</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// 拿到匹配结果</span></span><br><span class="line">            <span class="built_in">count</span> -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">let</span> res = array[<span class="built_in">count</span>]</span><br><span class="line">            <span class="comment">// 拿到range</span></span><br><span class="line">            <span class="keyword">let</span> range = res.range</span><br><span class="line">            <span class="comment">// 拿到匹配的字符串</span></span><br><span class="line">            <span class="keyword">let</span> tempStr = (str <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: range)</span><br><span class="line">            <span class="comment">// 查找模型</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> emoticon = emotcionWithStr(str: tempStr)&#123;</span><br><span class="line">                <span class="comment">// 生成属性字符串</span></span><br><span class="line">                <span class="keyword">let</span> attstr = <span class="type">EmoticonTextAttachment</span>.imageText(emoticon: emoticon, font: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">17</span>))</span><br><span class="line">                <span class="comment">// 替换表情</span></span><br><span class="line">                strM.replaceCharacters(<span class="keyword">in</span>: range, with: attstr)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> strM</span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 根据指定字符串获得表情模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">emotcionWithStr</span>(<span class="title">str</span>:<span class="title">String</span>) -&gt; <span class="title">Emoticon</span>? </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> emoticon:<span class="type">Emoticon</span>?</span><br><span class="line">    <span class="keyword">for</span> package <span class="keyword">in</span> <span class="type">EmoticonPackage</span>.packageList &#123;</span><br><span class="line">        emoticon = package.emoticons?.<span class="built_in">filter</span>(&#123; (emo) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> emo.chs == str</span><br><span class="line">        &#125;).last</span><br><span class="line">        <span class="keyword">if</span> emoticon != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> emoticon</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-22-14-42-22"><a href="#更新时间：2018-05-22-14-42-22" class="headerlink" title="更新时间：2018-05-22 14:42:22"></a>更新时间：2018-05-22 14:42:22</h2><h3 id="TextKit基本使用"><a href="#TextKit基本使用" class="headerlink" title="TextKit基本使用"></a>TextKit基本使用</h3><blockquote>
<p>初衷：创建一个文本控件，自动识别URL并可以点击。</p>
</blockquote>
<h4 id="创建DDLabel继承与UILabel"><a href="#创建DDLabel继承与UILabel" class="headerlink" title="创建DDLabel继承与UILabel"></a>创建DDLabel继承与UILabel</h4><h4 id="声明三个属性"><a href="#声明三个属性" class="headerlink" title="声明三个属性"></a>声明三个属性</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - 懒加载</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line">只要textStorage中的内容发生变化，就可以通知layoutManager重新布局</span><br><span class="line">layoutManager重新布局需要知道绘制到什么地方，所以layoutManager就会找textContainer绘制的区域</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 专门用于存储内容的。textStorage 中有 layoutManager</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> textStorage = <span class="type">NSTextStorage</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 专门用于管理布局的。layoutManager 中有 textContainer</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> layoutManager = <span class="type">NSLayoutManager</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 专门用于指定绘制的区域</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> textContainer = <span class="type">NSTextContainer</span>()</span><br></pre></td></tr></table></figure>
<h4 id="重写初始化方法"><a href="#重写初始化方法" class="headerlink" title="重写初始化方法"></a>重写初始化方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    setupSystem()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(coder: aDecoder)</span><br><span class="line">    setupSystem()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupSystem</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、将layoutManager添加到textStorage中</span></span><br><span class="line">    textStorage.addLayoutManager(layoutManager)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、将textContainer添加到layoutManager</span></span><br><span class="line">    layoutManager.addTextContainer(textContainer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重写布局方法"><a href="#重写布局方法" class="headerlink" title="重写布局方法"></a>重写布局方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.layoutSubviews()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、指定区域</span></span><br><span class="line">    textContainer.size = bounds.size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重写绘制方法"><a href="#重写绘制方法" class="headerlink" title="重写绘制方法"></a>重写绘制方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 如果UILabel调用setNeedsDisplay方法，系统会触发drawText方法</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">drawText</span><span class="params">(<span class="keyword">in</span> rect: CGRect)</span></span> &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    重绘字形，理解为一个小的UIView</span><br><span class="line"></span><br><span class="line">    forGlyphRange: 指定绘制的范围</span><br><span class="line">    at：指定从什么位置开始绘制</span><br><span class="line">    */</span></span><br><span class="line">    layoutManager.drawGlyphs(forGlyphRange: <span class="type">NSMakeRange</span>(<span class="number">0</span>, text!.<span class="built_in">count</span>), at: <span class="type">CGPoint</span>.zero)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重写text属性"><a href="#重写text属性" class="headerlink" title="重写text属性"></a>重写text属性</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> text: <span class="type">String</span>?&#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        <span class="comment">// 1、修改textStorage存储的内容</span></span><br><span class="line">        textStorage.setAttributedString(<span class="type">NSAttributedString</span>(string: text!))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、设置textStorage的属性</span></span><br><span class="line">        textStorage.addAttribute(<span class="type">NSFontAttributeName</span>, value: font, range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, text!.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理URL</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="type">URLRegex</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知layoutManager重新布局</span></span><br><span class="line">        setNeedsDisplay()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 匹配URL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">URLRegex</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 创建正则表达式对象</span></span><br><span class="line">        <span class="keyword">let</span> dataDerector = <span class="keyword">try</span> <span class="type">NSDataDetector</span>(types: <span class="type">NSTextCheckingResult</span>.<span class="type">CheckingType</span>.link.rawValue)</span><br><span class="line">        <span class="comment">// 匹配</span></span><br><span class="line">        <span class="keyword">let</span> resArray = dataDerector.matches(<span class="keyword">in</span>: textStorage.string, options: <span class="type">NSRegularExpression</span>.<span class="type">MatchingOptions</span>(rawValue: <span class="number">0</span>), range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, textStorage.string.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出结果</span></span><br><span class="line">        <span class="keyword">for</span> checkingRes <span class="keyword">in</span> resArray &#123;</span><br><span class="line">            <span class="keyword">let</span> str = (textStorage.string <span class="keyword">as</span> <span class="type">NSString</span>).substring(with: checkingRes.range)</span><br><span class="line">            <span class="keyword">let</span> tempStr = <span class="type">NSMutableAttributedString</span>(string: str)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置属性</span></span><br><span class="line">            tempStr.addAttributes([<span class="type">NSFontAttributeName</span> : font!, <span class="type">NSForegroundColorAttributeName</span> : <span class="type">UIColor</span>.red], range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, str.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">            textStorage.replaceCharacters(<span class="keyword">in</span>: checkingRes.range, with: tempStr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>  &#123;</span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p><img src="http://7xv233.com1.z0.glb.clouddn.com/weibotextkit1.png" alt="image"></p>
<h3 id="键盘变化处理"><a href="#键盘变化处理" class="headerlink" title="键盘变化处理"></a>键盘变化处理</h3><h4 id="添加键盘通知"><a href="#添加键盘通知" class="headerlink" title="添加键盘通知"></a>添加键盘通知</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册通知监听键盘</span></span><br><span class="line"><span class="type">NotificationCenter</span>.<span class="keyword">default</span>.addObserver(<span class="keyword">self</span>, selector: #selector(keyboardChange(notify:)), name: <span class="type">NSNotification</span>.<span class="type">Name</span>.<span class="type">UIKeyboardWillChangeFrame</span>, object: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<h4 id="注销通知-1"><a href="#注销通知-1" class="headerlink" title="注销通知"></a>注销通知</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">deinit</span> &#123;</span><br><span class="line">    <span class="comment">// 注销通知</span></span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.removeObserver(<span class="keyword">self</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="keyboardChange方法"><a href="#keyboardChange方法" class="headerlink" title="keyboardChange方法"></a>keyboardChange方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keyboardChange</span><span class="params">(notify: Notification)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取最终的frame - oc中将结构体保存在字典中，存成NSValue</span></span><br><span class="line">    <span class="keyword">let</span> value = notify.userInfo![<span class="type">UIKeyboardFrameEndUserInfoKey</span>] <span class="keyword">as</span>! <span class="type">NSValue</span></span><br><span class="line">    <span class="keyword">let</span> rect = value.cgRectValue</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> height = <span class="type">UIScreen</span>.main.bounds.height</span><br><span class="line">    toolbarBottomCons?.constant = -(height - rect.origin.y)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新页面</span></span><br><span class="line">    <span class="keyword">let</span> duration = notify.userInfo![<span class="type">UIKeyboardAnimationDurationUserInfoKey</span>] <span class="keyword">as</span>! <span class="type">NSNumber</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    工具条回弹是因为执行了两次动画，而系统自带的键盘的动画节奏（曲线） 7</span><br><span class="line">    7 在Apple API中并没有提供我们，但是我们可以用7 这种节奏的特点</span><br><span class="line">    ：如果连续执行两次动画，不管上一次有没有执行完毕，都会立刻执行下一次，也就是说上一次可能会被忽略</span><br><span class="line"></span><br><span class="line">    如果将动画节奏设置为7，那么动画的时长无论如何都会自动修改为0.5</span><br><span class="line">    UIView动画的本质是核心动画，所以可以给核心动画设置动画节奏</span><br><span class="line">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出键盘的动画节奏</span></span><br><span class="line">    <span class="keyword">let</span> curve = notify.userInfo![<span class="type">UIKeyboardAnimationCurveUserInfoKey</span>] <span class="keyword">as</span>! <span class="type">NSNumber</span></span><br><span class="line"></span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: duration.doubleValue) &#123;</span><br><span class="line">        <span class="comment">// 设置动画节奏</span></span><br><span class="line">        <span class="type">UIView</span>.setAnimationCurve(<span class="type">UIViewAnimationCurve</span>(rawValue: curve.intValue)!)</span><br><span class="line">        <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集成图片选择器"><a href="#集成图片选择器" class="headerlink" title="集成图片选择器"></a>集成图片选择器</h3><h4 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 图片选择器</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> photoSelectorVC:<span class="type">PhotoSelectorController</span> = <span class="type">PhotoSelectorController</span>()</span><br></pre></td></tr></table></figure>
<p>添加photoSelectorVC</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addChildViewController(photoSelectorVC)</span><br></pre></td></tr></table></figure>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupPhotoView</span><span class="params">()</span></span>&#123;</span><br><span class="line">    view.insertSubview(photoSelectorVC.view, belowSubview: toolbar)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 布局</span></span><br><span class="line">    <span class="keyword">let</span> size = <span class="type">UIScreen</span>.main.bounds.size</span><br><span class="line">    <span class="keyword">let</span> width = size.width</span><br><span class="line">    <span class="keyword">let</span> height:<span class="type">CGFloat</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> cons = photoSelectorVC.view.xmg_AlignInner(type: <span class="type">XMG_AlignType</span>.bottomLeft, referView: view, size: <span class="type">CGSize</span>(width: width, height: height))</span><br><span class="line">    photoViewHeightCons = photoSelectorVC.view.xmg_Constraint(cons, attribute: <span class="type">NSLayoutAttribute</span>.height)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="工具条事件"><a href="#工具条事件" class="headerlink" title="工具条事件"></a>工具条事件</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 切换图片选择器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectPicture</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 关闭键盘</span></span><br><span class="line">    textView.resignFirstResponder()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调整图片选择器的高度</span></span><br><span class="line">    photoViewHeightCons?.constant = <span class="type">UIScreen</span>.main.bounds.height * <span class="number">0.6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送图片微博"><a href="#发送图片微博" class="headerlink" title="发送图片微博"></a>发送图片微博</h3><h3 id="发送图片微博-1"><a href="#发送图片微博-1" class="headerlink" title="发送图片微博"></a>发送图片微博</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">SVProgressHUD</span>.show(withStatus: <span class="string">"正在发送。。。"</span>)</span><br><span class="line">    <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>: <span class="type">UserAccount</span>.loadAccount()?.access_token, <span class="string">"status"</span>:textView.emoticonAttributeText()]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> image = photoSelectorVC.photos.first &#123;</span><br><span class="line">        <span class="comment">// 发送图片微博</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> path = <span class="string">"2/statuses/upload.json"</span></span><br><span class="line">        <span class="type">NetworkTools</span>.shareNetworkTools().post(path, parameters: params, constructingBodyWith: &#123; (formData) <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 将数据转为二进制</span></span><br><span class="line">            <span class="keyword">let</span> data = <span class="type">UIImagePNGRepresentation</span>(image)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 上传数据</span></span><br><span class="line">            <span class="comment">/*</span><br><span class="line">            第一个参数：需要上传的二进制数据</span><br><span class="line">            第二个参数：服务器对应哪个字段名称</span><br><span class="line">            第三个参数：文件的名称（大部分服务器可以随便写）</span><br><span class="line">            第四个参数：数据类型，通用类型application/octet-stream</span><br><span class="line">            */</span></span><br><span class="line">            formData.appendPart(withFileData: data!, name: <span class="string">"pic"</span>, fileName: <span class="string">"pic.png"</span>, mimeType: <span class="string">"application/octet-stream"</span>)</span><br><span class="line"></span><br><span class="line">        &#125;, progress: <span class="literal">nil</span>, success: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">            <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">            <span class="comment">// 提示用户发送成功</span></span><br><span class="line">            <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送成功"</span>)</span><br><span class="line">            <span class="comment">// 关闭发送页面</span></span><br><span class="line">            <span class="keyword">self</span>.close()</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">            <span class="type">SVProgressHUD</span>.showError(withStatus: <span class="string">"发送失败"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> path = <span class="string">"2/statuses/update.json"</span></span><br><span class="line">        <span class="type">NetworkTools</span>.shareNetworkTools().post(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">            <span class="type">SVProgressHUD</span>.dismiss()</span><br><span class="line">            <span class="comment">// 提示用户发送成功</span></span><br><span class="line">            <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送成功"</span>)</span><br><span class="line">            <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 关闭页面</span></span><br><span class="line">            <span class="keyword">self</span>.close()</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">            <span class="comment">// 提示发送失败</span></span><br><span class="line">            <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送失败"</span>)</span><br><span class="line">            <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重构发送图片微博"><a href="#重构发送图片微博" class="headerlink" title="重构发送图片微博"></a>重构发送图片微博</h3><p>在NetworkTools.swift类中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendStatus</span><span class="params">(text:String, image:UIImage?, successCallBack:@escaping <span class="params">(<span class="number">_</span> status: Status)</span></span></span> -&gt;(), errorCallBack:@escaping (<span class="number">_</span> error: <span class="type">Error</span>)-&gt;()) &#123;</span><br><span class="line">    <span class="keyword">var</span> path = <span class="string">"2/statuses/"</span></span><br><span class="line">    <span class="keyword">let</span> params = [<span class="string">"access_token"</span>: <span class="type">UserAccount</span>.loadAccount()?.access_token, <span class="string">"status"</span>:text]</span><br><span class="line">    <span class="keyword">if</span> image != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 发送图片微博</span></span><br><span class="line">        path += <span class="string">"upload.json"</span></span><br><span class="line">        post(path, parameters: params, constructingBodyWith: &#123; (formData) <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 将数据转为二进制</span></span><br><span class="line">            <span class="keyword">let</span> data = <span class="type">UIImagePNGRepresentation</span>(image!)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 上传数据</span></span><br><span class="line">            <span class="comment">/*</span><br><span class="line">            第一个参数：需要上传的二进制数据</span><br><span class="line">            第二个参数：服务器对应哪个字段名称</span><br><span class="line">            第三个参数：文件的名称（大部分服务器可以随便写）</span><br><span class="line">            第四个参数：数据类型，通用类型application/octet-stream</span><br><span class="line">            */</span></span><br><span class="line">            formData.appendPart(withFileData: data!, name: <span class="string">"pic"</span>, fileName: <span class="string">"pic.png"</span>, mimeType: <span class="string">"application/octet-stream"</span>)</span><br><span class="line"></span><br><span class="line">        &#125;, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> status = <span class="type">Status</span>(dict: (json <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>]))</span><br><span class="line">            successCallBack(status)</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">            errorCallBack(error)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path += <span class="string">"update.json"</span></span><br><span class="line">        post(path, parameters: params, progress: <span class="literal">nil</span>, success: &#123; (<span class="number">_</span>, json) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> status = <span class="type">Status</span>(dict: (json <span class="keyword">as</span>! [<span class="type">String</span> : <span class="type">AnyObject</span>]))</span><br><span class="line">            successCallBack(status)</span><br><span class="line">        &#125;) &#123; (<span class="number">_</span>, error) <span class="keyword">in</span></span><br><span class="line">            errorCallBack(error <span class="keyword">as</span> <span class="type">NSError</span> )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> text = textView.emoticonAttributeText()</span><br><span class="line">    <span class="keyword">let</span> image = photoSelectorVC.photos.first</span><br><span class="line"></span><br><span class="line">    <span class="type">SVProgressHUD</span>.show(withStatus: <span class="string">"正在发送。。。"</span>)</span><br><span class="line">    <span class="type">SVProgressHUD</span>.setDefaultMaskType(<span class="type">SVProgressHUDMaskType</span>.black)</span><br><span class="line">    <span class="type">NetworkTools</span>.shareNetworkTools().sendStatus(text: text, image: image, successCallBack: &#123; (status) <span class="keyword">in</span></span><br><span class="line">        <span class="comment">// 提示用户发送成功</span></span><br><span class="line">        <span class="type">SVProgressHUD</span>.showSuccess(withStatus: <span class="string">"发送成功"</span>)</span><br><span class="line">    &#125;) &#123; (error) <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line">        <span class="type">SVProgressHUD</span>.showError(withStatus: <span class="string">"发送失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发布页面字数提醒"><a href="#发布页面字数提醒" class="headerlink" title="发布页面字数提醒"></a>发布页面字数提醒</h3><p>1、提示控件</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> tipLabel: <span class="type">UILabel</span> = <span class="type">UILabel</span>()</span><br></pre></td></tr></table></figure>
<p>2、添加到视图，并布局</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">view.addSubview(tipLabel)</span><br><span class="line"></span><br><span class="line">tipLabel.xmg_AlignVertical(type: <span class="type">XMG_AlignType</span>.topRight, referView: toolbar, size: <span class="literal">nil</span>, offset: <span class="type">CGPoint</span>(x: -<span class="number">10</span>, y: -<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<p>3、设置提示数据</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">textViewDidChange</span><span class="params">(<span class="number">_</span> textView: UITextView)</span></span> &#123;</span><br><span class="line">    placeholderLabel.isHidden = textView.hasText</span><br><span class="line">    navigationItem.rightBarButtonItem?.isEnabled = textView.hasText</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当已经输入的内容长度</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = textView.emoticonAttributeText().<span class="built_in">count</span></span><br><span class="line">    <span class="keyword">let</span> res = maxTipLength - <span class="built_in">count</span></span><br><span class="line">    tipLabel.textColor = (res &gt; <span class="number">0</span>) ? <span class="type">UIColor</span>.darkGray : <span class="type">UIColor</span>.red</span><br><span class="line">    tipLabel.text = res == maxTipLength ? <span class="string">""</span> : <span class="string">"\(res)"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示首页表情"><a href="#显示首页表情" class="headerlink" title="显示首页表情"></a>显示首页表情</h3><p>在StatusTableViewCell.swift中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status:<span class="type">Status</span>? &#123;</span><br><span class="line">    <span class="keyword">didSet</span>&#123;</span><br><span class="line">        topView.status = status</span><br><span class="line"></span><br><span class="line">        <span class="comment">//            contentLabel.text = status?.text</span></span><br><span class="line">        contentLabel.attributedText = <span class="type">EmoticonPackage</span>.emoticonRegex(str: status?.text ?? <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置配图数据</span></span><br><span class="line">        pictureView.status = status?.retweeted_status != <span class="literal">nil</span> ? status?.retweeted_status : status</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置配图尺寸</span></span><br><span class="line">        <span class="keyword">let</span> size = pictureView.calculateImageSize()</span><br><span class="line">        pictureWidthCons?.constant = size.width</span><br><span class="line">        pictureHeightCons?.constant = size.height</span><br><span class="line">        pictureTopCons?.constant = size.height == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更新时间：2018-05-23-10-28-27"><a href="#更新时间：2018-05-23-10-28-27" class="headerlink" title="更新时间：2018-05-23 10:28:27"></a>更新时间：2018-05-23 10:28:27</h2><h3 id="SQLite基本使用"><a href="#SQLite基本使用" class="headerlink" title="SQLite基本使用"></a>SQLite基本使用</h3><ul>
<li>创建数据库管理类</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">let</span> manager:<span class="type">SQLiteManager</span> = <span class="type">SQLiteManager</span>()</span><br><span class="line"><span class="comment">/// 单例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">share</span>() -&gt;<span class="title">SQLiteManager</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> manager</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>打开数据库</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 打开数据库, SQLiteName数据路名称</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">openDB</span><span class="params">(SQLiteName:String)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 0、拿到数据库的路径</span></span><br><span class="line">    <span class="keyword">let</span> path = <span class="type">SQLiteName</span>.docDir()</span><br><span class="line">    <span class="built_in">print</span>(path)</span><br><span class="line">    <span class="keyword">let</span> cPath = path.cString(using: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、打开数据库</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    1、需要打开的数据库文件的路径，C语言字符串</span><br><span class="line">    2、打开之后的数据库对象（指针），以后所有的数据库操作，都必须拿到这个指针才能进行相关操作</span><br><span class="line"></span><br><span class="line">    open方法特点：</span><br><span class="line">    1、如果指定路径对应的数据库文件已存在，就会直接打开</span><br><span class="line">    2、如果指定路径对应的数据库文件不存在，就会创建一个新的</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">if</span> sqlite3_open(cPath, &amp;db) != <span class="type">SQLITE_OK</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"打开数据库失败"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建表</span></span><br><span class="line">    <span class="keyword">if</span> createTable() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"创建表成功"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"创建表失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建表</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createTable</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">// 1、编写SQL语句</span></span><br><span class="line">    <span class="comment">// 建议：在开发中编写SQL语句，如果语句过长，不要写在一行</span></span><br><span class="line">    <span class="comment">// 开发技巧：在做数据库开发是，如果遇到错误，可以先将SQL打印出来，拷贝到PC工具中验证之后再进行调试</span></span><br><span class="line">    <span class="keyword">let</span> sql = <span class="string">"CREATE TABLE IF NOT EXISTS T_Person( \n"</span> +</span><br><span class="line">    <span class="string">"id INTEGER PRIMARY KEY AUTOINCREMENT, \n"</span> +</span><br><span class="line">    <span class="string">"name TEXT, \n"</span> +</span><br><span class="line">    <span class="string">"age INTEGER \n"</span> +</span><br><span class="line">    <span class="string">"); \n"</span></span><br><span class="line">    <span class="built_in">print</span>(sql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL语句</span></span><br><span class="line">    <span class="keyword">return</span> execSQL(sql: sql)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行SQL语句</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 执行除查询以外的SQL语句</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">execSQL</span><span class="params">(sql:String)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">// 1、将swift字符串转为C语言字符串</span></span><br><span class="line">    <span class="keyword">let</span> cSQL = sql.cString(using: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在sqlite3中，除了查询以外（创建、删除、新增、更新）都是用同一个函数</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    参数1：已经打开的数据库对象</span><br><span class="line">    参数2：需要执行的SQL语句，C语言字符串</span><br><span class="line">    参数3：执行SQL语句之后的回调，一般传nil</span><br><span class="line">    参数4：是第三个参数的第一个参数，一般传nil</span><br><span class="line">    参数5：错误信息，一般传nil</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">if</span> sqlite3_exec(db, cSQL, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>) != <span class="type">SQLITE_OK</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行查询SQL语句</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 查询所有的数据， 返回字典数组</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">execRecordSQL</span><span class="params">(sql:String)</span></span> -&gt; [[<span class="type">String</span>:<span class="type">AnyObject</span>]] &#123;</span><br><span class="line">    <span class="comment">// 1、将swift字符串转为C语言字符串</span></span><br><span class="line">    <span class="keyword">let</span> cSQL = sql.cString(using: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备：理解为预编译SQL语句，检测里面是否有错误等等，他可以提供性能</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    参数1：已经打开的数据库对象</span><br><span class="line">    参数2：需要执行的SQL语句，C语言字符串</span><br><span class="line">    参数3：需要执行的SQL语句的长度，传入-1系统自动计算</span><br><span class="line">    参数4：预编译之后的句柄，已经要想去除数据，就需要这个句柄</span><br><span class="line">    参数5：错误信息，一般传nil</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">var</span> stmt: <span class="type">OpaquePointer</span>? = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> sqlite3_prepare(db, cSQL, -<span class="number">1</span>, &amp;stmt, <span class="literal">nil</span>) != <span class="type">SQLITE_OK</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"准备失败"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备成功</span></span><br><span class="line">    <span class="keyword">var</span> records = [[<span class="type">String</span>: <span class="type">AnyObject</span>]]()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询数据</span></span><br><span class="line">    <span class="comment">// sqlite3_step代表去除一条数据，如果去到了数据就会返回SQLITE_ROW</span></span><br><span class="line">    <span class="keyword">while</span> sqlite3_step(stmt) == <span class="type">SQLITE_ROW</span> &#123;</span><br><span class="line">        <span class="comment">// 获取一条记录的数据</span></span><br><span class="line">        <span class="keyword">let</span> record = recordWithStmt(stmt: stmt!)</span><br><span class="line">        <span class="comment">// 将当前获取到的这一条记录添加到数组</span></span><br><span class="line">        records.append(record)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回查询到的数据</span></span><br><span class="line">    <span class="keyword">return</span> records</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 获取一条疾苦的值，返回字典</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">recordWithStmt</span><span class="params">(stmt:OpaquePointer)</span></span> -&gt; [<span class="type">String</span>:<span class="type">AnyObject</span>] &#123;</span><br><span class="line">    <span class="comment">// 拿到当前这条数据所有的列</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> = sqlite3_column_count(stmt)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义字典存储查询到的数据</span></span><br><span class="line">    <span class="keyword">var</span> record = [<span class="type">String</span>:<span class="type">AnyObject</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</span><br><span class="line">        <span class="comment">// 拿到每一列的名称</span></span><br><span class="line">        <span class="keyword">let</span> cName = sqlite3_column_name(stmt, index)</span><br><span class="line">        <span class="keyword">let</span> name = <span class="type">String</span>(cString: cName!, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到每一列的类型  SQLITE_INTERGER</span></span><br><span class="line">        <span class="keyword">let</span> type = sqlite3_column_type(stmt, index)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">SQLITE_INTEGER</span>:</span><br><span class="line">            <span class="comment">// 整形</span></span><br><span class="line">            <span class="keyword">let</span> num = sqlite3_column_int64(stmt, index)</span><br><span class="line">            record[name!] = <span class="type">Int</span>(num) <span class="keyword">as</span> <span class="type">AnyObject</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">SQLITE_FLOAT</span>:</span><br><span class="line">            <span class="comment">// 浮点型</span></span><br><span class="line">            <span class="keyword">let</span> double = sqlite3_column_double(stmt, index)</span><br><span class="line">            record[name!] = <span class="type">Double</span>(double) <span class="keyword">as</span> <span class="type">AnyObject</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">SQLITE_TEXT</span>:</span><br><span class="line">            <span class="comment">// 文本类型</span></span><br><span class="line">            <span class="keyword">let</span> cText = sqlite3_column_text(stmt, index)</span><br><span class="line">            <span class="keyword">let</span> text = <span class="type">String</span>(cString: cText!)</span><br><span class="line">            record[name!] = text <span class="keyword">as</span> <span class="type">AnyObject</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">SQLITE_NULL</span>:</span><br><span class="line">            <span class="comment">// 空类型</span></span><br><span class="line">            record[name!] = <span class="type">NSNull</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 二进制类型 SQLITE_BLOB</span></span><br><span class="line">            <span class="comment">// 一般情况下，不会往数据库中存储二进制数据</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">""</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建TestPerson类测试"><a href="#创建TestPerson类测试" class="headerlink" title="创建TestPerson类测试"></a>创建TestPerson类测试</h3><p>创建TestPerson类对上述方法进行测试<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPerson</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> id:<span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> age:<span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> name:<span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - 系统内部方法</span></span><br><span class="line">    <span class="keyword">init</span>(dict:[<span class="type">String</span>:<span class="type">AnyObject</span>]) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        setValuesForKeys(dict)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setValue</span><span class="params">(<span class="number">_</span> value: Any?, forUndefinedKey key: String)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - 执行数据源CRUD的操作</span></span><br><span class="line">    <span class="comment">/// 查询所有TestPerson</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">loadPersons</span>() -&gt; [<span class="title">TestPerson</span>] </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> sql = <span class="string">"SELECT * FROM T_Person;"</span></span><br><span class="line">        <span class="keyword">let</span> result = <span class="type">SQLiteManager</span>.share().execRecordSQL(sql: sql)</span><br><span class="line">        <span class="keyword">var</span> models = [<span class="type">TestPerson</span>]()</span><br><span class="line">        <span class="keyword">for</span> dict <span class="keyword">in</span> result &#123;</span><br><span class="line">            models.append(<span class="type">TestPerson</span>(dict: dict))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> models</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 删除记录</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deletePerson</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> sql = <span class="string">"DELETE FROM T_Person WHERE age IS \(self.age);"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">SQLiteManager</span>.share().execSQL(sql: sql)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 更新</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">updatePerson</span><span class="params">(name:String)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> sql = <span class="string">"UPDATE T_Person SET NAME = '\(name)' WHERE age = \(self.age);"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">SQLiteManager</span>.share().execSQL(sql: sql)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 插入一条记录</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">insertPerson</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="built_in">assert</span>(name != <span class="literal">nil</span>, <span class="string">"name必须有值"</span>)</span><br><span class="line">        <span class="keyword">let</span> sql = <span class="string">"INSERT INTI T_Person (name, age) VALUES (\(name!), \(self.age);"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">SQLiteManager</span>.share().execSQL(sql: sql)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><p>进行测试的时候确保已经打开过数据库（也就是创建表格）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开数据库，创建表格</span></span><br><span class="line"><span class="type">SQLiteManager</span>.share().openDB(<span class="type">SQLiteName</span>: <span class="string">"person.sqlite"</span>)</span><br></pre></td></tr></table></figure>
<p>进行10000次插入数据操作<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> start = <span class="type">CFAbsoluteTimeGetCurrent</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10000</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> person = <span class="type">TestPerson</span>(dict: [<span class="string">"name"</span>:<span class="string">"daisuke"</span> <span class="keyword">as</span> <span class="type">AnyObject</span>, <span class="string">"age"</span>:(<span class="number">2</span>+i <span class="keyword">as</span> <span class="type">AnyObject</span>)])</span><br><span class="line">    person.insertPerson()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"耗时：\(CFAbsoluteTimeGetCurrent() - start)"</span>)</span><br><span class="line"><span class="comment">// 耗时：14.7124910354614</span></span><br></pre></td></tr></table></figure></p>
<p>发现这个操作是非常耗时的，理应放在子线程中操作。放在主线程操作妨碍其他操作，体验不好</p>
<h3 id="使用线程"><a href="#使用线程" class="headerlink" title="使用线程"></a>使用线程</h3><p>创建一个串行队列<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 创建一个串行队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> dbQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.daisuke.test"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">execQueueSql</span><span class="params">(action:@escaping <span class="params">(<span class="number">_</span> manager:SQLiteManager)</span></span></span> -&gt;()) &#123;</span><br><span class="line">    <span class="comment">// 开启一个子线程</span></span><br><span class="line">    dbQueue.async &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="type">Thread</span>.current)</span><br><span class="line">        <span class="comment">// 执行闭包</span></span><br><span class="line">        action(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>插入数据方法修改</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 插入一条记录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertQueuePerson</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">assert</span>(name != <span class="literal">nil</span>, <span class="string">"name必须有值"</span>)</span><br><span class="line">    <span class="keyword">let</span> sql = <span class="string">"INSERT INTO T_Person (name, age) VALUES ('\(name!)', \(self.age));"</span></span><br><span class="line"></span><br><span class="line">    <span class="type">SQLiteManager</span>.share().execQueueSql &#123; (manager) <span class="keyword">in</span></span><br><span class="line">        manager.execSQL(sql: sql)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> start = <span class="type">CFAbsoluteTimeGetCurrent</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10000</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> person = <span class="type">TestPerson</span>(dict: [<span class="string">"name"</span>:<span class="string">"daisuke"</span> <span class="keyword">as</span> <span class="type">AnyObject</span>, <span class="string">"age"</span>:(<span class="number">2</span>+i <span class="keyword">as</span> <span class="type">AnyObject</span>)])</span><br><span class="line">    person.insertQueuePerson()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"耗时：\(CFAbsoluteTimeGetCurrent() - start)"</span>)</span><br><span class="line"><span class="comment">// 耗时：0.696339964866638</span></span><br></pre></td></tr></table></figure>
<p>这样就不会阻塞主线程了。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Swift/" rel="tag">#Swift</a>
          
            <a href="/tags/微博/" rel="tag">#微博</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/26/Swift-访问控制/" rel="next" title="Swift-访问控制">
                <i class="fa fa-chevron-left"></i> Swift-访问控制
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/04/27/Swift-微博/"
           data-title="Swift-微博" data-url="http://yoursite.com/2018/04/27/Swift-微博/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="DaiSuke" />
          <p class="site-author-name" itemprop="name">DaiSuke</p>
          <p class="site-description motion-element" itemprop="description">just's like IT</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">33</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/DaisukeZJY" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/DaisukeZJY" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/527447678/home" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#工程地址"><span class="nav-number">1.</span> <span class="nav-text">工程地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建工程"><span class="nav-number">2.</span> <span class="nav-text">创建工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除StoryBoard"><span class="nav-number">3.</span> <span class="nav-text">删除StoryBoard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架搭建"><span class="nav-number">4.</span> <span class="nav-text">框架搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加中间按钮"><span class="nav-number">5.</span> <span class="nav-text">添加中间按钮</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-04-27-14-24-34"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-04-27 14:24:34</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重构MainViewController"><span class="nav-number">1.</span> <span class="nav-text">重构MainViewController</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加VisitorView视图"><span class="nav-number">2.</span> <span class="nav-text">添加VisitorView视图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义协议"><span class="nav-number">2.1.</span> <span class="nav-text">定义协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用弱引用"><span class="nav-number">2.2.</span> <span class="nav-text">使用弱引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写初始化方法注意点"><span class="nav-number">2.3.</span> <span class="nav-text">重写初始化方法注意点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加BaseViewController控制器"><span class="nav-number">3.</span> <span class="nav-text">添加BaseViewController控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主控制器继承基类"><span class="nav-number">4.</span> <span class="nav-text">主控制器继承基类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导航条按钮"><span class="nav-number">5.</span> <span class="nav-text">导航条按钮</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-04-27-16-53-34"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-04-27 16:53:34</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CocoPods"><span class="nav-number">1.</span> <span class="nav-text">CocoPods</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#第三方框架"><span class="nav-number">1.1.</span> <span class="nav-text">第三方框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#项目中使用到以下第三方框架"><span class="nav-number">1.1.1.</span> <span class="nav-text">项目中使用到以下第三方框架</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pod-安装"><span class="nav-number">1.2.</span> <span class="nav-text">Pod 安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在终端提交添加的框架"><span class="nav-number">1.3.</span> <span class="nav-text">在终端提交添加的框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装第三方框架"><span class="nav-number">1.4.</span> <span class="nav-text">安装第三方框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打开xcworkspace工程"><span class="nav-number">1.5.</span> <span class="nav-text">打开xcworkspace工程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加桥接文件DWeibo-Bridge"><span class="nav-number">1.6.</span> <span class="nav-text">添加桥接文件DWeibo-Bridge</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-04-28-15-28-34"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-04-28 15:28:34</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#微博API"><span class="nav-number">1.</span> <span class="nav-text">微博API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权"><span class="nav-number">2.</span> <span class="nav-text">授权</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建OAuthViewController"><span class="nav-number">2.1.</span> <span class="nav-text">创建OAuthViewController</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UserAccount存储用户信息"><span class="nav-number">2.2.</span> <span class="nav-text">UserAccount存储用户信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#归档用户信息"><span class="nav-number">2.3.</span> <span class="nav-text">归档用户信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取用户信息"><span class="nav-number">2.4.</span> <span class="nav-text">获取用户信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-08-15-07-39"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-08 15:07:39</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新特性"><span class="nav-number">1.</span> <span class="nav-text">新特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建NewFeatureViewController"><span class="nav-number">1.1.</span> <span class="nav-text">创建NewFeatureViewController</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建NewFeatureCell"><span class="nav-number">1.2.</span> <span class="nav-text">创建NewFeatureCell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建NewFeatureLayout"><span class="nav-number">1.3.</span> <span class="nav-text">创建NewFeatureLayout</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完善-amp-添加按钮"><span class="nav-number">2.</span> <span class="nav-text">完善&添加按钮</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-08-16-00-03"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-08 16:00:03</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加欢迎界面"><span class="nav-number">1.</span> <span class="nav-text">添加欢迎界面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加子控件"><span class="nav-number">1.1.</span> <span class="nav-text">添加子控件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加显示动画"><span class="nav-number">1.2.</span> <span class="nav-text">添加显示动画</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化信息"><span class="nav-number">1.3.</span> <span class="nav-text">初始化信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跟控制器切换"><span class="nav-number">2.</span> <span class="nav-text">跟控制器切换</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#判断新版本"><span class="nav-number">2.1.</span> <span class="nav-text">判断新版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示的默认控制器"><span class="nav-number">2.2.</span> <span class="nav-text">显示的默认控制器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义通知"><span class="nav-number">2.3.</span> <span class="nav-text">定义通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注销通知"><span class="nav-number">2.4.</span> <span class="nav-text">注销通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送通知"><span class="nav-number">2.5.</span> <span class="nav-text">发送通知</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-09-10-13-03"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-09 10:13:03</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取微博数据"><span class="nav-number">1.</span> <span class="nav-text">获取微博数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建Status类"><span class="nav-number">1.1.</span> <span class="nav-text">创建Status类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HomeTableViewController填充数据"><span class="nav-number">1.2.</span> <span class="nav-text">HomeTableViewController填充数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取用户数据"><span class="nav-number">2.</span> <span class="nav-text">获取用户数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建User"><span class="nav-number">2.1.</span> <span class="nav-text">创建User</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Status监听user的数据"><span class="nav-number">2.2.</span> <span class="nav-text">Status监听user的数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StatusTableViewCell"><span class="nav-number">3.</span> <span class="nav-text">StatusTableViewCell</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加子控件-1"><span class="nav-number">3.1.</span> <span class="nav-text">添加子控件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#监听微博属性"><span class="nav-number">3.2.</span> <span class="nav-text">监听微博属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#替换UITableViewCell"><span class="nav-number">3.3.</span> <span class="nav-text">替换UITableViewCell</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#封装UILabel和UIButton"><span class="nav-number">4.</span> <span class="nav-text">封装UILabel和UIButton</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展UILabel-UILabel-Category-swift"><span class="nav-number">4.1.</span> <span class="nav-text">扩展UILabel, UILabel+Category.swift</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展UIButton-UIButton-Category-swift"><span class="nav-number">4.2.</span> <span class="nav-text">扩展UIButton, UIButton+Category.swift</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StatusTableViewCell-swift重构"><span class="nav-number">4.3.</span> <span class="nav-text">StatusTableViewCell.swift重构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-10-10-11-16"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-10 10:11:16</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据处理"><span class="nav-number">1.</span> <span class="nav-text">数据处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#认证图标"><span class="nav-number">1.1.</span> <span class="nav-text">认证图标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#会员图标"><span class="nav-number">1.2.</span> <span class="nav-text">会员图标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#来源处理"><span class="nav-number">1.3.</span> <span class="nav-text">来源处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建时间处理"><span class="nav-number">1.4.</span> <span class="nav-text">创建时间处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存配图"><span class="nav-number">1.5.</span> <span class="nav-text">缓存配图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#计算配图大小"><span class="nav-number">1.6.</span> <span class="nav-text">计算配图大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示配图"><span class="nav-number">1.7.</span> <span class="nav-text">显示配图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#懒加载配图控件"><span class="nav-number">1.7.1.</span> <span class="nav-text">懒加载配图控件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#初始化配图控件"><span class="nav-number">1.7.2.</span> <span class="nav-text">初始化配图控件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#扩展StatusTableViewCell实现数据源"><span class="nav-number">1.7.3.</span> <span class="nav-text">扩展StatusTableViewCell实现数据源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义配图cell"><span class="nav-number">1.7.4.</span> <span class="nav-text">自定义配图cell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#完善计算配图方法，返回总试图的尺寸-amp-每个子视图的尺寸"><span class="nav-number">1.7.5.</span> <span class="nav-text">完善计算配图方法，返回总试图的尺寸&每个子视图的尺寸</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#设置配图尺寸"><span class="nav-number">1.7.6.</span> <span class="nav-text">设置配图尺寸</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存行高"><span class="nav-number">1.8.</span> <span class="nav-text">缓存行高</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重构StatusTableViewCell-swift"><span class="nav-number">2.</span> <span class="nav-text">重构StatusTableViewCell.swift</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatusCellTopView"><span class="nav-number">2.1.</span> <span class="nav-text">创建StatusCellTopView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatusCellBottomView"><span class="nav-number">2.2.</span> <span class="nav-text">创建StatusCellBottomView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatusCellPictureView"><span class="nav-number">2.3.</span> <span class="nav-text">创建StatusCellPictureView</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-11-09-51-39"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-11 09:51:39</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#转发微博"><span class="nav-number">1.</span> <span class="nav-text">转发微博</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatusNormalTableViewCell显示普通状态下的微博"><span class="nav-number">1.1.</span> <span class="nav-text">创建StatusNormalTableViewCell显示普通状态下的微博</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Status-swift"><span class="nav-number">1.2.</span> <span class="nav-text">Status.swift</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建StatusForwardTableViewCell显示转发状态下的微博"><span class="nav-number">1.3.</span> <span class="nav-text">创建StatusForwardTableViewCell显示转发状态下的微博</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建切换不同cell的标记"><span class="nav-number">1.4.</span> <span class="nav-text">创建切换不同cell的标记</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完善StatusCellPictureView-swift"><span class="nav-number">1.5.</span> <span class="nav-text">完善StatusCellPictureView.swift</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完善HomeTableViewController-swift"><span class="nav-number">1.6.</span> <span class="nav-text">完善HomeTableViewController.swift</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下拉刷新"><span class="nav-number">2.</span> <span class="nav-text">下拉刷新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加刷新控件"><span class="nav-number">2.1.</span> <span class="nav-text">添加刷新控件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优化"><span class="nav-number">2.2.</span> <span class="nav-text">优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-16-15-09-32"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-16 15:09:32</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改BaseViewController继承UIViewController"><span class="nav-number">1.</span> <span class="nav-text">修改BaseViewController继承UIViewController</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示刷新提醒"><span class="nav-number">2.</span> <span class="nav-text">显示刷新提醒</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建显示文本"><span class="nav-number">2.1.</span> <span class="nav-text">创建显示文本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#展示文本方法"><span class="nav-number">2.2.</span> <span class="nav-text">展示文本方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调用展示方法"><span class="nav-number">2.3.</span> <span class="nav-text">调用展示方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览大图"><span class="nav-number">3.</span> <span class="nav-text">浏览大图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取大图"><span class="nav-number">3.1.</span> <span class="nav-text">获取大图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取当前点击图片"><span class="nav-number">3.2.</span> <span class="nav-text">获取当前点击图片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建浏览器"><span class="nav-number">3.3.</span> <span class="nav-text">创建浏览器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加通知"><span class="nav-number">3.4.</span> <span class="nav-text">添加通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示大图"><span class="nav-number">3.5.</span> <span class="nav-text">显示大图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建PhotoBrowserCell"><span class="nav-number">3.5.1.</span> <span class="nav-text">创建PhotoBrowserCell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#完善"><span class="nav-number">3.5.2.</span> <span class="nav-text">完善</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#点击图片指定位置展示"><span class="nav-number">3.5.3.</span> <span class="nav-text">点击图片指定位置展示</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-17-16-13-21"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-17 16:13:21</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#长短图计算"><span class="nav-number">1.</span> <span class="nav-text">长短图计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缩放图片"><span class="nav-number">2.</span> <span class="nav-text">缩放图片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示菊花"><span class="nav-number">3.</span> <span class="nav-text">显示菊花</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示gif图标"><span class="nav-number">4.</span> <span class="nav-text">显示gif图标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭浏览器"><span class="nav-number">5.</span> <span class="nav-text">关闭浏览器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-18-10-19-39"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-18 10:19:39</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加表情数据包"><span class="nav-number">1.</span> <span class="nav-text">添加表情数据包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表情控制器"><span class="nav-number">2.</span> <span class="nav-text">表情控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#布局CollectionView界面"><span class="nav-number">3.</span> <span class="nav-text">布局CollectionView界面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置layout"><span class="nav-number">3.1.</span> <span class="nav-text">设置layout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建EmoticonCell"><span class="nav-number">3.2.</span> <span class="nav-text">创建EmoticonCell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置collectionView"><span class="nav-number">3.3.</span> <span class="nav-text">设置collectionView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现数据源方法"><span class="nav-number">3.4.</span> <span class="nav-text">实现数据源方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载数据模型准备"><span class="nav-number">4.</span> <span class="nav-text">加载数据模型准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#emoji字符扫描及转换原理"><span class="nav-number">5.</span> <span class="nav-text">emoji字符扫描及转换原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示图片和emoji"><span class="nav-number">6.</span> <span class="nav-text">显示图片和emoji</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完善模型"><span class="nav-number">7.</span> <span class="nav-text">完善模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整表情分组"><span class="nav-number">8.</span> <span class="nav-text">调整表情分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入emoji表情"><span class="nav-number">9.</span> <span class="nav-text">插入emoji表情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入图片表情"><span class="nav-number">10.</span> <span class="nav-text">插入图片表情</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-19-10-48-31"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-19 10:48:31</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的图文混排-测试"><span class="nav-number">1.</span> <span class="nav-text">简单的图文混排(测试)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取发送文本"><span class="nav-number">2.</span> <span class="nav-text">获取发送文本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重构"><span class="nav-number">3.</span> <span class="nav-text">重构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除按钮处理"><span class="nav-number">4.</span> <span class="nav-text">删除按钮处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理最近表情"><span class="nav-number">5.</span> <span class="nav-text">处理最近表情</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-19-16-00-31"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-19 16:00:31</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#布局发送微博界面"><span class="nav-number">1.</span> <span class="nav-text">布局发送微博界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送微博"><span class="nav-number">2.</span> <span class="nav-text">发送微博</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#继承表情键盘"><span class="nav-number">3.</span> <span class="nav-text">继承表情键盘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-21-10-04-56"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-21 10:04:56</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建浏览器-amp-布局"><span class="nav-number">1.</span> <span class="nav-text">创建浏览器&布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示图片浏览器"><span class="nav-number">2.</span> <span class="nav-text">显示图片浏览器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建代理"><span class="nav-number">2.1.</span> <span class="nav-text">创建代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代理属性"><span class="nav-number">2.2.</span> <span class="nav-text">代理属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现PhotoSelectorCellDelegate"><span class="nav-number">2.3.</span> <span class="nav-text">实现PhotoSelectorCellDelegate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示照片"><span class="nav-number">3.</span> <span class="nav-text">显示照片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存问题处理"><span class="nav-number">4.</span> <span class="nav-text">内存问题处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#UIImageJPEGRepresentation"><span class="nav-number">4.1.</span> <span class="nav-text">UIImageJPEGRepresentation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写入到本地"><span class="nav-number">4.2.</span> <span class="nav-text">写入到本地</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内存警告"><span class="nav-number">4.3.</span> <span class="nav-text">内存警告</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缩放图片-1"><span class="nav-number">4.4.</span> <span class="nav-text">缩放图片</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-21-15-25-27"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-21 15:25:27</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#正则表达式"><span class="nav-number">1.</span> <span class="nav-text">正则表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSRegularExpression"><span class="nav-number">1.1.</span> <span class="nav-text">NSRegularExpression</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方法介绍"><span class="nav-number">1.2.</span> <span class="nav-text">方法介绍</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习匹配微博正文"><span class="nav-number">2.</span> <span class="nav-text">练习匹配微博正文</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配URL"><span class="nav-number">2.1.</span> <span class="nav-text">匹配URL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配表情、用户名、话题、URL"><span class="nav-number">2.2.</span> <span class="nav-text">匹配表情、用户名、话题、URL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#效果"><span class="nav-number">2.3.</span> <span class="nav-text">效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成表情文字"><span class="nav-number">3.</span> <span class="nav-text">生成表情文字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成表情文字重构"><span class="nav-number">4.</span> <span class="nav-text">生成表情文字重构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-22-14-42-22"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-22 14:42:22</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TextKit基本使用"><span class="nav-number">1.</span> <span class="nav-text">TextKit基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建DDLabel继承与UILabel"><span class="nav-number">1.1.</span> <span class="nav-text">创建DDLabel继承与UILabel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#声明三个属性"><span class="nav-number">1.2.</span> <span class="nav-text">声明三个属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写初始化方法"><span class="nav-number">1.3.</span> <span class="nav-text">重写初始化方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写布局方法"><span class="nav-number">1.4.</span> <span class="nav-text">重写布局方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写绘制方法"><span class="nav-number">1.5.</span> <span class="nav-text">重写绘制方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重写text属性"><span class="nav-number">1.6.</span> <span class="nav-text">重写text属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试"><span class="nav-number">1.7.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#键盘变化处理"><span class="nav-number">2.</span> <span class="nav-text">键盘变化处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加键盘通知"><span class="nav-number">2.1.</span> <span class="nav-text">添加键盘通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注销通知-1"><span class="nav-number">2.2.</span> <span class="nav-text">注销通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keyboardChange方法"><span class="nav-number">2.3.</span> <span class="nav-text">keyboardChange方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集成图片选择器"><span class="nav-number">3.</span> <span class="nav-text">集成图片选择器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#懒加载"><span class="nav-number">3.1.</span> <span class="nav-text">懒加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化"><span class="nav-number">3.2.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#工具条事件"><span class="nav-number">3.3.</span> <span class="nav-text">工具条事件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送图片微博"><span class="nav-number">4.</span> <span class="nav-text">发送图片微博</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送图片微博-1"><span class="nav-number">5.</span> <span class="nav-text">发送图片微博</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重构发送图片微博"><span class="nav-number">6.</span> <span class="nav-text">重构发送图片微博</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布页面字数提醒"><span class="nav-number">7.</span> <span class="nav-text">发布页面字数提醒</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示首页表情"><span class="nav-number">8.</span> <span class="nav-text">显示首页表情</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新时间：2018-05-23-10-28-27"><span class="nav-number"></span> <span class="nav-text">更新时间：2018-05-23 10:28:27</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQLite基本使用"><span class="nav-number">1.</span> <span class="nav-text">SQLite基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建TestPerson类测试"><span class="nav-number">2.</span> <span class="nav-text">创建TestPerson类测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#压力测试"><span class="nav-number">3.</span> <span class="nav-text">压力测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用线程"><span class="nav-number">4.</span> <span class="nav-text">使用线程</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DaiSuke</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"daisukecn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  






  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("EHtYvSIfNxQXWTd66LKTOamk-gzGzoHsz", "QmOk07bceNRvEUFI2Wxs2R0n");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

    
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    
</body>
</html>
